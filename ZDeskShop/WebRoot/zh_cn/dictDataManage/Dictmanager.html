<!DOCTYPE  HTML>
<html lang="en">
	<head>
		<title>字典项维护</title>

		<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
		<meta http-equiv="description" content="this is my page">
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<link rel="stylesheet" href="../../css/bootstrap.min.css"
			type="text/css"></link>
		<link rel="stylesheet" href="../../css/bootstrap.css" type="text/css"></link>
		<link rel="stylesheet"
			href="../../js/dataTables/css/jquery.dataTables.css" type="text/css"></link>
		<!-- bootstrap 与 datatable结合 -->
		<link rel="stylesheet" href="../../js/dataTables/css/DT_bootstrap.css"
			type="text/css"></link>
		<!-- 工具 -->
		<link rel="stylesheet"
			href="../../js/dataTables/css/dataTables.tableTools.min.css"
			type="text/css"></link>
		<!-- 动态列CSS -->
		<link rel="stylesheet" href="../../js/dataTables/css/font-awesome.css"></link>
		<link rel="stylesheet"
			href="../../js/dataTables/css/dataTables.colVis.min.css"
			type="text/css"></link>
		<script type="text/javascript" src="../../js/jquery.js"></script>
		<script type="text/javascript" src="../../js/bootstrap.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/jquery.dataTables.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.colReorder.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.colVis.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.tableTools.min.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/DT_bootstrap.js"></script>
		<script type="text/javascript" src="../../js/common_utils.js"></script>
		<script type="text/javascript" src="../../js/appCommonUtil.js"></script>
		<script type="text/javascript" src="../../js/golbal_params.js"></script>
		<script type="text/javascript" src="../../js/common_validation.js"></script>

		<style type="text/css" class="init">
#dictbody td.red {
	font-weight: bold;
	color: red;
}

#dictbody td {
	text-align: center;
}

/* fa-square-o */
#dictbody tr td:first-child:before {
	content: "\f096";
	font-family: FontAwesome;
}

#dictbody tr.active td:first-child:before {
	content: "\f046"; /* fa-check-square-o */
}
</style>
		<script type="text/javascript">
		
var ww ;
var CHECK_indexCode=false ;
var CHECK_code=false ;
var CHECK_name=false ;
//给下拉框赋值。
function initDicIndexSelect(selectid){
	var data = getDictIndexData() ;
	$("#"+""+selectid+"").empty();
	$("#"+""+selectid+"").append("<option value=''>"+"---------------"+"</option>"); 
	for(var i in data){
        $("#"+""+selectid+"").append("<option value='"+data[i].indexCode+"'>"+data[i].indexName+"</option>"); 
    }
}
function initDicParentIndexSelect(extradata,selectid){
	if(extradata!=''){
		var data = getOtherAllDictValue(extradata) ;
	}else{
		var data = getAllDictValue() ;
	}
	$("#"+""+selectid+"").empty();
	$("#"+""+selectid+"").append("<option value=''>"+"---------------"+"</option>"); 
	for(var i in data){
        $("#"+""+selectid+"").append("<option value='"+data[i].code+"'>"+data[i].name+"</option>"); 
    }
}
function getOtherAllDictValue(extradata){
	var dictdata = ''
	if(GOLBAL_PARAM["dictdata"].data==''||GOLBAL_PARAM["dictdata"].data==null||GOLBAL_PARAM["dictdata"].data==undefined){
		reloadDicData();
		dictdata= GOLBAL_PARAM["dictdata"].data ;
	}else{
		dictdata= GOLBAL_PARAM["dictdata"].data ;
	}
	var alldictdata = {} ;
	var list = new Array();
	for(var key in dictdata){
		if(key!=extradata){
			alldictdata = dictdata[key] ;
			for(var i in alldictdata){
				list.push(alldictdata[i]) ;
			}
		}
	}
	return list ;
}
$(document).ready(function(){
//更新后端缓存,重新加载缓存数据
//  字典索引下拉
	initDicIndexSelect('indexCode') ;
//根据code取value	
//	getDictValueForCode('code') ;
	var data=doSearch(); 
	$("#addBt").hide() ;
	$("#upBt").hide() ;
//	reloadDicData() ;
	$("#addarea").val('') ;
	$("#addLanguageType").val('') ;
	$('#dictbody').dataTable({
		'bPaginate':true,//分页器
		'bLengthChange': false,
		'bStateSave':true, //保留状态
		'bSort':true,//按列排序
		'bInfo':true,//页脚信息
		'bAutoWidth':false, //自动宽度
//		'sScrollX':'1600',//垂直滚动条,滚动区域
		'sScrollY':'400px',
		'sPaginationType': 'bootstrap',//分页样式
		'dom': 'TRlrtip',
		'data':data,
		'columns': [
			{"title":"<input type='checkbox' id='selectall' onclick='toggleChecks(this);' ></input>",data: null,width:'30px', defaultContent: '', orderable: false},
			{"title":"数据代码" ,data: 'code'},
			{"title":"数据名称" ,data: 'name'},
			{"title":"索引代码" ,data: 'indexCode'},
			{"title":"索引名称" ,data: 'indexName'},
			{"title":"级联数据代码" ,data: 'parentIndexCode'},
			{"title":"级联数据名称" ,data: 'parentIndexName'}
		],
		"oLanguage": {
  			"sSearch": "搜索:",
  			"sLengthMenu": "每页显示 _MENU_ 条记录",
 			"sZeroRecords": "Nothing found - 没有记录",
  			"sInfo": "显示第  _START_ 条到第  _END_ 条记录,一共  _TOTAL_ 条记录",
  			"sInfoEmpty": "显示0条记录",
  			"oPaginate": {
  				"sFirst": "首页",
   				"sPrevious": " 上一页 ",
   				"sNext":     " 下一页 ",
   				"sLast": "尾页"
   			}
  		}, tableTools: {
          	//single 单选 multi 多选  os 可以按ctrl 选择
           	// sRowSelect:'multi',
           	//回调 单选
           	fnRowSelected: function ( nodes ) {
            	var index=nodes[0]._DT_RowIndex;	
				var data = table.row(index).data();
               	OpenForm(data);
               	//alert(JSON.stringify(data));
            },
            sRowSelect:'multi',
            //sRowSelector:'td:first-child',
            aButtons:     [ /*{
            "sExtends":    "select_all",
            "sButtonText": "选择全部",
            "target":      "#select"
              } , 'select_none' */]
        	}
	});
	var table= $('#dictbody').DataTable();
	table.page.len('10').draw();
	$('#dictbody tbody').on( 'click', 'button', function (obj) {
		var data = table.row( $(this).parents('tr') ).data();
	});
	var colvis = new $.fn.dataTable.ColVis(table,{ buttonText: '自定义显示列',exclude: [ 0 ,-1] });
    $( colvis.button()).insertBefore('#cols');
});
function openDicIndexWin(){
	var url ="/"+window.top.PRJ_PATH+"/zh_cn/dictDataManage/DictIndexManager.html?";
	closeDialog=dicIndexDialog(url);
}
function dicIndexDialog(url) {
	var orgDig = dialog({
				title : '字典项索引',
				content : '<iframe src=' + url
						+ ' style="border: 0; width: 100%; height: 100%"  frameborder="0"/>',
				width : '600',
				height : '700'
			});
	orgDig.show();
	return orgDig;
}
function closeDicIndexWin(){
	ww.close() ;
}
function doSearch(){
	var url = "/" + "ZDesk" + "/" + "*/Dicmaintenance" + "/" + "select.action";
	var params = {} ;
	var data1={} ;
	ajaxFunction(url,params,false,function(data){
		if(data.success){
			data1=data.data ;   
		}
	});
    return data1;
}
//每页显示条数
function setPageNum(obj){
	var table=$('#dictbody').DataTable();
	table.page.len(obj.value).draw();
 	//alert(obj.value);
}
function toggleChecks(obj){
	var table=$('#dictbody').DataTable();
	var tableTools = new $.fn.dataTable.TableTools(table);
	var ischeck=$("#selectall").is(':checked');
	if(ischeck){
		tableTools.fnSelectAll();
	}else{
		tableTools.fnSelectNone();
    }
}
function refresh(){
	reloadDicData();
	var table=$('#dictbody').DataTable();
	table.search("").draw();
	table.clear().draw();
	//重新加载数据
	var data=doSearch(); 
	table.rows.add(data).draw(true);
}
function tableSearch(){
	var url = "/" + "ZDesk" + "/" + "*/Dicmaintenance" + "/" + "select.action";
	var params = {} ;
	params = zkm_getHtmlFormJsons('searchForm') ;
	var data1={} ;
	ajaxFunction(url,params,false,function(data){
		if(data.success){
			data1=data.data ;	
			var table=$('#dictbody').DataTable();
			table.clear().draw();
			table.rows.add(data1).draw();
			reset("addform") ;
			zinglabs.i18n.alert('addOk');
		}else{
			$.alert("提示","error") ;
		}
	});
}
function OpenForm(data){
	reset('addform');
	$('#addform').show();
	$('#addbtfrom').show();
	$('#addBt').hide();
	$('#upBt').show();
	var cfs=$("#addform input[name]");
	for(var i=0;i<cfs.length;i++){
		var e=cfs[i];	
	    $("#"+e.name).val(data[e.name]); 
	}
	initDicParentIndexSelect(data.indexCode,'parentIndexCode') ;
	$("#parentIndexCode").val(data.parentIndexCode) ;
	$("#indexCode").val(data.indexCode) ;
	$("#addparentIndexcode").val(data.parentIndexCode) ;
	$("#addIndexCode").val(data.indexCode) ;
	hideTooltip('NameDiv') ;
	hideTooltip('codeDiv') ;
	hideTooltip('indexNameDiv') ;
	CHECK_indexCode=true ;
	CHECK_code=true ;
	CHECK_name=true ;
} 

function openAddForm(){
	reset('addform');
	$('#addbtfrom').hide();
	$('#addform').show();
//	addBt upBt
	$('#upBt').hide();
	$('#addBt').show();
}

function tableAdd(){
	var url = "/" + "ZDesk" + "/" + "*/Dicmaintenance" + "/" + "add.action";
	params = zkm_getHtmlFormJsons('addform') ;
	if(!(CHECK_code&&CHECK_name&&CHECK_indexCode)){zinglabs.i18n.alert('notEnough');  return ;}
	var rdata=[];
   	ajaxFunction(url,params,false,function(data){
   		if(data.success){	
			reset("addform") ;
   			refresh();
   			$('#addbtfrom').show();
   			zinglabs.i18n.alert('system_saveSuccess');
		}else{
			if(data.mgs!=''&&data.mgs!=undefined){
				var pat = {"${0}":"数据代码"};
				alert(zinglabs.i18n.getText(data.mgs,pat));
			}else{
				zinglabs.i18n.alert('system_saveFailed');
			}
		}
   	});
}
function tableUpdate(){
	var url = "/" + "ZDesk" + "/" + "*/Dicmaintenance" + "/" + "update.action";
	params = zkm_getHtmlFormJsons('addform') ;
	if(params.parentIndexCode ==''){params.parentIndexName='' }
	if(params.indexCode ==''){params.indexName=''}
	if(!(CHECK_code&&CHECK_name&&CHECK_indexCode)){zinglabs.i18n.alert('notEnough');  return ;}
	var rdata={};
   	ajaxFunction(url,params,false,function(data){
   		if(data.success){	
			reset("addform") ;
   			refresh();
   			closeForm();
   			zinglabs.i18n.alert('system_updateSuccess');
		}else{
			if(data.mgs!=''&&data.mgs!=undefined){
				var pat = {"${0}":"数据代码"};
				alert(zinglabs.i18n.getText(data.mgs,pat));
			}else{
				zinglabs.i18n.alert('system_updateFailed');
			}
		}
   	});
}
function deleteCell(cell){
	var params = {} ;
	var url = "/" + "ZDesk" + "/" + "*/Dicmaintenance" + "/" + "delete.action";
	var ids='';
	for(var i in cell){
		ids = ids + cell[i].id+',';
	}
	if(ids!=''){
 		params.id = ids ;
  		ajaxFunction(url,params,false,function(data){
  			if(data.success){	
				reset("addform") ;
				zinglabs.i18n.alert('system_deleteSuccess');
			}else{
			}
  		});
  	}else{
  		zinglabs.i18n.alert('system_deleteFailed');
  	}
}
function fnGetSelected(){
    //注意DataTable大写 或者 $('#dictbody').dataTable().api();
	var table=$('#dictbody').DataTable();
 	//var data =table.column().data();
    //获取选中行 通过dataTable查找
    var cell=table.rows(".active").data();
    //通过table TableTools插件 查找
    var tt = new $.fn.dataTable.TableTools(table);
    var selectData=tt.fnGetSelectedData();
    deleteCell(selectData) ;
    refresh();
}
function reset(form){
	var cfs=$("#"+form+" input[name],textarea[name]");
	for(var i=0;i<cfs.length;i++){
		var e=cfs[i];	
	    $(e).val(''); 
	}
	$("#"+form+"")[0].reset();
	if(addform=='addform'){
		CHECK_indexCode=false ;
		CHECK_code=false ;
		CHECK_name=false ;
	}
}
function closeForm(){
	reset('addform');
	$('#addform').hide();
	$('#upBt').hide();
	$('#addBt').hide();
	$('#addbtfrom').show();
}
function parentIndexcodecheckoption(data){
	if(data.value==$("#indexName").val()){
		return ;
	}
	
}
function indexcodecheckoption(data){
	initDicParentIndexSelect(data.value,'parentIndexCode') ;
//验证
	if(data.value==''||data.value==null||data.value==undefined){
		CHECK_indexCode =false ;
		showTooltip('indexNameDiv','请选择其中一项！') ;
	}else{
		hideTooltip('indexNameDiv');
		CHECK_indexCode =true ;
	}
}
function parentIndexcodeChange(data){
	$("#parentIndexName").val(data.text) ;
	$("#addparentIndexcode").val(data.value) ;
}
function indexcodeChange(data){
	$("#addIndexCode").val(data.value) ;
	$("#indexName").val(data.text) ;
}
//验证
function checkCode(){
	if(!(V_CodeAndNumberCheck($("#code").val()))||$("#code").val()==''){
		CHECK_code =false ;
		showTooltip('codeDiv','填写不正确！') ;
	}else{
		CHECK_code =true ;
		hideTooltip('codeDiv');
	}
}

function checkName(){
	if($("#name").val()==''||$("#name").val()==null||$("#name").val()==undefined){
		CHECK_name =false ;
		showTooltip('NameDiv','填写不正确！') ;
	}else{
		CHECK_name =true ;
		hideTooltip('NameDiv');
	}
}

//验证未通过样式
function showTooltip(id,title){
	$("#"+id).attr('title',title) ;
	$("#"+id).tooltip('show') ;
	$("#"+id).addClass('control-group error') ;
}
//还原样式
function hideTooltip(id){
	$("#"+id).tooltip('destroy') ;
	$("#"+id).removeClass('error') ;
}
function testGet(){
	var comboName= $("#test").val();
	var value = getDictListfoIndexData(comboName);
	value=value;
	alert("同类型索引数据数量为:"+value.length);
}
		</script>
	</head>
	<body style="overflow-y: scroll; overflow-x: scroll;width: 1350px">
		<div class="widget-box collapsible" style="width:1350px;">
			<div class="widget-title" style="height: 40px;">
				<span class="icon"> <i class="icon-search"></i> </span>
				<h5>
					字典数据项搜索
				</h5>
				<div id="cols"></div>
			</div>
			<div class="widget-content"
				style="border-color: rgb(205, 205, 205); border-width: 1px;padding:0">
				<form class="form-horizontal" id="searchForm">
					<table style="width: 1300px; text-aline: left;">
						<tr>
							<td>
								<div id="ii1" class="control-group ">
									<label class="control-label">
										数据名称
									</label>
									<div class="controls">
										<input type="text" class="input-medium" id="sname" name="name" />
									</div>
								</div>
							</td>
							<td>
								<div class="control-group ">
									<label class="control-label">
										索引名称
									</label>
									<div class="controls">
										<input type="text" class="input-medium" id="sindexName"
											name="indexName" />
									</div>
								</div>
							</td>
							<td>
								<div class="control-group ">
									<label class="control-label">
										级联索引名称
									</label>
									<div class="controls">
										<input type="text" class="input-medium" id="sparentComboName"
											name="parentComboName" />
									</div>
								</div>
							</td>
							<td></td>
						</tr>
						<tr>
							<td>
								<div class="control-group ">
									<label class="control-label">
										数据代码
									</label>
									<div class="controls">
										<input type="text" class="input-medium" id="scode" name="code" />
									</div>
								</div>
							</td>
							<td>
								<div class="control-group ">
									<label class="control-label">
										索引代码
									</label>
									<div class="controls">
										<input type="text" class="input-medium" id="sindexCode"
											name="indexCode" />
									</div>
								</div>
							</td>
							<td>
								<div class="control-group ">
									<label class="control-label">
										级联索引代码
									</label>
									<div class="controls">
										<input type="text" class="input-medium" id="sparentIndexCode"
											name="parentIndexCode" />
									</div>
								</div>
							</td>
							<td >
								<button role="button" class="btn" onclick="tableSearch()"data-toggle="modal" style="margin-bottom: 20px;margin-right: 10px;">
									<i class="icon-search"></i>查 询
								</button>
								<button type="button" class="btn" onclick="reset('searchForm')" style="margin-bottom: 20px;">
									<i class="icon-repeat"></i> 重 置
								</button>
							</td>
						</tr>
					</table>
				</form>
			</div>
		</div>
		<div style="background-color:rgb(239, 239, 239);rgb(205,205,205);width:1350px;border:solid;border-right-color:rgb(205,205,205);border-width:1px;border-left-color:rgb(205,205,205);border-left-width:1px;border-right-width:1px;border-top-width:0px">
		<div style="width:1352px;margin-top: -30px;background-color:rgb(239, 239, 239);background-color: #fff;">
		<table  class="table table-striped table-bordered "
			id="dictbody" cellspacing="0">
		</table>
		</div>
		</div>
		<div class="widget-box collapsible" style="width:1350px;">
			<div class="widget-title">
				<span class="icon"> <i class="icon-cog"></i> </span>
				<div style="margin-left: 45px; line-height: 35px;">
					<button id="addbtfrom" role="button" class="btn"
						data-toggle="modal" onclick="openAddForm();">
						<i class="icon-plus"></i>添 加
					</button>
					<button id="addBt" type="button" class="btn " style="display: none"
						onclick="tableAdd()">
						<i class="icon-ok"></i> 确认添加
					</button>
					<button id="upBt" type="button" class="btn "
						onclick="tableUpdate()">
						<i class="icon-ok"></i> 确认修改
					</button>
					<button type="button" class="btn" onclick="fnGetSelected()">
						<i class="icon-remove"></i> 删 除
					</button>
					<button type="button" class="btn" onclick="closeForm();">
						<i class="icon-chevron-up"></i> 收 起
					</button>
					<button type="button" class="btn" onclick="reset('addform')">
						<i class="icon-repeat"></i> 重 置
					</button>
					<button type="button" class="btn" onclick="openDicIndexWin();">
						<i class="icon-repeat"></i> 新增索引
					</button>
					每页显示条数：
					<span style="line-height: 30px"> <select name="pageSize"
							id="pageSize" style="width: 70px; margin-bottom: 0px;"
							onchange="setPageNum(this)">
							<option selected="selected" value="10">
								10
							</option>
							<option value="30">
								30
							</option>
							<option value="50">
								50
							</option>
							<option value="100">
								100
							</option>
							<option value="200">
								200
							</option>
							<option value="500">
								500
							</option>
							<option value="1000">
								1000
							</option>
							<option value="-1">
								全部
							</option>
						</select> </span>
					<button type="button" class="btn" onclick="reloadDicData();">
						<i class="icon-repeat"></i>重新加载缓存
					</button>
					输入一个索引码
					<input id="test" name="test" style="width: 100px" />
					<button type="button" class="btn" onclick="testGet();">
						<i class="icon-repeat"></i>测 试
					</button>
				</div>
			</div>
		</div>
		<form class="form-horizontal" id="addform" style="display: none">
			<input id="updateid" " name="id" type="hidden">
			<input type="hidden" id="id" name="id">
			<div class="widget-box collapsible" style="border-bottom:solid;border-bottom-width:1px;border-bottom-color:rgb(205,205,205)">
				<table style="width: 1000px; text-aline: left">
					<tr>
						<td>
							<div id="NameDiv" class="control-group ">
								<label class="control-label">
									数据名称
									<span style="color: red;">*</span>
								</label>
								<div class="controls">
									<input type="text" class="input-medium" id="name" name="name"
										ONBLUR="checkName()" placeholder="请填入数据名称...">
								</div>
							</div>
						</td>
						<td>
							<div id="indexNameDiv" class="control-group ">
								<label class="control-label">
									索引名称
									<span style="color: red;">*</span>
								</label>
								<div class="controls">
									<select id="indexCode" name="indexCode" style="width: 166px"
										ONBLUR="indexcodecheckoption(this.options[this.options.selectedIndex])"
										onchange="indexcodeChange(this.options[this.options.selectedIndex])"></select>

									<input type="hidden" class="input-medium" id="indexName"
										name="indexName">
								</div>
							</div>
						</td>
						<td>
							<div id="parentIndexNameDiv" class="control-group ">
								<label class="control-label">
									级联索引名称
								</label>
								<div class="controls">
									<select id="parentIndexCode" name="parentIndexCode"
										style="width: 166px"
										ONBLUR="parentIndexcodecheckoption(this.options[this.options.selectedIndex])"
										onchange="parentIndexcodeChange(this.options[this.options.selectedIndex])"></select>
									<input type="hidden" id="parentIndexName"
										name="parentIndexName" />
								</div>
							</div>
						</td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td>
							<div id="codeDiv" class="control-group ">
								<label class="control-label">
									数据代码
									<span style="color: red;">*</span>
								</label>
								<div class="controls">
									<input type="text" class="input-medium" id="code" name="code"
										ONBLUR="checkCode()" placeholder="请填入字母或数字...">
								</div>
							</div>
						</td>
						<td>
							<div class="control-group ">
								<label class="control-label">
									索引代码
								</label>
								<div class="controls">
									<input type="text" readonly class="input-medium"
										id="addIndexCode">
								</div>
							</div>
						</td>
						<td>
							<div class="control-group ">
								<label class="control-label">
									级联索引代码
								</label>
								<div class="controls">
									<input type="text" readonly class="input-medium"
										id="addparentIndexcode">
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>
		</form>
	</body>
</html>
