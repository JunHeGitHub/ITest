<!DOCTYPE  HTML>
<html lang="en">
	<head>
		<title>经办待办</title>

		<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
		<meta http-equiv="description" content="this is my page">
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
		<link rel="stylesheet" href="../../css/bootstrap.min.css"
			type="text/css"></link>
		<link rel="stylesheet" href="../../css/bootstrap-responsive.min.css"
			type="text/css"></link>
		<link rel="stylesheet"
			href="../../js/dataTables/css/jquery.dataTables.css" type="text/css"></link>
		<!-- bootstrap 与 datatable结合 -->
		<link rel="stylesheet" href="../../js/dataTables/css/DT_bootstrap.css"
			type="text/css"></link>
		<!-- 工具 -->
		<link rel="stylesheet"
			href="../../js/dataTables/css/dataTables.tableTools.min.css"
			type="text/css"></link>
		<!-- 动态列CSS -->
		<link rel="stylesheet" href="../../js/dataTables/css/font-awesome.css"></link>
		<link rel="stylesheet"
			href="../../js/dataTables/css/dataTables.colVis.min.css"
			type="text/css"></link>
		<script type="text/javascript" src="../../js/jquery.js"></script>
		<script type="text/javascript" src="../../js/bootstrap.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/jquery.dataTables.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.colReorder.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.colVis.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.tableTools.min.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/DT_bootstrap.js"></script>
		<script type="text/javascript" src="../../js/common_utils.js"></script>
		<script type="text/javascript"
			src="../../js/appCommonCurdUtils_new.js"></script>
		<script type="text/javascript" src="../../js/appCommonUtil.js"></script>
		<script type="text/javascript" src="../../js/golbal_params.js"></script>
		<script type="text/javascript" src="../../js/common_validation.js"></script>
		<script type="text/javascript"
			src="../activitiModelsManager/activiti.js"></script>
		<style type="text/css" class="init">
/**栅格布局调整开始*/ /**调整内容：一行4列，列宽：span4*/
.form-horizontal .control-label {
	float: left;
	width: 100px;
	text-align: right;
	padding-left: 0px !important;
	padding-top: 2px;
	padding-bottom: 2px;
}

.form-horizontal .controls {
	padding: 5px 0px;
	line-height: 5px;
	width: 200px !important;
	margin-left: 0px !important;
	float: left;
	padding-bottom: 2px;
	padding-top: 0px;
}

form {
	margin-bottom: 0px !important;
}

.container {
	width: 100% !important;
}

.row {
	margin-left: 0px !important;
}

H6 {
	margin-top: 2px;
	margin-bottom: 2px;
}

[class *='span'] {
	margin-left: 0px;
}

.span4 {
	width: 300px !important;
}

.nav {
	margin-bottom: 4px;
}

FORM {
	margin-top: 5px;
	padding-top: 0px;
	padding-bottom: 0px;
}


.searchDiv {
	margin-top: 2px;
	margin-bottom: 2px;
	marring-top: 2px;
	padding-left: 2px;
	width: 1060px;
}

.wokeorderDiv {
	marring-top: 2px;
	padding-left: 2px;
	border: 1px solid #33AECC;
	cellspacing: 1px;
	cellpadding: 1px;
	width: 1200px;
}

.container {
	margin-left: 0px
}

.top10 {
	margin-top: 10;
}

#orderFlow td.red {
	text-align: center;
}

#orderFlow th {
	text-align: center;
}

.table td {
	text-align: center;
}

.dataTables_scrollBody{
	overflow-x : hidden!important ;
}
</style>
<script type="text/javascript">
var parentA = window.parent;
var SelActivti = []; //选中数据集合
//获取待办数据方法
function dosel() {
    var table = $('#activitibody').DataTable();
    var tt = new $.fn.dataTable.TableTools(table);
    SelActivti = tt.fnGetSelectedData();
    var pat = {};
    if (SelActivti.length != 0) {
        for (var i in SelActivti) {
            if (pat.A_TASKIDS != undefined && pat.doClaimIDS != undefined) {
                pat["A_TASKIDS"] = SelActivti[i].a_id + ";" + pat["A_TASKIDS"]; //taskID字符串集合(领取-必需数据)
                pat["doClaimIDS"] = SelActivti[i].id + ";" + pat["doClaimIDS"]; //业务主表ID字符串集合(修改-必需数据)
            } else {
                pat["A_TASKIDS"] = SelActivti[i].a_id + ";";
                pat["doClaimIDS"] = SelActivti[i].id + ";";
            }
        };
        NeedAndAudit(pat);
    } else {
        window.parent.zinglabs.i18n.alert("liuyanguanli_qingxuanzeyaolingqudeshuju");
    }
};

//签收方法		
function NeedAndAudit(pat) {
    pat["A_FORMCLASS"] = "HQDBUpdate";
    if(A_PROCESSDEFINITIONID=="BOC_gongdan01"||A_PROCESSDEFINITIONID=="BOC_gongdan02"){
    	pat["A_FORMCLASS"] = "GongdanLingqu";
    }
    pat["A_PROCESSDEFINITIONID"] = A_PROCESSDEFINITIONID;
    pat["A_ASSIGNEE"] = getUserInfo().loginName;
    //设置复核人当前处理人.
    var appointedCheckUserID = getUserInfo().loginName;
    pat.appointedCheckUserID = appointedCheckUserID;
    pat.appointedCheckUser = getUserInfo().name;
    pat.disponseUser = appointedCheckUserID;
    if (pat.A_TASKIDS != "" && pat.A_TASKIDS != null) {
        doClaimByTaskId(pat,
        function(data) {
            if (data.success) {
                //提交成功领取条数,并同步刷新待办列表
                var alertpat = {
                    "${0}": SelActivti.length,
                    "${1}": data.data
                };
                window.parent.zinglabs.alert("领取成功");
                doRepeat(); //获取待办页面刷新
                var re = getQueryString("doRepeat");
                try{
                parentA.frames["needforme"][re](); //调用获取待办页面的页面刷新
                parentA.closeHQDBDig(); //关闭获取待办页面
                }catch(e){
                 	parentA.closeHQDBDig(); //关闭获取待办页面
                	window.parent.focus() ;
                }
                
            } else {
                window.parent.zinglabs.i18n.alert("liuyanguanli_shujuhuoqushibai");
            }
        });
    } else {
        window.parent.zinglabs.i18n.alert("liuyanguanli_renwubianhaohuoqushibai");
    }
}
function closehuoqudaiban(){
	try{
	parentA.closeHQDBDig(); //关闭获取待办页面
	}catch(e){
	window.parent.focus() ;
	}
}
var dataGrid = {}; //datatable 初始化参数
var getActivitiTasksUrl = "/ZDesk/activitiManager/activityCommon/getTasks.action"; //获取流程数据action路径
var A_PROCESSDEFINITIONID = ""; //流程标识
var A_TASKNAME = ""; //节点名称(-获取待办);
var A_FORMCLASS = "" //表单类
var activitiParameterAndData; //流程配置和获取来的流程数据
dataGrid = {
    deferRender: true,
    //延迟加载
    'bPaginate': true,
    //分页器
    'bLengthChange': false,
    'bStateSave': true,
    //保留状态
    'bSort': true,
    //按列排序
    'bInfo': true,
    //页脚信息
    'bAutoWidth': false,
    //自动宽度
    //'sScrollX':'1150',//垂直滚动条,滚动区域
    "scrollY": "200px",
    // 开启服务端分页
    serverSide: true,
    processing: false,
    bPaginate: true,
    //翻页功能
    bFilter: true,
    //过滤功能
    ajax: FYdoSearch,
    dom: 'TRlrtip',
    //  "scrollCollapse": "true",
    'sPaginationType': 'bootstrap',
    //分页样式
    'dom': 'TRlrtip',
    "oLanguage": {
        "sSearch": "搜索:",
        "sLengthMenu": "每页显示 _MENU_ 条记录",
        "sZeroRecords": "Nothing found - 没有记录",
        "sInfo": "显示第  _START_ 到  _END_ 条,一共  _TOTAL_ 条",
        "sInfoEmpty": "显示0条",
        "scrollY": false,
        "scrollX": false,
        "scrollCollapse": false,
        "oPaginate": {
            "sFirst": "首页",
            "sPrevious": " 上一页 ",
            "sNext": " 下一页 ",
            "sLast": "尾页"
        }
    },
    tableTools: {
        //single 单选 multi 多选  os 可以按ctrl 选择
        // sRowSelect:'multi',
        //回调 单选
        fnRowSelected: function(nodes) {
            var index = nodes[0]._DT_RowIndex;
            var data = $('#activitibody').DataTable().row(index).data();
        },
        sRowSelect: 'multi',
        //sRowSelector:'td:first-child',
        aButtons: [
        /*{
      "sExtends":    "select_all",
      "sButtonText": "选择全部",
      "target":      "#select"
    } , 'select_none' */
        ]
    }
}
function initTable() {
    if (window.top[A_PROCESSDEFINITIONID + "clumns"] == undefined) {
        var pat = {
            "A_TASKNAME": A_TASKNAME,
            "A_PROCESSDEFINITIONID": A_PROCESSDEFINITIONID,
            "A_FORMCLASS": A_FORMCLASS
        };
        getTaskUnassigned(pat,
        function(data) {
            activitiParameterAndData = data.data;
            window.top[A_PROCESSDEFINITIONID + "clumns"] = activitiParameterAndData.clumns;
            dataGrid.columns = eval(activitiParameterAndData.clumns);
            $('#activitibody').dataTable(dataGrid);
            var table = $('#activitibody').DataTable();
            //table.page.len('10').draw();
            $('#activitibody tbody').on('click', 'button',
            function(obj) {
                var data = table.row($(this).parents('tr')).data();
            });
            var colvis = new $.fn.dataTable.ColVis(table, {
                buttonText: '自定义显示列',
                exclude: [0, -1]
            });
            $(colvis.button()).insertBefore('#cols');
        });
    } else {
        dataGrid.columns = eval(window.top[A_PROCESSDEFINITIONID + "clumns"]);
        $('#activitibody').dataTable(dataGrid);
    }
}
/**datatables填充数据**/
function drawTable(data) {
    var table = $('#activitibody').DataTable();
    table.search("").draw();
    table.clear().draw();
    table.rows.add(data).draw(true);
}

/**刷新**/

function doRepeat() {
    var table = $('#activitibody').DataTable();
    table.draw(true);
}
//分页查询
function FYdoSearch(data, callback, settings) {
    var param = {};
    param.A_PROCESSDEFINITIONID = A_PROCESSDEFINITIONID;
    putLoginNameToParam(param);
    param.A_ASSIGNEE = getUserInfo().loginName;
    param.A_FORMCLASS = A_FORMCLASS;
    param.A_BeginNum = settings._iDisplayStart;
    param.A_MaxNum = settings._iDisplayLength;
    param.A_TASKNAME = A_TASKNAME;
    getTaskUnassigned(param,
    function(Nowdata) {
        if (Nowdata.data) {
            if (Nowdata.data.resultformdata != undefined) {
                var pdata = {};
                //数据
                pdata.data = Nowdata.data.resultformdata;
                var total = Nowdata.data.total;
                //总条数
                pdata.recordsTotal = total;
                //过滤没有使用到总条数
                pdata.recordsFiltered = total;
                // 代表第几次画页面  如pdata.draw 不能删 如删掉不会翻页  
                pdata.draw = settings.iDraw;
                callback(pdata);
            } else {
                var Notdata = [];
                var pdata = {};
                //数据
                pdata.data = Notdata;
                var total = 0;
                //总条数
                pdata.recordsTotal = total;
                //过滤没有使用到总条数
                pdata.recordsFiltered = total;
                // 代表第几次画页面  如pdata.draw 不能删 如删掉不会翻页  
                pdata.draw = settings.iDraw;
                callback(pdata);
            }
        }
    });
}

$(document).ready(function() {
    A_PROCESSDEFINITIONID = getQueryString("PROCESSDEFINTION_ID");
    A_TASKNAME = getQueryString("A_TASKNAME");
    A_FORMCLASS = getQueryString("A_FORMCLASS");
    initTable();
    //获取相应方法；
    LQDBFn = getQueryString("LQDBFn");
    CloseFn = getQueryString("CloseFn");
});
	</script>
	</head>
	<body style="">

		<table style="" class="table table-striped table-bordered " style=""
			id="activitibody" cellspacing="0">
		</table>
		<div class="widget-box collapsible">
			<div class="widget-title" style="border: 0px">
				<span class="icon"> <i class="icon-cog"></i> </span>
				<div style="margin-left: 15px; line-height: 35px;margin-top: -15px;">
					<button class="btn" onclick="dosel()">
						<i class="icon-hand-up"></i>领取数据
					</button>
					<button id="addbtfrom" role="button" class="btn"
						data-toggle="modal" onclick="doRepeat()">
						<i class="icon-refresh"></i>刷 新
					</button>
					<button class="btn" onclick="closehuoqudaiban()">
						<i class="icon-eject"></i>关闭
					</button>
				</div>
			</div>
		</div>
	</body>
</html>
