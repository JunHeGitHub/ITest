
<!DOCTYPE  HTML>
<html>
	<head>
		<title>节点添加或修改</title>
		<meta http-equiv="keywords" content="keyword1,keyword2,keyword3" />
		<!-- <meta http-equiv="description" content="this is my page" /> -->
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<link rel="stylesheet" href="../../css/bootstrap.min.css"
			type="text/css" />
		<link rel="stylesheet"
			href="../../js/dataTables/css/jquery.dataTables.css" type="text/css" />
		<link rel="stylesheet" href="../../js/dataTables/css/DT_bootstrap.css"
			type="text/css" />
		<link rel="stylesheet"
			href="../../js/dataTables/css/dataTables.tableTools.min.css"
			type="text/css" />
		<!-- ZDesk 通用css  -->
		<link rel="stylesheet" href="../../css/zinglabs.css" type="text/css" />
		<link rel="stylesheet" href="../../js/dataTables/css/font-awesome.css" />
		<link rel="stylesheet"
			href="../../js/dataTables/css/dataTables.colVis.min.css"
			type="text/css" />
		<link rel="stylesheet" type="text/css"
			href="../../js/ueditor/themes/default/css/ueditor.css" />
		<script type="text/javascript" src="../../js/jquery.js"></script>
		<script type="text/javascript" src="../../js/bootstrap.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/jquery.dataTables.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.colReorder.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.colVis.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.tableTools.min.js"></script>
		<script type="text/javascript" src="../../js/common_utils.js"></script>
		<script type="text/javascript" src="../../js/appCommonUtil.js"></script>
		<script type="text/javascript"
			src="../../js/appCommonCurdUtils_new.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/DT_bootstrap.js"></script>
		<script type="text/javascript"
			src="../../js/My97DatePicker/WdatePicker.js"></script>
		<script type="text/javascript" src="../../js/log2.js"></script>
		<!-- 文本编辑器 -->
		<script type="text/javascript" charset="utf-8"
			src="../../js/ueditor/ueditor.config.js"></script>
		<script type="text/javascript" charset="utf-8"
			src="../../js/ueditor/ueditor.all.js"></script>

		<script type="text/javascript" charset="utf-8"
			src="../../js/ueditor/lang/zh-cn/zh-cn.js"></script>
		<!-- 遮罩产插件 -->
		<script type="text/javascript" src="../../js/jquery.blockUI.js"></script>
		<!-- 验证及提示组件 -->
		<script type="text/javascript"
			src="../../js/jqueryValidate/jquery.validate.js"></script>

		<style type="text/css">
/*解决时间控件在模式对话框中的显示问题**/
.error {
	border-color: red !important;
}

.datetimepicker {
	z-index: 99999 !important;
}

.bootstrap-datetimepicker-widget {
	z-index: 99999 !important;
}

/*临时解决datatable单元格变形问题  为保证宽度不变，ie兼容模式显示效果为换行 其它浏览器省略号
  需要通过只显示部分原文解决此问题
*/
.dataTable th,.dataTable td {
	width: 120px;
	max-width: 120px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}
</style>

		<script type="text/javascript">
	  var PRJ_PATH=window.top.PRJ_PATH||"ZDesk";
//遮罩属性		
var maskContent = {
		css : {
			border : 'none',
			padding : '15px',
			backgroundColor : '#000',
			'-webkit-border-radius' : '10px',
			'-moz-border-radius' : '10px',
			opacity : .5,
			color : '#fff',
			font : '14px'
		},
		message : '<img src="../img/wait.gif" border="0" />  正在加载中，请稍候...'
	};
var data="";
var roleTable=false;
var rowSelTr=false;
var partId="";
var id='';
var ueditor="";
$(document).ready(function() {
	id=getQueryString("Id");
//初始化文本编辑器
	ueditor=new baidu.editor.ui.Editor({
	//这里可以选择自己需要的工具按钮名称,此处仅选择如下五个
    toolbars:[],
    //focus时自动清空初始化时的内容
    autoClearinitialContent:true,
    //关闭字数统计
    wordCount:false,
    //关闭elementPath
    elementPathEnabled:false,
    autoHeightEnabled: false,//编辑器自动变高失效
    initialFrameWidth :560,//设置编辑器宽度
	initialFrameHeight:100,//设置编辑器高度
	});
    ueditor.render('description');
    if(id=="Id"){
    	jiedianData=window.parent.jiedianData;
		stepId=jiedianData.id;
		templateId=jiedianData.templateId
		desc=jiedianData.description;
		openEdit(jiedianData);
		selectScope();
	}else if(id=="templateId"){
		templateId=window.parent.templateId;
	}
});
//选择执行人打开的树
var PROJECT = window.top.PRJ_PATH || "ZDesk"; 
function showDialogWindows(){
	var url =  "/" + PROJECT + "/zh_cn/common/userMappingOrg.html?showButton=y&reFillFn=setAppointedCheckUser&closeFn=closeDig&pchm=ps&cchm=ps&disponse=0&FilterBeanId=TreeSkillGroupInfo";
	closeDialog=executorDialog(url);
}
function executorDialog(url){
    var userDig = dialog({
	    title : '执行人',
		content : '<iframe src=' + url + ' style="border: 0; width: 100%; height: 100%"  frameborder="0"/>',
		width : '300',
		height : '400'
	});
	$.blockUI(maskContent);
	userDig.show();
	closeBlock();
	return userDig;
}
function setAppointedCheckUser(list){
	var name="";
    var id="";
    var cardUrl="";
   	for(var i=0;i<list.length;i++){
       	name=list[i].text+name;
       	id=list[i].id+id;
       	cardUrl=list[i].cardUrl+cardUrl;
    }
    $("#executor_name").val(name);
    $("#executor").val(id);
    $("#cardUrl").val(cardUrl);
    closeR();
}
//关闭dialog
function closeR(){
	$.unblockUI();
	window.closeDialog.close().remove();
}
//选择节点范围
function showScopeWindows(){
	var url_RoleName="/"+PRJ_PATH+"/zh_cn/chatWorkflow/scopeChoice.html";
	closeScopDialog=scop(url_RoleName);
}
function scop(url_RoleName){
	var scopDig=dialog({
	title: '为节点选择范围',
	content: '<iframe src='+url_RoleName+' style="border: 0; width: 100%; height: 100%"  frameborder="0"/>',
		width:'750',
		height:'400'
	});
	$.blockUI(maskContent);
	scopDig.show();
	closeBlock();
	return scopDig;	
}
function addOrgScope(ids,names){
	var name="";
    var id="";
   	for(var i=0;i<names.length;i++){
       	name=names[i]+","+name;
    }
    for(var i=0;i<ids.length;i++){
        id=ids[i]+","+id;
    }
    org=name.substring(0,name.length-1);
    orgid=id.substring(0,id.length-1);
    $("#zzjg").val(orgid);
    $("#zuzhi").html(org);
    $("#zuzhiId").show();
    $("#zuzhi").show();
    showSuccess("选择成功");
}
function addRoleScope(ids,names){
	var name="";
    var id="";
   	for(var i=0;i<names.length;i++){
       	name=names[i]+","+name;
    }
    for(var i=0;i<ids.length;i++){
        id=ids[i]+","+id;
    }
    role=name.substring(0,name.length-1);
    roleid=id.substring(0,id.length-1);
    $("#js").val(roleid);
    $("#juese").html(role);
    $("#jueseId").show();
    $("#juese").show();
    showSuccess("选择成功");
}
//关闭遮罩
function closeBlock(){
	$(".ui-dialog-close").click(function() {
		$.unblockUI();
	});
	//esc 键触发
	$(document).keyup(function(event){
		switch(event.keyCode) {
		case 27:
		$.unblockUI();
		}
	});
	
}
//打开修改表单
function openEdit(data){
   var pvars={"id":"yijieshouxinxiEdit","data":data};
   setPanelVal(pvars);
 
}

/***
 *
 * @desc 指定panel赋值 和清空
 */
function setPanelVal(pVars){
    $('#'+pVars.id+' :input').each(function(index,obj) {
        var type = obj.type;
        var tag = obj.tagName.toLowerCase();
        if(("isClear" in pVars) && pVars.isClear=='true'){
            if (type == 'text' || type == 'password' || tag == 'textarea' || type=='hidden')
                $(obj).val('');
            else if (type == 'checkbox' || type == 'radio')
                $(obj).attr('checked',false);
            else if (tag == 'select')
                $(obj).attr('selectedIndex',-1);
        }else{
            var vTmp=pVars.data[this.name];
            if(BIsNullVal(vTmp)){
                vTmp='';
            }
 	        ueditor.addListener("ready", function () {        // ueditor准备好之后才可以使用        
				ueditor.setContent(desc,false);
			});
            if (type == 'text' || type == 'password'||type=='hidden' || tag == 'textarea'||tag == 'select')
                $(obj).val(vTmp);
            else if (type == 'checkbox' || type == 'radio'){
                $(obj).attr('checked',vTmp==''?false:vTmp);
            }
            else if (tag == 'select'){
                $(obj).attr('selectedIndex',vTmp==''?-1:vTmp);
            }
        }
    });
}

//关闭dialog
function closeDig(){
	window.parent.refresh();
	window.parent.$.unblockUI();
	window.parent.closeDialog.close().remove();
}
		
function selectScope(){
	var params={};
	var url="/"+PRJ_PATH+"/ZDesk" + "/Step"+ "/selectStepManage.action";
	params.stepId=stepId;
	params.isPagination=false;
	$.blockUI(maskContent);
	ajaxFunction(url, params, false, function(data) {
		if(data&&data.data){
			var pdata={};
			pdata=data.data;
			for(var i=0;i<pdata.length;i++){
			  if(pdata[i].scopeType=="js"){
			    $("#jueseId").show();
			    $("#juese").show();
			    var a=pdata[i].scope.split(',');
			    for(var j=0;j<a.length;j++){
			    	if(a[j]=="expert"){
			    		$("#juese").append("专家,");
			    	}else if(a[j]=="employee"){
			    		$("#juese").append("员工,");
			    	}else if(a[j]=="agent"){
			    		$("#juese").append("客户,");
			   		}else if(a[j]=="MHadmin"){
			    		$("#juese").append("系统管理员");
			   		}
			    }
			    $("#js").val(pdata[i].scope);
			  }else if(pdata[i].scopeType=="zzjg"){
			    $("#zuzhiId").show();
			    $("#zuzhi").show();
			    $("#zuzhi").html(pdata[i].stepScope);
				$("#zzjg").val(pdata[i].scope);
			  }
			}
		}
		$.unblockUI(); 	
	});
};
//提交方法
function doSubmit(){
	var bool= $("#jiedianForm").validate().form();
	if(bool){
		var rData={};
		var data=zkm_getHtmlFormJsons("jiedianForm");
		if(data.serial==""||data.serial==null){
			data.serial=0;
		}
		if(($("#juese").html()==""||$("#juese").html()==null)&&($("#zuzhi").html()==""||$("#zuzhi").html()==null)){
			showError("节点范围中组织机构和角色都未选择，请至少选一个");
			return;
		}
		data.description=ueditor.getContent();
		data.templateId=templateId;
		var url="/"+PRJ_PATH+"/ZDesk" + "/Step"+ "/insertStep.action";
		ajaxFunction(url, data, false, function(data) {
		if (data && data.success==true) {
			rData=data.mgs;
			zinglabs.confirm2cancelFn("添加成功，是否继续添加？",function(){
				$("#jiedianForm")[0].reset();
				ueditor.setContent("");
				$("#juese").html("");
				$("#js").val("");
				$("#zuzhi").html("");
				$("#zzjg").val("");
				$("#jueseId").hide();
				$("#zuzhiId").hide();
			},function(){
				closeDig();
			});
		} else {
			alert(data.mgs);
		}
	});
	}
}

/***
 * @TODO
 * 通用，调试完成后分文件，不要加Velocity代码
 */
function BIsNullVal(value) {
    return typeof(value)=="undefined" || value==null ||  (typeof(value)=='string' &&(value=="undefined" || value=='' || value=='null' )) ||  (typeof(value)=='boolean' &&value==false  );
};


/***
 * 必须处理的严重错误，测试阶段可以alert 生产环境特殊标识写入日志
 * 发现就要分析原因
 * @param err
 */
function logErr(errMsg) {
    log.debug(errMsg);
//    alert(errMsg);
//    PT().log.error(errMsg);
};


/***
 * 嵌入ifram可以返回top parent
 * 非嵌入 可以返回 window ...
 * @returns {Window}
 * @constructor
 */
function PT(){
    return window;
};

//显示错误信息
function showError(mgs){
  //$("#errorDiv").show();
  //  $("#successDiv").hide();
  //  $("#errorDiv").html(mgs);
  //  setTimeout(function(){
  //    $("#errorDiv").hide();
  // },3000);
    zinglabs.alert(mgs);

}
//显示成功信息
function showSuccess(mgs){
  //  $("#errorDiv").hide();
  // $("#successDiv").show();
  //  $("#successDiv").html(mgs);
 //  setTimeout(function(){
  //     $("#successDiv").hide();
 //  },3000);
 zinglabs.alert(mgs);
}

    </script>
	</head>
	<body>

		<!-- 容器 -->
		<div class="z_container" style="min-width: 100%;">
			<!-- 表单部分 -->
			<!-- <div class="foot "> 
				<div class="widget-box " style="margin-top: 0px"> -->
			<div id="yijieshouxinxiEdit" class="container" style="width: 700px;">
				<form id="jiedianForm">
					<input type="hidden" name="id" id="id">
					<div class="row" style="margin-left: -130px">
						<div class="span4 ">
							<div class="form-horizontal">
								<div class="control-group">
									<label class="control-label" for="inputEmail">
										节点名称:
									</label>
									<div class="controls">
										<input type="text" id="stepName" name="stepName"
											data-rule-required="true" data-rule-maxlength="20"
											data-msg-required="节点名称不能为空！" data-msg-maxlength="节点名称不能超过20个字"/>
									</div>
								</div>
							</div>
						</div>
						<div class="span4 offset1" style="margin-left: 40px;">
							<div class="form-horizontal">
								<div class="control-group">
									<label class="control-label" for="msgId">
										顺序号:
									</label>
									<div class="controls">
										<input type="text" id="serial" name="serial"
											data-rule-digits="true" data-rule-min="0"
											data-msg-digits="只能为正整数" data-msg-min="只能为正整数">
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="row" style="margin-left: -130px">
						<div class="span4 ">
							<div class="form-horizontal">
								<div class="control-group">
									<label class="control-label" for="inputEmail">
										节点范围:
									</label>
									<div class="controls">
										<button type="button" class="btn" id="btn_xuanze"
											onclick="showScopeWindows();">
											选择
										</button>
									</div>
									<div style="width: 220px; margin-left: 180px; display: none;"
										id="jueseId">
										角色：
										<input type="hidden" id="js" name="js"/>
										<span style="width: 200px; display: none;" data-roleId="" id="juese"></span>
										<br />
									</div>
									<div style="width: 220px; margin-left: 180px; display: none;"
										id="zuzhiId">
										组织机构：
										<input type="hidden" id="zzjg" name="zzjg"/>
										<span style="width: 200px; display: none;" id="zuzhi"></span>
									</div>
								</div>
							</div>
						</div>
						<div class="span6 ">
							<div class="form-horizontal">
								<div class="control-group" style="margin-left: 20px">
									<label class="control-label" for="inputEmail">
										执行人:
									</label>
									<div class="controls">
										<input type="hidden" id="executor" name="executor" />
										<input type="hidden" id="cardUrl" name="cardUrl" />
										<input type="text" id="executor_name" name="executor_name"
											style="width: 152px;" value="" readonly="readonly" />
										<button type="button" class="btn" id="btn_xuanze"
											onclick="showDialogWindows();">
											选择
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="row" style="margin-left: -130px">
						<div class="span4 ">
							<div class="form-horizontal">
								<div class="control-group">
									<label class="control-label" for="inputEmail">
										节点描述:
									</label>
									<div class="controls">
										<!-- <input type="text" id="stepName" name="stepName"
													data-rule-required="true" data-rule-maxlength="10"
													data-msg-required="节点名称不能为空！" /> -->
										<script type="text/plain" id="description"
											name="description"></script>
									</div>
								</div>
							</div>
						</div>
					</div>
				</form>
				<div>
					<button class="btn btn-primary" onclick="doSubmit()">
							提 交
					</button>
					&nbsp;
					<button class="btn null" id="quxiao" onclick="closeDig()">
							取 消
					</button>
				</div>
			</div>
		</div>
		<!-- </div>
		</div> -->
	</body>
</html>
