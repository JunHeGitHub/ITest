<!DOCTYPE html>
<html>
	<head>
		<title>创建工作流</title>
		<meta http-equiv="Content-Type" content="textml; charset=utf-8" />
		<meta name="viewport"
			content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<!-- 选择参与人 -->
		<link rel="stylesheet" href="css/jquery.mmenu.all.css?v=9999.9999" type="text/css"></link>
		<link rel="stylesheet" type="text/css" href="css/workflowPage.css?v=9999.9999" />
		<!-- <link rel="stylesheet" type="text/css" href="css/jquery.mobile.v1.css?v=9999.9999" /> -->
		<script type="text/javascript" src="js/jquery-1.8.3.min.js?v=9999.9999"></script>
		<script type="text/javascript" src="js/shared.js?v=9999.9999"></script>
		<!-- <script type="text/javascript" src="js/jquery.mobile-1.3.1.min.js?v=9999.9999"></script> -->
		<!-- <script type="text/javascript" src="js/headin_mobile.js?v=9999.9999"></script>-->
		<SCRIPT language="javascript" type="text/javascript" src="js/createWork.js?v=9999.9999"></SCRIPT>

		<!-- <script language="javascript" type="text/javascript" src="js/conf.js?v=9999.9999"></script> -->
		<script type="text/javascript" src="../../js/appCommonCurdUtils_new.js?v=9999.9999"></script>
		<script type="text/javascript" src="../../js/appCommonUtil.js?v=9999.9999"></script>
		<script type="text/javascript" src="../../js/jquery.validate.js?v=9999.9999"></script>
		<!-- 选择参与人 -->
		<script type="text/javascript" src="js/jquery.mmenu.min.all.js?v=9999.9999"></script>
		<script type="text/javascript" src="../../js/common_utils.js?v=9999.9999"></script>

		<!-- 文本编辑器 -->
	   <script type="text/javascript" charset="utf-8" src="../../js/ueditor/ueditor.config.js?v=9999.9999"></script>
       <script type="text/javascript" charset="utf-8" src="../../js/ueditor/ueditor.all.js?v=9999.9999"></script>
       <link rel="stylesheet" type="text/css" href="../../js/ueditor/themes/default/css/ueditor.css?v=9999.9999"/>
       <script type="text/javascript" charset="utf-8" src="../../js/ueditor/lang/zh-cn/zh-cn.js?v=9999.9999"></script>
		<style type="text/css">
.edui-default .edui-editor-iframeholder {
	background-color: #f1f1f1;
}
#workflow_describe
{
 height:auto;
 max-height:100px;
 overflow:auto;
}
</style>
	</head>
	<body>

		<div id="page">
			<div style="background-color: #f7f7f7" id="industry-list">
				<header id="common_hd" class="c_txt rel">
				<a id="hd_back" class="abs comm_p8" onclick="history.back();"
					type="item&amp;hd_back=1"> </a>
				<h1 class="hd_tle">
					创建工作流
				</h1>
				<!--
			<div id="search" class="abs" >
				<div id="order-select" class="select_options" style="text-align: center; line-height: 50px; font-size: 14px;">搜索</div>
				
				 <div id="favorite" >
		        	<em id="favourite_line" class="abs">&nbsp;</em>
		        </div>
			</div>
			-->
   		 </header>
				<div style="height: 8px; width: 100%; background-color: gray;"></div>
				<div class="fav-list-content">
					<form action="" id="searchForm">
						<div class="select-div">
							<div class="middle">
								<span class="_span"> <span class="span-xiabiao"> </span>
									<select onchange="openCategory();" id="focusArea"
										class="select-xz" name="focusArea">
									</select> </span>
							</div>
						</div>

						<div class="select-div">
							<div class="middle">
								<span class="_span"> <span class="span-xiabiao"> </span>
									<select onchange="filterTemplateForJNZType();"
										class="select-xz" id="IndustryID" name="IndustryID">
									</select> </span>
							</div>
						</div>

						<div class="select-div" id="choseJNZ" style="display: none;">
							<div class="middle">
								<span class="_span"> <span class="span-xiabiao"> </span>
									<select class="select-xz" onchange="skDataId();" id="jinengzu"
										name="jinengzu">
									</select> </span>
							</div>
						</div>

						<div id="categoryDescDiv"
							style="display: none; width: 90%; margin: 0 auto;">
							模板描述：
							<span id="categoryDesc" style="display: none;" title="模板描述："></span>
							<div id="stepDescDiv" style="display: none; margin: 0 auto;">
								节点（步骤）概览：
								<br />
								<span id="stepDesc" style="display: none;" title="节点"></span>
							</div>
						</div>

						<div class="_inout-div">
							<div class="input-div">
								<input placeholder="请输入工作流名称" id="workflow_name"
									name="workflow_name" class="_input" data-rule-required="true"
									data-rule-maxlength="100" data-msg-required="工作流名称不能为空！">
							</div>
						</div>

						<div class="_cript">
							请输入工作流描述：
							<script type="text/plain" placeholder="请输入工作流描述"
								id="workflow_describe" name="workflow_describe"></script>
						</div>

						<div class="people" id="choseCanYuRen" style="display: none;">
							人员：&nbsp;参与&nbsp;&nbsp;
							<span id="cUser">0</span>&nbsp;人&nbsp;&nbsp;&nbsp;
							<!--执行&nbsp;&nbsp;
							 <span id="zUser">0</span>&nbsp;人 &nbsp;&nbsp; -->
							<span class="xzButton"> <a href="#"
								onclick="openMmenu111(this);">选择</a> </span>
						</div>

						<div style="margin-top: 10px;">
							<div class="check-div">
								<input type="checkbox" style="margin-top: 5px;"
									id="check_invite" class="_check" name="check_invite" value="是">
							</div>
							<span style="margin-top: 10px; margin-left: 40px;">是否可邀请</span>
						</div>
						<br />

						<p>
							<a id="btnSearchForm1" class="baocun"> 
								<span class="baocun-span"> 
									<span>保存</span> 
								</span> 
							</a>
							<a id="btn_updataZhiXingRen" class="baocun" onclick="submit_updata();" 
								style="display:none;"> 
								<span class="baocun-span"> 
									<span>保存</span>
								 </span> 
							</a>
							<div id="div_info" style="display:node;color:red;">
								注：只可更改各节点执行人、参与人与是否可邀请。<br/>
								&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其他数据项更改不生效！
							</div>
					<!-- 	</p>  -->

					</form>
					<!--div class="count-tips" id="userAll">&nbsp;</div-->
				</div>
			</div>
		</div>
		<nav id="menu"></nav>
		<script>
//通过分类id查找模块名称别写入select
var curWrokflowId="1011";//getQueryString("_id");//判断当前页面是创建 还是更改该工作流所选定模板下各节点的执行人 判断标准 是否又工作流id传入
var loginName=getQueryString("loginName");
var ZKM_ROU="ZKM";
var a="agent";
var ueditor;//文本编辑器
var isPageForJNZ=false;//标识当前提交的是否与技能组有关
var glData=[];//保存Workflow_Relation_Table关联表要保存的数据
var skData=[];//保存技能组数据
var skDataI=0;
function openCategoryDesc(){
	$("#choseJNZ").find("option").remove();//清楚下拉列表数据
	comboIdMap["IndustryID"]="<option value=\"0\">选择模块</option>";
	var url="/"+PRJ_PATH+"/"+ZKM_ROU+"/"+"RA"+"/"+"checkCategoryDesc.action";
	var rdata=[];
	var id=$("#focusArea").val();
	var data={"roleCode":a,"isDelete":"已启用","partId":id};
	ajaxFunction(url, data, true, function(data) {
		if (data && data.success) {
			rdata=data.data;
			$("#categoryDesc").html('');
			glData=[];
			for(var i=0;i<rdata.length;i++){
				comboIdMap["IndustryID"]+="<option value=\""+rdata[i].id+"\">"+rdata[i].categoryName+"</option>";
			}
			$("#IndustryID").find("option").remove();
			var comboObj=$("#"+"IndustryID");
			comboObj.append(comboIdMap["IndustryID"]);
    		//comboObj.selectmenu("refresh");
			rdata = data.data;
		} else {
			alert(data.msg);
		}
	});
	$("#categoryDescDiv").hide();
	$("#categoryDesc").hide();
	$("#stepDescDiv").hide();
	$("#stepDesc").hide(); 
}
//通过模块id获取模块描述并写入隐藏的div中
function openCategoryDescByCategoryId(){
	$("#stepDesc").html('');
	var id=$("#IndustryID").val();
	var pat={};
	var rdata=[];
	var columnValues={};
	pat.tableName = "wx_category";
	pat.columnValues=columnValues;
	pat.columnValues.id=id;
	pat.columns="categoryDesc";
	pat.equal="id";
	commonSelect(pat,true,function(data){
		if(data&&data.data){
			rdata=data.data;
			if(rdata.length==0){
				$("#categoryDesc").html('');
			}else{
				$("#categoryDesc").html(rdata[0].categoryDesc+"<br/>");
				//$("#categoryDesc").val(rdata[0].categoryDesc);
			}
		}
		openStepByNodeid();
		$("#categoryDescDiv").show();
		$("#categoryDesc").show(); 
	});
}





//加载模板描述
var initTemplageDesc=function(rdata){
	if(rdata){
		if(rdata.length==0){
			$("#categoryDesc").html('');
			$("#stepDesc").html('');
		}else{
			$("#categoryDesc").html(rdata[0].categoryDesc+"<br/>");
		}
		openStepByNodeid();
		
		$("#categoryDescDiv").show();
		$("#categoryDesc").show();
		$("#choseCanYuRen").show(); 
		if(curWrokflowId!=undefined && curWrokflowId!=""){
			$("#choseJNZ").slideDown(200);
		}else{
			$("#choseJNZ").slideUp(200);
		}
	}
}
//通过模板id获取模板数据
var getTemplateDataById=function(){
	var id=$("#IndustryID").val();
	var pat={};
	var rdata=[];
	var columnValues={};
	pat.tableName = "wx_category";
	pat.columnValues=columnValues;
	pat.columnValues.id=id;
	pat.columns="categoryDesc,skillType";
	pat.equal="id";
	commonSelect(pat,false,function(data){
		if(data&&data.data){
			rdata=data.data;
		}		
	});
	return rdata;			
}
//获取选中的是哪个技能组
function skDataId(){
	skDataI=$("#jinengzu").val();
}
//筛选模板是否带有技能组类型
var filterTemplateForJNZType=function(){
	//通过当前选中的模板id获取模板数据
	var templateData=getTemplateDataById();
	if(templateData && templateData!=undefined){
		if(templateData.length==1){
			if(templateData[0]!=undefined && templateData[0].skillType!=""){
				isPageForJNZ=true;
				//处理带技能组类型的模板
				$("#stepDesc").html('');
				openSelectForJNZ(templateData[0].skillType);
			}else{
				isPageForJNZ=false;
				//处理不带技能组类型的模板
				$("#choseJNZ").find("option").remove();//清楚下拉列表数据
				initTemplageDesc(templateData);
			}
		}
	}
}
//打开技能组下拉列表
var openSelectForJNZ=function(skType){
	//加载技能组下拉数据
	getJNZDataBySkType(skType);
	//显示技能组下拉
	$("#categoryDesc").hide();
	$("#categoryDescDiv").hide();
	$("#choseCanYuRen").hide();
	$("#choseJNZ").slideDown(200);
	
}
//通过技能组类型获取技能组数据
var getJNZDataBySkType=function(skType){
	$("#choseJNZ").find("option").remove();//清楚下拉列表数据
	comboIdMap["jinengzu"]="<option value=\"\">选择技能组</option>";
	var url="/"+PRJ_PATH+"/ZDesk/"+"MHWorkflow"+"/"+"getJNZDataByskType.action";
	var rdata=[];
	var data={};
	data.skType=skType;
	ajaxFunction(url, data, true, function(data) {
		if (data && data.success) {
			rdata=data.data;
			for(var i=0;i<rdata.length;i++){
				comboIdMap["jinengzu"]+="<option value=\""+i+"\">"+rdata[i].skName+"</option>";
			}
			$("#jinengzu").find("option").remove();
			var comboObj=$("#"+"jinengzu");
			comboObj.append(comboIdMap["jinengzu"]);
			rdata = data.data;
			skData=rdata;
		} else {
			alert("获取数据异常！");
		}
	});
}
function getUserInfoForSuiJi(maxNum,data){
	var n=parseInt(maxNum*Math.random());
	var retUserData=data[n];
	return retUserData;
}
//循环加载节点
var templateId="";
function openStepByNodeid(){
	templateId = $("#IndustryID").val();
	var pat={};
	var data=[];
	var rData="";
	var columnValues={};
	pat.columnValues=columnValues;
	pat.tableName="stepRecording";
	pat.columnValues.templateId=templateId;
	pat.equal="templateId";
	commonSelect(pat,true,function(data){
		if(data&&data.data){
			rData=data.data;
			if(rData.length<=0){
				$("#stepDesc").html('');
				$("#stepDescDiv").hide();
				$("#stepDesc").hide();
				return;
			}
			for(var i=0;i<rData.length;i++){
				//判断节点是否有设定执行人，有则不处理，没有则进行随机分配
				var t_cardUrl=rData[i].cardUrl;
				var t_RealName=rData[i].executor_name;
				if(t_RealName==undefined || t_RealName==""){
					//获取当前节点设定的范围中的人员数据
					var retData = getAllUserForZuZhiJiGouAndJueSeByNodeId(rData[i].id);
					
					//获取随机到人员数据
					var retUserData={};
					if(retData!=null && retData!=undefined && retData.length>0){
						retUserData=getUserInfoForSuiJi(retData.length,retData);
						t_cardUrl=retUserData.cardUrl;
						t_RealName=retUserData.RealName;
					}
				}
				$("#stepDesc").append('<div><div style="margin: 0;width:100%;">&nbsp;&nbsp;节点名称：'+rData[i].stepName+'</div><div class="zxr_div" id="executor_'+i+'" style="margin: 0;width:70%; min-height:10px; float:left;">&nbsp;&nbsp;执行人：'+t_RealName+'</div><div style="margin: 0;width:20%; float:left;"><a href="#" id="Id_'+i+'" onclick="openMmenu(this,&apos;#menu&apos;,function(){openNodeMmenu(&apos;'+rData[i].id+'&apos;,&apos;'+i+'&apos;);});">选择</a></div></div>'+'<br/>');
				var data={"workflow_id":"","cardUrl":t_cardUrl,"user_name":t_RealName,"role":"2","stepId":rData[i].id,"stepName":rData[i].stepName,"description":rData[i].description,"stepLogo":"node","staff_state":"待处理"};
				glData.push(data);
			}
			$("#stepDescDiv").show();
			$("#stepDesc").show();
		}
	});
}

//点击分类下拉列表触发的方法
function openCategory(){
	$("#stepDesc").html('');
   $("#IndustryID").find("option").remove();//清楚下拉列表数据
   fillCombo("IndustryID");
   //openCategoryDesc();
}


function getOrgAndUserList(){
	// 请求地址
	var url = "/"+PRJ_PATH+"/ZDesk/chatWorkflow" + "/"+ "getOrgAndUserList.action";
	var rData = {};
	ajaxFunction(url, "", false, function(data) {
		if (data && data.success) {
			rData = data.data;
						
		} else {
			alert(data.msg);
		}
	});
	return rData;
				
}
	
$(document).ready(function() {
	
    /**测试获取随机执行人
    var retData = getAllUserForZuZhiJiGouAndJueSeByNodeId("6C289303-1D57-11C9-05C2-76B4362A40BE");
    var dddd=getUserInfoForSuiJi(retData.length,retData);
    alert(dddd.RealName);
    */
    //getJueSeUserDataByNodeId("2");
    
    //getZuZhiUserDataByNodeId("2");

	searchCategory();
    
      //初始化文本编辑器
    ueditor=new baidu.editor.ui.Editor({
        //这里可以选择自己需要的工具按钮名称,此处没有选择
        toolbars:[],
        //focus时自动清空初始化时的内容
        autoClearinitialContent:true,
        //关闭字数统计
        wordCount:false,
        //关闭elementPath
        elementPathEnabled:false,
        autoHeightEnabled: false,//编辑器自动变高失效
        initialFrameWidth :"100%",//设置编辑器宽度
		initialFrameHeight:200//设置编辑器高度
		//initialContent:'请输入工作流描述',//初始化值
    });
    ueditor.render('workflow_describe');

      /*  $("searchForm").submit(function(e){
            e.preventDefault();
           // alert("表单阻止提交了");
        });
        */
        //getArgs();
        //chushihuaselect
        //fillCombo("focusArea");
        fillCombo("IndustryID");

       // loadMsg();
       
		/*
		 * 判断如有id传入 加载工作流数据到表单中 不可修改除节点执行人与参与人以外的数据。
		 */
		//加载数据
		if(curWrokflowId!=undefined && curWrokflowId!=""){
			$("#btnSearchForm1").hide();
			$("#btn_updataZhiXingRen").show();
			$("#div_info").show();
			initDataByWorkflowId();
		}
		       
       
		//保存触发的方法
		var check=false;
        $("#btnSearchForm1").click(function () {
        var bol=$("#searchForm").validate().form();
        if(check==true){return false;}
        check=true;
        if(bol){
			var chk_value =[];
			var check_invite="";
			var create_time=getTime();
			var workflow_name=$("#workflow_name").val();
			var workflow_describe=ueditor.getContent();
			var workflow_sort=$("#IndustryID").find("option:selected").text();
			var workflow_sort_describe=$("#categoryDesc").html();
			//2015-06-12调整
			//分类id
			var workflow_classify_id=$("#focusArea").val();
			//分类名称
			var workflow_classify=$("#focusArea").find("option:selected").text();$("#focusArea").val();
			//模板id
			var workflow_sort_id=$("#IndustryID").find("option:selected").text();
			//if($("#cUser").html()==0 && $("#zUser").html()==0){
			//	alert("请选择人员");
			//	return;
			//}
			$('input[name="check_invite"]:checked').each(function(){    
				chk_value.push($(this).val());    
			});
			if(chk_value.length==0){
				check_invite="否";
			}else {
				check_invite="是";
			}
			var data={};
			if(isPageForJNZ){
				//处理带技能组的数据
				var workflow_state="待处理";
				glData=[];
				data={"workflow_creater":"","workflow_name":workflow_name,"woow_chat_id":"WOOW","workflow_describe":workflow_describe,"workflow_sort":workflow_sort,"workflow_sort_describe":workflow_sort_describe,
						"check_invite":check_invite,"workflow_state":workflow_state,"create_time":create_time,"skId":skData[skDataI].id,"skName":skData[skDataI].skName,"skcode":skData[skDataI].skId,"skType":skData[skDataI].skType,
						"workflow_classify_id":workflow_classify_id,"workflow_classify":workflow_classify,"workflow_sort_id":workflow_sort_id};
			}else{
				var workflow_state="处理中";
				if(workflow_sort_describe==null || workflow_sort_describe=="" || workflow_sort_describe.length<=0){
				alert("必须选择模板");
				check=false;
				return;
				}
				var k=0;
				for(var i=0;i<$("div.zxr_div").length;i++){
					var text=$("div.zxr_div:eq("+i+")").text();
					if(text.length<=6||text==""){
						k++;
					}
				}
				if(k>0){
					check=false;
					alert("节点存在未选执行人，请选择！");
					return;
				}
				//处理不带技能组的数据
				data={"workflow_creater":loginName,"workflow_name":workflow_name,"woow_chat_id":"WOOW","workflow_describe":workflow_describe,"workflow_sort":workflow_sort,"workflow_sort_describe":workflow_sort_describe,
						"check_invite":check_invite,"workflow_state":workflow_state,"create_time":create_time,
						"workflow_classify_id":workflow_classify_id,"workflow_classify":workflow_classify,"workflow_sort_id":workflow_sort_id};
			}
			//保存数据
			insertWorkflow(data);
            }else{check=false;alert("工作流名称不能为空");}
        });

    var hasInsert=false;

        function insertWorkflow(data){
            if(!hasInsert){
                hasInsert=true;
            }else{
                alert("创建中，请稍后");
                return;
            }
        	var rdata="";
        	var pat={};
        	var columnValues={};
        	pat.tableName="Workflow_Table";
        	pat.columnValues=data;
        	pat.templateId = $("#IndustryID").val();
            var url = "/"+PRJ_PATH+"/ZDesk/MENHUWX" + "/creatWork"+ "/InsertWorkTable.action";
        	var columnValues=pat.columnValues;
			var newPat = $.extend(true,{},InsertSetting, pat);
			try{
				for(var i=0;i<retDatas.datas.length;i++){
					var x=0;
					for(var j=0;j<glData.length;j++){
					if(glData[j].cardUrl==retDatas.datas[i].cardUrl){
					  x++;
					  break;
					  }
					}
					if(x=0){
						var data={"workflow_id":"","cardUrl":retDatas.datas[i].cardUrl,
						"user_name":retDatas.datas[i].userName,"role":retDatas.datas[i].userRole};
						glData.push(data);
						}
				}
			}catch(e){
			}
			var gltype=$.type(glData);
			if(gltype=="array"){
	    		glData=JSON.stringify(glData);
			}else if(gltype=="object"){
	   		glData="["+JSON.stringify(glData)+"]";
			}else{
			check=false;
	   		alert("通用insert 方法-参数格式错误! columnValues应json格式");
	   		return ;
			}
			newPat.glData=glData;
			//判断pat 是否是数组对象
			var type=$.type(columnValues);
			if(type=="array"){
	    		newPat.columnValues=JSON.stringify(columnValues);
			}else if(type=="object"){
	   		newPat.columnValues="["+JSON.stringify(columnValues)+"]";
			}else{
			check=false;
	   		alert("通用insert 方法-参数格式错误! columnValues应json格式");
	   		return ;
			}
			ajaxFunction(url, newPat, true, function(data) {
				if (data.success==true) {
					rdata=data.idValues;
					alert(data.mgs);


					window.location.href="/NCard/IMKFService?ac=talkEnter&_t="+(new Date()).getTime()+"&woowId=WOOW"+rdata[0];
				} else {
					check=false;
					alert(data.mgs);
				}
                hasInsert=false;
			});
        }
});
//打开参与人的方法
function openMmenu111(th){
if(templateId==""){
	alert("请先选择模板");
	return;
}else{
	var d=ueditor.getContent();
	openMmenu(th,'#menu',function(){openCanYuMmenu(templateId);});
	//暂时解决选人后清空工作流描述bug的方法
	ueditor.addListener("ready", function () {        // ueditor准备好之后才可以使用        
		ueditor.setContent(d,false);
	});
}
}
/*
 * 打开节点对应的Mmenu数据
 */
function openNodeMmenu(nodeid,id){
	var parames={
		selectType : 'radio',					//选择类型  单选还是多选 值：radio 单选 multiselect 多选
		DS:[{
			"_dataTitle":"组织机构", 		//该数据的标题
			"_dataCode":"zzjg",				//该数据的唯一代码 可自由设定 切记不要设定重复
			datas:getZuZhiUserDataByNodeId(nodeid)		//设置此项的数据集 getOrgAndUserList()
		},{
			"_dataTitle":"角色", 		//该数据的标题
			"_dataCode":"js",				//该数据的唯一代码 可自由设定 切记不要设定重复
			datas:getJueSeUserDataByNodeId(nodeid)		//设置此项的数据集 getOrgAndUserList()
		}],
		fn:function(){	//设置返回值
			var cUser=0;
			var zUser=0;
            var retDatas1=getSelectDatas();	//获取选中的数据
            var i=$("#executor_"+id);
			//$("#user").val(JSON.stringify(retDatas));
			$("#executor_"+id).html("&nbsp;&nbsp;执行人："+retDatas1.datas[0].userName);
			var data=glData[id];
//			data["cardUrl"]=retDatas1.datas[0].uid;
            data["cardUrl"]=retDatas1.datas[0].cardUrl;
            data["user_name"]=retDatas1.datas[0].userName;
			glData[id]=data;
			var cUser=0;
			var zUser=0;
		}
	}
				
	var d=ueditor.getContent();	
	_initMMenu(parames);
	//暂时解决选人后清空工作流描述bug的方法
	ueditor.addListener("ready", function () {        // ueditor准备好之后才可以使用        
		ueditor.setContent(d,false);
	});
}
/*
 * 打开选择参与人的Mmenu数据
 */
 var retDatas="";
function openCanYuMmenu(templateid){
	var parames={
		selectType : 'multiselect',					//选择类型  单选还是多选 值：radio 单选 multiselect 多选
		DS:[{
			"_dataTitle":"组织机构", 		//该数据的标题
			"_dataCode":"zzjg",				//该数据的唯一代码 可自由设定 切记不要设定重复
			datas:getAllZuZhiUserDataByTempletId(templateid)		//设置此项的数据集 getOrgAndUserList()
		},{
			"_dataTitle":"角色", 		//该数据的标题
			"_dataCode":"js",				//该数据的唯一代码 可自由设定 切记不要设定重复
			datas:getAllJueSeUserDataByTempletId(templateid)		//设置此项的数据集 getOrgAndUserList()
		}],
		fn:function(){	//设置返回值
			var cUser=0;
			//var zUser=0;
			 retDatas=getSelectDatas();	//获取选中的数据
			// alert(JSON.stringify(retDatas));
			for(var i=0;i<retDatas.datas.length;i++){
				if(retDatas.datas[i].userRoleName=="参与"){
					cUser++;
				}//else {
				//	zUser++;
				//}
			}
			//$("#user").val(JSON.stringify(retDatas));
			$("#cUser").html(cUser);
			//$("#zUser").html(zUser);
			var cUser=0;
			//var zUser=0;
		}
	}
				
	_initMMenu(parames);
}
///*
// * 获取该模板下所有节点设置的组织范围用户数据
// */
//function getAllZuZhiUserDataByTempletId(templateid){
//	var rData={};
//	var params={};
//	params.templateid=templateid;
//	var url="/"+PRJ_PATH+"/ZDesk/MHWorkflow" + "/"+ "getMhZuZhiUserDataByTemplateId.action";
//	ajaxFunction(url, params, false, function(data) {
//		if (data && data.success==true) {
//			rData=data.data;
//			//alert(rData);
//		} else {
//			alert(data.mgs);
//		}
//	});
//
//	return rData;
//}
///*
// * 获取该模板下所有节点设置的角色范围用户数据
// */
//function getAllJueSeUserDataByTempletId(templateid){
//
//	var rData={};
//	var params={};
//	params.templateid=templateid;
//	var url="/"+PRJ_PATH+"/ZDesk/MHWorkflow" + "/"+ "getMhJueSeUserDataByTemplateId.action";
//	ajaxFunction(url, params, false, function(data) {
//		if (data && data.success==true) {
//			rData=data.data;
//			//alert(rData);
//		} else {
//			alert(data.mgs);
//		}
//	});
//
//	return rData;
//}
///*
// * 通过节点id 查询该节点所设定的组织人员范围数据
// */
function getZuZhiUserDataByNodeId(nodeid){
	var rData={};
	var params={};
	params.stepId=nodeid;
	var url="/"+PRJ_PATH+"/ZDesk/MHWorkflow" + "/"+ "getMhZuZhiUserData.action";
	ajaxFunction(url, params, false, function(data) {
		if (data && data.success==true) {
			rData=data.data;
			//alert(rData);
		} else {
			alert(data.mgs);
		}
	});

	return rData;
}
/*
 * 通过节点id 查询该节点所设定的角色人员范围数据
 */
function getJueSeUserDataByNodeId(nodeid){
	var rData={};
	var params={};
	params.stepId=nodeid;
	var url="/"+PRJ_PATH+"/ZDesk/MHWorkflow" + "/"+ "getMhJueSeUserData.action";
	ajaxFunction(url, params, false, function(data) {
		if (data && data.success==true) {
			rData=data.data;
			//alert(rData);
		} else {
			alert(data.mgs);
		}
	});
	
	return rData;
}
/*
 * 根据模板id 获取所有组织机构与角色下的人员数据
 */
function getAllUserForZuZhiJiGouAndJueSeByNodeId(nodeid){
	//获取该节点所设定范围的用户数据
	var uzz=getZuZhiUserDataByNodeId(nodeid);
	var ujs=getJueSeUserDataByNodeId(nodeid);
	
 	//记录用户数据
	var ret={
 		datas:[]
 	};
 		
	//组织该节点的用户数据  将组织机构和角色的人员组织到一起 方便随机分配人员
	if(uzz!=null && uzz!=undefined){
		$.each(uzz, function (id, data){
			if(data.users!=undefined && data.users!=null){
				for(var o=0;o<data.users.length;o++){
					
					var d={};
					d.cardUrl=data.users[o].cardUrl;
					d.dataType=data.users[o].dataType;
					d.gender=data.users[o].gender;
					d.id=data.users[o].id;
					d.org=data.users[o].org;
					d.phone_number=data.users[o].phone_number;
					d.RealName=data.users[o].RealName;
					d.role=data.users[o].role;
					d.text=data.users[o].text;
					ret["datas"].push(d);
				}
			}
		});
	}
	
	if(ujs!=null && ujs!=undefined){
		$.each(ujs, function (id, data){
			if(data.users!=undefined && data.users!=null){
				for(var o=0;o<data.users.length;o++){
					var d={};
					d.cardUrl=data.users[o].cardUrl==undefined?data.users[o].id:data.users[o].cardUrl;
					d.dataType=data.users[o].dataType==undefined?"":data.users[o].dataType;
					d.gender=data.users[o].gender==undefined?"男":data.users[o].gender;
					d.id=data.users[o].id==undefined?"":data.users[o].id;
					d.org=data.users[o].org==undefined?"":data.users[o].org;
					d.phone_number=data.users[o].phone_number==undefined?"":data.users[o].phone_number;
					d.RealName=data.users[o].RealName==undefined?data.users[o].text:data.users[o].RealName;
					d.role=data.users[o].role==undefined?"":data.users[o].role;
					d.text=data.users[o].text==undefined?"":data.users[o].text;
					
					ret["datas"].push(d);
				}
			}
		});
	}
	//去除重复数据
	var reData = []; //一个新的临时数组
	
	if(ret["count"]!=0 && ret!=undefined){
		var temp=ret["datas"];//临时存储
		if(temp!=null && temp!=undefined){
			temp.sort();
			var temp_cardUrl="";
      		for(i = 0; i < temp.length; i++) {
        		if(temp[i].cardUrl == temp_cardUrl) {
        	   		continue;
        		}
      			temp_cardUrl=temp[i].cardUrl;
          		reData[reData.length]=ret["datas"][i];
      		}
			
		}
	}
	return reData;
	
}
//根据传入的id进行获取数据并加载到表单中
function initDataByWorkflowId(){
	var pat={};
	if(curWrokflowId!=undefined && curWrokflowId!=""){
		var columnValues={};
		pat.columnValues=columnValues;	
		pat.tableName = "Workflow_Table";
		pat.columnValues.id=curWrokflowId;
		pat.equal="id";
		commonSelect(pat,true,function(data){
			if(data&&data.data){	
				initDataToForm(data.data);				
			}
		});
	}
}
//加载数据到表单中
function initDataToForm(data){
	if(data!=null && data!=undefined){
		if(data.length==1){
			//给分类赋值
			$("#focusArea").find("option").remove();
			$("#focusArea").html("<option value=\""+data[0].workflow_classify_id+"\">"+data[0].workflow_classify+"</option>");
			//给模板赋值
			$("#IndustryID").find("option").remove();
			$("#IndustryID").html("<option value=\""+data[0].workflow_sort_id+"\">"+data[0].workflow_sort+"</option>");
			//给技能组赋值
			$("#jinengzu").find("option").remove();
			$("#jinengzu").html("<option value=\""+data[0].skId+"\">"+data[0].skName+"</option>");
			//给工作流名称赋值
			$("#workflow_name").val(data[0].workflow_name);
			//给工作流描述赋值
			ueditor.addListener("ready", function () {        // ueditor准备好之后才可以使用        
				ueditor.setContent(data[0].workflow_describe,false);
			});
			
			//加载模板描述与节点信息	
			var templateData=getTemplateDataById();
			initTemplageDesc(templateData);
		}
	}else{
		alert("非法操作数据！");
	}
}
//技能组数据  正式发起工作流时处理各节点执行人 与参与人数据
function submit_updata(){	
	var nodeZhiXingData=glData;//各节点执行人数据
	var selectCanYuData=retDatas;//选定的参与人数据
	
	//筛选掉参与人数据中已经是执行人的人员数据
	var reCanYuData=filterCanYuData(nodeZhiXingData,selectCanYuData);//过滤后的参与人员数据
	
	//组装批量存入工作流与人员关联表中的数据
	var allPeopleData=assembleAllPeopleData(nodeZhiXingData,reCanYuData);
	
	//进行更新工作流数据的状态以及是否可邀请  此处使用同步，执行成功后方可存储关联表数据 未成功时不存储  保证不要有垃圾数据进入关联表中
	var chk_value2 =[];
	var check_invite2="";
	$('input[name="check_invite"]:checked').each(function(){    
		chk_value2.push($(this).val());    
	});
	if(chk_value2.length==0){	
		check_invite2="否";
	}else {
		check_invite2="是";
	}
	var params = {};
	params.tableName="Workflow_Table";
	params.columnValues={"workflow_state":"处理中","check_invite":check_invite2,"id":curWrokflowId};
	commonUpdate (params,false,function(data){
		if(!data.success){
			return;
		}
    });
	
	
	
	//进行数据存储工作流与人员关联表数据
	var params2 = {};
	params2.tableName="Workflow_Relation_Table";
	params2.columnValues=allPeopleData;
	commonInsertOrUpdate(params2,true,function(data){
		if(data.success){
			alert("保存成功！");
			window.location.href="/NCard/IMKFService?ac=talkEnter&_t="+(new Date()).getTime()+"&woowId=WOOW"+curWrokflowId;
		}else{
			alert("保存出现异常，请稍后重试！");
		}
    });
		
}
//过滤掉选中的参与人中已是节点执行人的人员数据
function filterCanYuData(zData,cData){
	reCanYuData=[];
	if(cData!=undefined && cData!="" && cData.datas!=undefined && cData.datas!=null){
	
		for(var i=0;i<cData.datas.length;i++){
			for(var j=0;j<zData.length;j++){
				if(cData.datas[i].cardUrl!=zData[j].cardUrl){
					reCanYuData.push(cData.datas[i]);
				}
			}
		}
	}
	return reCanYuData;
}
//组装批量存入工作流与人员关联表中的数据 进行数据存储
function assembleAllPeopleData(nodeZhiXingData,reCanYuData){
	var allPeopleData=[];
	if(nodeZhiXingData!=undefined && nodeZhiXingData!=null ){
		for(var i=0;i<nodeZhiXingData!=null && i<nodeZhiXingData.length;i++){
			var pat={};
			pat.workflow_id=curWrokflowId;//工作流id
			pat.stepId=nodeZhiXingData[i].stepId;//节点id
			pat.stepName=nodeZhiXingData[i].stepName;//节点名称
			pat.description=nodeZhiXingData[i].description;//节点描述
			pat.cardUrl=nodeZhiXingData[i].cardUrl==undefined ? "" : nodeZhiXingData[i].cardUrl;//执行人唯一标识
			pat.user_name=nodeZhiXingData[i].user_name;//执行人姓名
			pat.role=nodeZhiXingData[i].role;//执行人角色
			pat.staff_state="处理中";//当前执行人状态
			pat.stepLogo=nodeZhiXingData[i].stepLogo;
			
			allPeopleData.push(pat);
		}
	}
	//存入参与人
	if(reCanYuData!=undefined && reCanYuData!=null ){
		for(var i=0;i<reCanYuData!=null && i<reCanYuData.length;i++){
			var pat2={};
			pat2.workflow_id=curWrokflowId;//工作流id
			pat2.cardUrl=reCanYuData[i].cardUrl==undefined ? "" : reCanYuData[i].cardUrl;//执行人唯一标识
			pat2.user_name=reCanYuData[i].userName;//执行人姓名
			pat2.role=reCanYuData[i].userRole;//执行人角色
			
			allPeopleData.push(pat2);
		}
	}
	return allPeopleData;
}
</script>
	</body>
</html>
