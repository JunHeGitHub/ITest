<!DOCTYPE html>
<html lang="en">

	<head>
		<title>模块权限</title>

		<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
		<meta http-equiv="description" content="this is my page">
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">

		<!--<link rel="stylesheet" type="text/css" href="./styles.css">-->
		<link rel="stylesheet" href="../../css/bootstrap.min.css" type="text/css"></link>
		<link rel="stylesheet" href="../../css/bootstrap-responsive.min.css" type="text/css"></link>
		<link rel="stylesheet" href="../../js/dataTables/css/DT_bootstrap.css" type="text/css"></link>
		<link rel="stylesheet"href="../../js/dataTables/css/jquery.dataTables.css" type="text/css"></link>
		<link rel="stylesheet" href="../../js/dataTables/css/font-awesome.css"></link>	
		<script type="text/javascript" src="../../js/jquery.js"></script>
		<script type="text/javascript" src="../../js/bootstrap.js"></script>
		<script type="text/javascript" src="../../js/common_utils.js"></script>
		<script type="text/javascript" src="../../js/dataTables/js/jquery.dataTables.js"></script>
		<script type="text/javascript" src="../../js/dataTables/js/dataTables.tableTools.min.js"></script>
		<script type="text/javascript" src="../../js/dataTables/js/DT_bootstrap.js"></script>
		<script type="text/javascript"  src="../../js/appCommonUtil.js"></script>
		<script type="text/javascript" src="../../js/appCommonCurdUtils_new.js"></script></head>
<style type="text/css">
	
	    tr td:first-child {
	        text-align: center;
	    }
	    tr td:first-child:before {
	        content: "\f096"; 
	        font-family: FontAwesome;
	    }
	    td{text-align: center;}
	    tr.active td:first-child:before {
	        content: "\f046"; /* fa-check-square-o */
	    }
	    
	    .title_center{
	      algin:center;
	    }
	   
	</style>
<script type="text/javascript">
	   var ZKM_ROU="ZKM";
	   var table=false;
		//权限集合
	   var permissonArray=[];
	   var isSelect=[];
	   var PRJ_PATH=window.top.PRJ_PATH||"ZDesk";
	   var ZDesk_ROU=window.top.ZDesk_ROU||"ZDesk";
	   $(document).ready(function(){
	   
	        getBasePermissonByRole();

		   	table=$('#tt').DataTable({
		        bPaginate: false, //翻页功能
				bLengthChange: false, //改变每页显示数据数量
				bFilter: false, //过滤功能
				bSort: true, //排序功能
				bInfo: false,//页脚信息
				bAutoWidth: true, //自动宽度
			    dom: 'Tlrtip',
				columns: [
					{
					 title:"",
                     data: null, 
                     defaultContent:'', 
                     orderable: false ,
					 width:"20px"
					},
			        {
			        // title:"<center>分类权限</center>",
			         data:'categoryName',
			         width:"100px"
			         //className: "title_center" 
	                }    
		        ],
		        oLanguage: {
					"sLengthMenu": "每页显示 _MENU_条",
					"sZeroRecords": "没有找到符合条件的数据",
					"sProcessing": "&lt;imgsrc=’./loading.gif’ /&gt;",
					"sInfo": "当前第 _START_ - _END_ 条　共计 _TOTAL_ 条",
					"sInfoEmpty": "没有记录",
					"sInfoFiltered": "(从 _MAX_ 条记录中过滤)",
					"sSearch": "搜索：",
					"oPaginate": {
								"sFirst": "首页",
								"sPrevious": "前一页",
								"sNext": "后一页",
								"sLast": "尾页"
					        }
		        }, tableTools: {
		             fnRowSelected: function ( nodes ) {
		              // var index=nodes[0]._DT_RowIndex;	
		              // var data = table.row(index).data();
		              // initForm(data);
		            },
		            sRowSelect:'multi',
		            aButtons:[]
		        },createdRow: function( row, data, dataIndex ) {
				      for(var i=0;i<permissonArray.length;i++){
				            if(permissonArray[i].categoryId==data.id){
				              // $(row).addClass( 'active' );
				              isSelect.push(dataIndex);
				              // selectRow(dataIndex);
				               break;
				            }
				          
				      }
				 } 
		   });
		    //$('#tt').width( $(".scrolltable").width() );
		    
		   //var data=getSuSecurityPermissionInfo("base");
		   var data = getCategory();
	       table.rows.add(data).draw(true);
	       //勾选已有权限
	       selectRow();
	   });
//获取分类表中所有数据
	function getCategory(){
		var pat={};
		var rdata=[];
		var columnValues={};
		pat.columnValues=columnValues;	
		pat.tableName = "wx_category";
		pat.columnValues.isDelete="已启用";
		pat.equal="isDelete";
		pat.isPagination=false;
		commonSelect(pat,false,function(data){
			if(data&&data.data){	
				rdata=data.data;
			}
		});
		return rdata;
	}
           
    function  getParams(){
	    var selectData=table.rows(".active").data();
	    var params=window.parent.getRoleCodeAndType();//角色名称
	    var roleCode=params.roleCode;
	    pCodesp=[];
	    for(var i=0;i<selectData.length;i++){
	       var sd=selectData[i];
	       pCodesp.push({"roleCode":roleCode,"categoryId":sd.id});
	    }
        return $.extend(params,pCodesp);
    } 
    //授权
    function addPermissonMapRole(){
      var params=getParams();
      var a=params.pCodesp;
      if(params.roleCode==undefined||params.roleCode==null||params.roleCode==""){
           //alert("请选择角色");
            window.parent.zinglabs.i18n.alert("permission_role");
           return ;
      }
      roleCode=params.roleCode;
      deleteCategory(pCodesp);//先清除该角色已有分类权限
    } 
    //清除该角色已有分类权限
    function deleteCategory(pCodesp){
    	var params={"roleCode":roleCode};
    	var url="/"+window.top.PRJ_PATH+"/"+ZKM_ROU+"/"+"RA"+"/"+"deleteCategory.action";
    	ajaxFunction(url,params,false,function(data){
			if(data&&data.success){
				var pat={};
				var columnValues={};
				pat.tableName="wx_categoryPrivilege";
				pat.columnValues=pCodesp;
				if(pat.columnValues==null||pat.columnValues.length<=0){
					window.parent.zinglabs.i18n.alert("permission_success");
					return;
				}
				//pat.primarykeyType="uuid";
				commonInsertOrUpdate(pat,false,function(data){
		    	if(data.success==true){
		    		window.parent.zinglabs.i18n.alert("permission_success");
		    		}
		   		});
           }else{
               window.parent.zinglabs.alert(data.mgs);
           }
      });
    }
    // 获取角色 根据角色id
     function getBasePermissonByRole(){
          var params=window.parent.getRoleCodeAndType();
	      if(params.roleCode==undefined||params.roleCode==null||params.roleCode==""){
	           zinglabs.i18n.alert("permission_role");
	           return ;
	      }
         // var url="/"+PRJ_PATH+"/"+ZDesk_ROU+"/permissonMappingRole/getPermissonCode.action";
	     // ajaxFunction(url,params,false,function(data){
	      //     if(data&&data.success){
	     //          permissonArray=data.data;
	      //         zinglabs.alert(JSON.stringify(permissonArray));
	      //         return true;
	        //   }else{
	        //        window.parent.zinglabs.alert(data.mgs);
	          // }
	     // });
	     var params=window.parent.getRoleCodeAndType();
	      var pat={};
	      var rdata=[];
	      var columnValues={};
	      pat.tableName = "wx_categoryPrivilege";
	      pat.columnValues=params;
	      pat.equal="roleCode";
	      pat.isPagination=false;
	      pat.columns="categoryId";
	      commonSelect(pat,false,function(data){					
				if(data&&data.data){	
					permissonArray=data.data;
					return true;
				}else{
	               window.parent.zinglabs.alert(data.mgs);
	            }
		  });
         return false;  
      }   
      
      function selectRow(){
         var oTT = TableTools.fnGetInstance('tt');
         var length=isSelect.length;
          if(length>=0){
	            for(var i=0;i<length;i++){
	              var index=isSelect[i];
	              oTT.fnSelect( $('#tt tbody tr')[index]);
	            }
            
           } 
      } 
		</script>


	<body> 
		 <div class="row-fluid">
		     <button type="button" class="btn btn-primary"  onclick="addPermissonMapRole()">授权</button>
		 </div>
		   <div class="row-fluid">
		     <div class="span3">
			  <table id="tt"  width="350px" class="table table-striped table-bordered" cellspacing="0">
		             <thead>
		               <tr><th></th><th>模块名称</th></tr>
		             </thead>
			  </table>
			 </div>  
		  </div>
	</body>
</html>
