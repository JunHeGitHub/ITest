<!DOCTYPE  HTML>
<html>
	<head>
		<title>模板授权</title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<link rel="stylesheet" href="../../css/bootstrap.min.css" type="text/css" />
		<link rel="stylesheet" href="../../js/bootstrap-datetimepicker/css/bootstrap-datetimepicker.css" type="text/css"></link>
		<link rel="stylesheet" href="../../js/dataTables/css/jquery.dataTables.css" type="text/css" />
		<!--[if lt IE 9]>
		<script type="text/javascript" src="../../../js/html5shiv.min.js"></script>
		<![endif]-->
		<link rel="stylesheet" href="../../js/dataTables/css/DT_bootstrap.css" type="text/css" />
		<link rel="stylesheet" href="../../js/dataTables/css/dataTables.tableTools.min.css" type="text/css" />
		<!-- ZDesk 通用css  -->
		<link rel="stylesheet" href="../../css/zinglabs.css" type="text/css" />
		<link rel="stylesheet" href="../../js/dataTables/css/font-awesome.css" />
		<link rel="stylesheet" href="../../js/dataTables/css/dataTables.colVis.min.css" type="text/css" />
		<script type="text/javascript" src="../../js/jquery.js"></script>
		<script type="text/javascript" src="../../js/bootstrap.js"></script>
		<script type="text/javascript" src="../../js/dataTables/js/jquery.dataTables.js"></script>
		<script type="text/javascript" src="../../js/dataTables/js/dataTables.colReorder.js"></script>
		<script type="text/javascript" src="../../js/dataTables/js/dataTables.colVis.js"></script>
		<script type="text/javascript" src="../../js/dataTables/js/dataTables.tableTools.min.js"></script>
		<script type="text/javascript" src="../../js/common_utils.js"></script>
		<script type="text/javascript" src="../../js/appCommonUtil.js"></script>
		<script type="text/javascript" src="../../js/appCommonCurdUtils_new.js"></script>
		<script type="text/javascript" src="../../js/dataTables/js/DT_bootstrap.js"></script>
		<script type="text/javascript" src="../../js/My97DatePicker/WdatePicker.js"></script>
		<script type="text/javascript" src="../../js/log2.js"></script>
		<script type="text/javascript" src="../../js/golbal_params.js"></script></head>
		<!-- 遮罩产插件 -->
		<script type="text/javascript" src="../../js/jquery.blockUI.js"></script>
		<!-- 验证及提示组件 -->
		<script type="text/javascript" src="../../js/jqueryValidate/jquery.validate.js"></script>
		
<style type="text/css">

/*临时解决datatable单元格变形问题  为保证宽度不变，ie兼容模式显示效果为换行 其它浏览器省略号 需要通过只显示部分原文解决此问题*/
.dataTable th,.dataTable td {
	width: 120px;
	max-width: 120px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}
</style>

<script type="text/javascript">

	//遮罩属性		
	var maskContent = {
		css : {
			border : 'none',
			padding : '15px',
			backgroundColor : '#000',
			'-webkit-border-radius' : '10px',
			'-moz-border-radius' : '10px',
			opacity : .5,
			color : '#fff',
			font : '14px'
		},
		message : '<img src="../../img/wait.gif" border="0" />  正在加载中，请稍候...'
	};
	var roleTable = false;
	var roleCode = "";
	var tab_type = "";
	var rowSelTr = false;
	var rdata=[{"DT_RowNumber":"1","roleCode":"expert","roleName":"专家"},{"DT_RowNumber":"2","roleCode":"agent","roleName":"客服"},{"DT_RowNumber":"3","roleCode":"employee","roleName":"员工"},{"DT_RowNumber":"4","roleCode":"MHadmin","roleName":"管理员"}];
	$(document).ready(function() {
		//$.blockUI(maskContent);
		var table = $('#roleList').DataTable({
			//滚动条
			//scrollY: 500,
			//scrollX: false,
			//延迟加载
			deferRender : true,
			processing : false,
			//开启服务端分页
			serverSide : false,
			//服务器端分页ajax请求 可抽离出一个方法
			//ajax : doSearch,
			data:rdata,
			pagingType : "full_numbers",
			pageLength : 10,
			bPaginate : true, //翻页功能
			bLengthChange : true, //改变每页显示数据数量
			bFilter : true, //过滤功能
			bSort : true, //排序功能
			bInfo : true,//页脚信息
			bAutoWidth : false, //自动宽度
			sPaginationType : "bootstrap",//分页样式
			dom : 'TRlrtip',
			columns : [ {
				title : "序号",
				data : "DT_RowNumber",
				defaultContent : '',
				width : '3%',
				orderable : false
			}, {
				title : "角色名称",
				data : 'roleName',
				visible : true
			}, {
				title : "id",
				data : "roleCode",
				visible : false
			} ],
			columnDefs : [ {
				"searchable" : false,
				"orderable" : false,
				"targets" : 0
			} ],
			oLanguage : {
				infoFiltered : function() {
				},
				"sLengthMenu" : "每页显示 _MENU_条",
				"sZeroRecords" : "没有找到符合条件的数据",
				"sProcessing" : "&lt;imgsrc=’./loading.gif’ /&gt;",
				"sInfo" : "当前第 _START_ - _END_ 条　共计 _TOTAL_ 条",
				"sInfoEmpty" : "没有记录",
				"sInfoFiltered" : "(从 _MAX_ 条记录中过滤)",
				"sSearch" : "搜索：",
				"oPaginate" : {
					"sFirst" : "首页",
					"sPrevious" : "前一页",
					"sNext" : "后一页",
					"sLast" : "尾页"
				}
			},
			tableTools : {
				fnRowSelected : function(nodes) {
					var index = nodes[0]._DT_RowIndex;
					rowSelTr = index;
					var data = table.row(index).data();
					orgCode = data.roleCode;
					var contsrc = $('#content').attr('src');
					if (contsrc != "" && contsrc != undefined && contsrc != null) {
						$('#content').attr('src', contsrc);
					}
				},
				sRowSelect : 'single',
				aButtons : []
			}
		});

		//自定义列插件绑定
		//绑定事件 on
		table = $('#roleList').DataTable();
		roleTable = table;
		/* table.on( 'order.dt search.dt', function () {
		     table.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
		         cell.innerHTML = i+1;
		     } );
		 } ).draw(true);*/
		$.unblockUI();
	});
	/*
	 筛选
	 */
	function tableSearch() {
		var table = $('#roleList').DataTable();
		table.draw(true);
	}
	function doSearch(data, callback, settings) {
		var params = spellSelectParams("searchDataForm");
		var url = "/" + window.top.PRJ_PATH + "/ZDesk" + "/Step"+ "/selectMHRole.action";
		params.offset = settings._iDisplayStart;
		$.blockUI(maskContent);
		ajaxFunction(url, params, false, function(data) {
			try {
				if (data && data.data) {
					var pdata = {};
					var datas=[];
					var size = data.data.length;
					var total=0;
					for (var i = 0; i < size; i++) {
					    var x=0;
						if(data.data[i].roleCode=="expert"){
							total++;
							data.data[i].roleName="专家"
							data.data[i].DT_RowNumber = total;
						    x++; 
						}else if (data.data[i].roleCode=="employee"){
							total++;
							data.data[i].roleName="员工"
							data.data[i].DT_RowNumber = total;
							x++;
						}else if(data.data[i].roleCode=="agent"){
							total++;
							data.data[i].roleName="客服"
							data.data[i].DT_RowNumber = total;
							x++;
						}else if(data.data[i].roleCode=="MHadmin"){
							total++;
							data.data[i].roleName="系统管理员"
							data.data[i].DT_RowNumber = total;
							x++;
						}
						if(x!=0){
							datas[(total-1)]=data.data[i];
							x=0;
						}
					}
					//数据
					pdata.data = datas;
					//总条数
					pdata.recordsTotal = total || 0;
					//过滤没有使用到总条数
					pdata.recordsFiltered = total || 0;
					// 代表第几次画页面  如pdata.draw 不能删 如删掉不会翻页  
					pdata.draw = settings.iDraw;
					callback(pdata);
				}
			} catch (ex) {
				logErr("查询失败 failed " + ex.text + ": " + ex.message);
			}
			$.unblockUI();
		});
	};

	/**function doSearch(data, callback, settings) {
		var params = spellSelectParams("searchDataForm");
		params.tableName = "commonTree_detail";
		params.columnValues.recordType = "org";
		params.equal = "recordType";
		params.columns = "text,id";
		params.rows = settings._iDisplayLength;
		params.offset = settings._iDisplayStart;
		$.blockUI(maskContent);
		commonSelect(params, true, function(data) {
			try {
				if (data && data.data) {
					var pdata = {};
					var size = data.data.length;
					for (var i = 0; i < size; i++) {
						data.data[i].DT_RowNumber = i + 1;
					}
					//数据
					pdata.data = data.data;
					//总条数
					pdata.recordsTotal = data.total || 0;
					//过滤没有使用到总条数
					pdata.recordsFiltered = data.total || 0;
					// 代表第几次画页面  如pdata.draw 不能删 如删掉不会翻页  
					pdata.draw = settings.iDraw;
					callback(pdata);
				}
			} catch (ex) {
				logErr("查询失败 failed " + ex.text + ": " + ex.message);
			}
			$.unblockUI();
		});
	};*/
	/***
	 * 必须处理的严重错误，测试阶段可以alert 生产环境特殊标识写入日志
	 * 发现就要分析原因
	 * @param err
	 */
	function logErr(errMsg) {
		log.debug(errMsg);
	};

	/**
	 导航切换
	 **/
	function navigate(obj, src, type) {
		var selectData = roleTable.rows(".active").data();
		if (selectData.length <= 0) {
			//alert("请选择组织机构！");
			zinglabs.i18n.alert("role_selectOneData");
			return;
		}
		//var  tabMenu =$(obj).parent();
		// $(tabMenu).siblings().each(function(){
		//$(this).removeClass("active");
		//});
		//$(tabMenu).addClass("active");
		//$('#content').attr('src',src);
		tab_type = type;
		var n_title = "";
		var width = "";
		var height = "";
		switch (type) {
		case 'base':
			n_title = "模板权限";
			width = "600";
			height = "400";
			break;
		default:
			return;
		}
		var dig = dialog({
			title : '模板授权>' + n_title,
			content : '<iframe src='
					+ src
					+ ' style="border: 0; width: 100%; height: 100%;"  frameborder="0"/>',
			width : width,
			height : height
		});
		dig.show();
	}
	function getRoleCodeAndType() {
		return {
			"roleCode" : orgCode,
		//"type":tab_type
		}
	}
	function cleanSearchForm() {
		$("#searchDataForm")[0].reset();
	}
</script>
	<body>
		<!-- 容器 -->
		<div class="z_container"  style="max-width: 100%;min-width: 1000px;">
			<!-- datatable部分 包含筛选项 -->
			<div class="head">
				<!-- dataTable筛选项部分 -->
				<div class="widget-box collapsible">
					<!-- <div class="widget-title">
						<span class="icon"> <i class="icon-search"></i> </span>
						<h5>
							配置项搜索
						</h5>
						<div class="buttons">
							<button class="btn btn-mini" onclick="	jQuery.fx.off = false;$('#collapseOne').slideToggle(200);">
								<i class="icon-retweet"></i>展开/关闭
							</button>
						</div>
					</div> -->
					<div class="collapse in" id="collapseOne">
						<!--TODO 里面写查询项表单布局 -->
						<!-- <div class="widget-content container">
							<form action="" id="searchDataForm">
								<div class="row" style="margin-left: -150px">
									<div class="span4">
										<div class="form-horizontal">
											<!-- 日期 布局会遮住后面选择日期的按钮  临时同减小input宽度解决 
											<div class="control-group">
												<label class="control-label" for="generateTimetimebegin">
													组织机构名称:
												</label>
												<div class="controls">
														<input type="text" style="width: 179px" id="name" name="name">
												</div>
											</div>
										</div>
									</div>
									<div class="span4 offset1">
										<button type="button" id="btn_search" class="btn" onclick="tableSearch()">
												<i class="icon-search"></i> 搜索
											</button>
											<button type="button" id="btn_clean" class="btn" onclick="cleanSearchForm()">
												<i class="icon-remove"></i> 清空
											</button>
									</div>
								</div>
							</form>
						</div>
					</div> -->
				</div>
				<!-- dataTable 部分 -->
				<div class="widget-box">
					<div class="widget-title">
						<span class="icon"> <i class="icon-th"></i> </span>
						<h5>
							模板授权
						</h5>
						<!--TODO 里面可加一些按钮 -->
						<div class="buttons">
							<button class="btn btn-mini btn-primary" onclick="navigate(this,'categoryPermissions.html','base')">
								模板授权
							</button>
						</div>
					</div>
					<div class="widget-content nopadding">
						<table id="roleList" class="table table-striped table-bordered nowrap"></table>
					</div>
				</div>
			</div>
		</div>
	</body>		
</html>
