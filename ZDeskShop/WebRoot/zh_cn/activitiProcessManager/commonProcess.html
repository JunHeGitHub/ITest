<!DOCTYPE  HTML>
<html>
	<head>
		<title>commonProcess.html</title>

		<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
		<meta http-equiv="description" content="this is my page">
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
		<link rel="stylesheet" href="../../css/bootstrap.min.css"
			type="text/css"></link>
		<link rel="stylesheet"
			href="../../js/dataTables/css/jquery.dataTables.css" type="text/css"></link>
		<!-- bootstrap 与 datatable结合 -->
		<link rel="stylesheet" href="../../js/dataTables/css/DT_bootstrap.css"
			type="text/css"></link>
		<!-- 工具 -->
		<link rel="stylesheet"
			href="../../js/dataTables/css/dataTables.tableTools.min.css"
			type="text/css"></link>
		<!-- 动态列CSS -->
		<link rel="stylesheet" href="../../js/dataTables/css/font-awesome.css"></link>
		<link rel="stylesheet"
			href="../../js/dataTables/css/dataTables.colVis.min.css"
			type="text/css"></link>
		<style type="text/css">
			body{
				line-height:0px!important;
			}
			.row {
				padding-top: -3px;
				margin-bottom: -10px;
				display: table;
			}
			.dataTables_scrollBody{
				 overflow-x : hidden!important ;
			}
		</style>
	</head>

	<body>
		<div style="width: 920px; margin-left: 3px; padding: 2px"
			cellspacing="0">
			<div class="widget-box collapsible" style="width: 920px; margin-bottom:0px">
				<div class="widget-title" style="height: 40px;">
					<span class="icon"><i class="icon-th"></i> </span>
					<div id="cols"></div>
					<div style="padding-top: 5px; margin-left: 45px">
						<button type="button" id="btn_create" class="btn"
							onclick="doOpenNew();">
							<i class="icon-repeat"></i> 新 建
						</button>
						<button type="button" id="btn_add" class="btn"
							onclick="doRepeat();">
							<i class="icon-repeat"></i> 刷 新
						</button>
						<button type="button" id="btn_getWait" class="btn getTheToDoTask" style="">
							<i class="icon-search"></i> 获取待办
						</button>
					</div>
				</div>
			</div>
			<div
				style="width: 920px; border: solid; border-right-color: rgb(205, 205, 205); border-width: 1px; border-left-color: rgb(205, 205, 205); border-left-width: 1px; border-right-width: 1px; border-top-color: rgb(205, 205, 205);border-top-width: 1px">
				<div
					style="margin-left: auto; margin-right: auto;background-color: #fff;">
					<table
						class="table table-striped table-bordered table-hover datatable" data-resizable-columns-id="demo-table"
						id="activitibody"cellspacing="0">
					</table>

				</div>
			</div>
		</div>
		<div id="ToDoTaskModel" class='container-fluid modal hide'
			style='padding: 0px; width: 800px;' role="dialog"
			aria-labelledby="myModalLabel" aria-hidden="true">
			<table style="overflow-x: hidden"
				class="dataTables_wrapper form-inline no-footer" id="ToDoTaskModelBody"
				cellspacing="0"></table>
			<div>
				<button type="button" id="btn_add" class="btn doReceive">
					<i class="icon-repeat"></i>领 取
				</button>
			</div>
		</div>


		<div id="iframePageDiv"
			style="margin-left: 3px; padding: 2px;">
			<iframe frameborder="0" src="" id="iframePage" scrolling="no"
				style="border: 0;width:925px;height:0px"></iframe>
		</div>
</body>
		<script type="text/javascript" src="../../js/jquery.js"></script>
		<script type="text/javascript" src="../../js/bootstrap.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/jquery.dataTables.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.colReorder.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.colVis.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.tableTools.min.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/DT_bootstrap.js"></script>
		<script type="text/javascript" src="../../js/common_utils.js"></script>
		<script type="text/javascript" src="../../js/appCommonUtil.js"></script>
		<script type="text/javascript"
			src="../../js/appCommonCurdUtils_new.js"></script>
		<script type="text/javascript" src="../../js/golbal_params.js"></script>
		<script type="text/javascript" src="../../js/common_validation.js"></script>
		<script type="text/javascript"
			src="../activitiModelsManager/activiti.js"></script>
		<!--<link rel="stylesheet" type="text/css" href="./styles.css">-->
		<script>
var dataGrid = {} ;  //datatable 初始化参数
var ToDodataGrid = {} ;  //datatable 初始化待办参数
var PRJ_PATH = window.top.PRJ_PATH||"ZDesk";
//主服务器模块
var ZDesk_ROU = window.top.ZDesk_ROU||"ZDesk";
var getActivitiTasksUrl = "";  //获取流程数据action路径
var PROCESSDEFINTION_ID = "" ;  //流程标识
var activitiParameterAndData ;  //流程配置和获取来的流程数据
var A_TASKNAME="";  //节点名称(-获取待办)
var A_FORMCLASS=""; //表单类
var IFRAMEPAGEHEIGHT = "" ; //表单高度
var companyId="" ;
var companyName ="" ;
dataGrid ={
	'bPaginate':true,//分页器
	'bLengthChange': false,
	'bStateSave':true, //保留状态
	'bSort':false,//按列排序
	'bInfo':true,//页脚信息
	// 开启服务端分页
	 serverSide: true,
	 ajax : FYdoSearch, //指定函数发送对应请求获取对应分页数据
	'bAutoWidth':false, //自动宽度
	"scrollY": "387px",
//  "scrollCollapse": "true",
	'sPaginationType': 'bootstrap',//分页样式
//  以后在调
//	'pagingType': "full_numbers",
	'dom': 'TRlrtip',
	'data':'',
    columnDefs: [ {
        "searchable": false,
        "orderable": false,
        "targets": 0
    }],
	"oLanguage": {
  		"sSearch": "搜索:",
  		"sLengthMenu": "每页显示 _MENU_ 条记录",
 		"sZeroRecords": "Nothing found - 没有记录",
  		"sInfo": "显示第  _START_ 条到第  _END_ 条记录,一共  _TOTAL_ 条记录",
  		"sInfoEmpty": "显示0条记录",
  		"scrollY": false,
  		"scrollX": false,
  		"scrollCollapse": false,
  		"oPaginate": {
  			"sFirst": "首页",
   			"sPrevious": " 上一页 ",
   			"sNext":     " 下一页 ",
   			"sLast": "尾页"
   		}
  	}, tableTools: {
       	//single 单选 multi 多选  os 可以按ctrl 选择
       	// sRowSelect:'multi',
        //回调 单选
    	fnRowSelected: function ( nodes ) {
    		var index=nodes[0]._DT_RowIndex;	
			var data = $('#activitibody').DataTable().row(index).data();
			window.top[PROCESSDEFINTION_ID] = data;
			if(PROCESSDEFINTION_ID=="BOC_gongdan"){
				//以后在做隐藏处理
			}else{
			}
      		setTimeout('openForm()',10) ;
        //alert(JSON.stringify(data));
        },
    sRowSelect:'os',
    //sRowSelector:'td:first-child',
    aButtons:     [ /*{
      "sExtends":    "select_all",
      "sButtonText": "选择全部",
      "target":      "#select"
    } , 'select_none' */]
	}
}
function pageInit(){}
$(document).ready(function(){
	getActivitiTasksUrl = "/"+PRJ_PATH+"/activitiManager/activityCommon/getUserTask.action"; 
  	IFRAMEPAGEHEIGHT = getQueryString("IFRAMEPAGEHEIGHT");
	PROCESSDEFINTION_ID=getQueryString("PROCESSDEFINTION_ID");
	//判断是否为公告流程
	if(PROCESSDEFINTION_ID=="announcementProcess"){
		PROCESSDEFINTION_ID = getCompanyProcessdefintion(PROCESSDEFINTION_ID) ;
	}
	//判断是否为工单流程
	if(PROCESSDEFINTION_ID=="BOC_gongdan"||PROCESSDEFINTION_ID=="BOC_gongdan01"||PROCESSDEFINTION_ID=="BOC_gongdan02"){
		PROCESSDEFINTION_ID = getCompanyProcessdefintion(PROCESSDEFINTION_ID) ;
	}
	A_TASKNAME=getQueryString("A_TASKNAME");
	A_FORMCLASS=getQueryString("A_FORMCLASS");
	//工单的领取操作类
	if(PROCESSDEFINTION_ID=="BOC_gongdan"||PROCESSDEFINTION_ID=="BOC_gongdan01"||PROCESSDEFINTION_ID=="BOC_gongdan02"){
//		A_FORMCLASS = "GongdanLingqu" ;
	}
	if(PROCESSDEFINTION_ID==""||PROCESSDEFINTION_ID==undefined){
	     alert("获取流程名称失败，请在url中配置（ PROCESSDEFINTION_ID） 。");
	}
	getNoSignOfObtainingData();
	
   
	$('.getTheToDoTask').on('click',function(){
       /* $('#ToDoTaskModel').modal('show');
       loadToDoTaskModel() ;*/
       addOrgByHQDB();
    });
    $('.doReceive').on('click',function(){
       doReceive() ;
    });
    $("#btn_getWait").hide() ;
    var permisson =window.top.GOLBAL_PARAM["userAllPermisson"].base;
    //工单模块的按钮处理
    if(PROCESSDEFINTION_ID=="BOC_gongdan"||PROCESSDEFINTION_ID=="BOC_gongdan01"||PROCESSDEFINTION_ID=="BOC_gongdan02"){
    	$("#btn_getWait").show() ;
    	$("#btn_create").hide() ;
    	A_TASKNAME = "" ;
    	for(var i=0;i<permisson.length;i++){
        	if(permisson[i].name=="工单回复坐席标识"){
            	if(A_TASKNAME==""){
            		A_TASKNAME= "huiFuZuoXi" ;
            	}else{
            		A_TASKNAME = A_TASKNAME+";huiFuZuoXi"
            	}
        	}
        	if(permisson[i].name=="工单复核标识"){
            	if(A_TASKNAME==""){
            		A_TASKNAME= "fuHe" ;
            	}else{
            		A_TASKNAME = A_TASKNAME+";fuHe"
            	}
        	}
        	if(permisson[i].name=="工单经办标识"){
            	if(A_TASKNAME==""){
            		A_TASKNAME= "jingBan" ;
            	}else{
            		A_TASKNAME = A_TASKNAME+";jingBan"
            	}
        	}
    	}
    	$('#btn_create').hide() ;
    }
    //公告模块的按钮处理
    if(PROCESSDEFINTION_ID=="announcementProcess"||PROCESSDEFINTION_ID=="announcementProcess01"||PROCESSDEFINTION_ID=="announcementProcess02"){     	
        for(var i=0;i<permisson.length;i++){
        	if(permisson[i].name=="公告复核标识"){
            	$("#btn_getWait").show() ;   	
        	}
        }
    }
    
    //其他模块的按钮处理
    else{
    	for(var i=0;i<permisson.length;i++){
        	if(permisson[i].name=="复核标识"){
            	$("#btn_getWait").show() ;
        	}
    	}
    }
});
//根据companyId区分流程标识
function getCompanyProcessdefintion(processdefintionId){
	if(getUserInfo().companyId=="01"){
	    processdefintionId=PROCESSDEFINTION_ID+"01";
	}
	if(getUserInfo().companyId=="02"){
	    processdefintionId=PROCESSDEFINTION_ID+"02";
	}
    return processdefintionId;
}

function doReceive(){
	var params = {};
	params.processInstanceId = window.top.toDoRowData.a_flowId ;
	params.to_userId = getUserInfo().loginName;
	params.processDefinitionId=PROCESSDEFINTION_ID ;
	transferAssigneeByProcessInstanceId(params,function(data){
			alert(data.mgs);
			//此处使用通用insert方法在 activitiTest表中 更新一次数据。
	}) ;
}

function loadToDoTaskModel(){
//	ToDoTaskModelBody
	$('#ToDoTaskModelBody').dataTable(ToDodataGrid);
	var params = {};
	var retData = {};
	params.tableName="activititest";
	params.equal = {"a_flowState":"a_flowState"} ;
	params.columnValues ={"a_flowState":"1","a_disponseUser":"1"} ;
	commonSelect(params,false,function(data){
		if(data.success){
			retData = data.data ;
			drawTable('ToDoTaskModelBody',retData);
		}else{
			alert(data.mgs);
		}
						
	});	
}

/**获取通用列表配置和待办数据**/
function getNoSignOfObtainingData(){
	var param = {};
	var retData = {};
	param.A_PROCESSDEFINITIONID =PROCESSDEFINTION_ID;
	var height = getQueryString("height");
	if(height==""||height==undefined||height==null){
		height = 200;
	}
	$("#activitiFormPage").attr("height",height);
	putLoginNameToParam(param);
	if(window.top[PROCESSDEFINTION_ID+"clumns"]==null||window.top[PROCESSDEFINTION_ID+"clumns"]==undefined||window.top[PROCESSDEFINTION_ID+"clumns"]==""){
		ajaxFunction(getActivitiTasksUrl,param,true,function(data){
			if(data.data){
				dataGrid.columns = eval(data.data.clumns) ;
				window.top[PROCESSDEFINTION_ID+"clumns"] = data.data.clumns ;
				window.top[PROCESSDEFINTION_ID+"path"] = data.data.path ;
				$('#activitibody').dataTable(dataGrid);
				var table= $('#activitibody').DataTable();
				$('#activitibody tbody').on( 'click', 'button', function (obj) {
					var data = table.row( $(this).parents('tr') ).data();
				});
				var colvis = new $.fn.dataTable.ColVis(table,{ buttonText: '自定义显示列',exclude: [ 0 ,-1] });
			}
		});
	}else{
		dataGrid.columns = eval(window.top[PROCESSDEFINTION_ID+"clumns"]) ;
		$('#activitibody').dataTable(dataGrid);
		var table= $('#activitibody').DataTable();
		$('#activitibody tbody').on( 'click', 'button', function (obj) {
			var data = table.row( $(this).parents('tr') ).data();
		});
		var colvis = new $.fn.dataTable.ColVis(table,{ buttonText: '自定义显示列',exclude: [ 0 ,-1] });
	}
}
function drawTable(id,data){
	var table=$('#activitibody').DataTable();
	table.search("").draw();
	table.clear().draw();
	table.rows.add(data).draw(true);	
}

/**刷新**/

function doRepeat(){
	var table=$('#activitibody').DataTable();
	table.draw();
}

/**打开工单页面**/
function openForm(){
	try {
		var url = window.top[PROCESSDEFINTION_ID+"path"]+"?PROCESSDEFINTION_ID="+PROCESSDEFINTION_ID+"&TYPE=commonProcess";
		$("#iframePage").show();
		$("#iframePageDiv").show();
		$('#iframePageDiv iframe').attr('src',url).removeClass('hide');
		$("#iframePageDiv").css("height",IFRAMEPAGEHEIGHT+"px");
		$("#iframePage").css("height",IFRAMEPAGEHEIGHT+"px");
	} catch (e) {
		alert('未选择数据');
	};
}

/**新建一个表单**/
function doOpenNew(){
		
	try {
		var url = window.top[PROCESSDEFINTION_ID+"path"]+"?PROCESSDEFINTION_ID="+PROCESSDEFINTION_ID+"&"+"TYPE=new&";
		$("#iframePageDiv").show();
		$('#iframePageDiv iframe').attr('src',url).removeClass('hide');
		$("#iframePageDiv").css("height",IFRAMEPAGEHEIGHT+"px");
		$("#iframePage").css("height",IFRAMEPAGEHEIGHT+"px");
	} catch (e) {
		alert('未选择数据');
	};
}
function changeHight(){
	try{
 		var ifm = document.getElementById("iframePage");
    	var subWeb = document.frames ? document.frames["iframePage"].document : ifm.contentDocument;
    	if (ifm != null && subWeb != null) {
			ifm.height = subWeb.body.scrollHeight;
			var height = subWeb.body.scrollHeight + 15 ;
			$("#iframePageDiv").css("height",height+"px");
			$("#iframePage").css("height",height+"px");
    	}
    }catch(e){}
}
function hideHight(){
	try{
		$("#iframePageDiv").hide();
//		$("#iframePage").hide();
//		$("#iframePageDiv").css("height","0px");
//		$("#iframePage").css("height","0px");
    }catch(e){
    	window.console.log(e) ;
    }
}
//分页查询
/*****************************************************/
  //这三个参数都有用,不要删掉
function FYdoSearch(data, callback, settings){
var param = {};
	param.A_PROCESSDEFINITIONID =PROCESSDEFINTION_ID;
	putLoginNameToParam(param);
	param.A_ASSIGNEE=getUserInfo().loginName;
	param.A_BeginNum=settings._iDisplayStart;  //数据开始位置(服务器分页方式自动变化)
	param.A_MaxNum=settings._iDisplayLength;  //每页数据展示长度
	ajaxFunction(getActivitiTasksUrl,param,true,function(Nowdata){
		if(Nowdata.data){
		 $('#example').dataTable( {
    		"clumns": Nowdata.data.clumns
  			} );
		 //后台没有数据的时候没有对应属性定义
		if(Nowdata.data.resultformdata!=undefined){
   				  var pdata={};
			                  //数据
			                  pdata.data=Nowdata.data.resultformdata;
			                   var total=Nowdata.data.total;
			                  //总条数
			                  pdata.recordsTotal=total;
			                   //过滤没有使用到总条数
			                  pdata.recordsFiltered=total;
			                  // 代表第几次画页面  如pdata.draw 不能删 如删掉不会翻页  
			                  pdata.draw=settings.iDraw;
			                  callback(pdata);
			    }else{
			    //没有数据的时候进行设置空值，不然会一直在请求导致浏览器卡死。
			    var Notdata =[];
			     var pdata={};
			                  //数据
			                  pdata.data=Notdata;
			                   var total=0;
			                  //总条数
			                  pdata.recordsTotal=total;
			                   //过滤没有使用到总条数
			                  pdata.recordsFiltered=total;
			                  // 代表第几次画页面  如pdata.draw 不能删 如删掉不会翻页  
			                  pdata.draw=settings.iDraw;
			                  callback(pdata);
			   	 }
	 	}
  });
}

/*****************************************************/



//获取待办
/*****************************************************/
function addOrgByHQDB() {
	var url = "/ZDesk/zh_cn/BOC/huoqudaiban.html?PROCESSDEFINTION_ID="+PROCESSDEFINTION_ID+"&doRepeat=doRepeat"+"&A_TASKNAME="+A_TASKNAME+"&A_FORMCLASS="+A_FORMCLASS;
	var nowhtmlurl =window.location.pathname;
	nowhtmlurl+=window.location.search;
	var now =window.parent.$("iframe[src='"+nowhtmlurl+"']");
	now.attr("name","needforme");
	window.top.huoqudaibanDialog(url,"获取待办","1000","365");
}


 function userDialog(url,title,width,height) {
 	var userDig = dialog({
				title : title,
				content : '<iframe src=' + url
						+ ' style="border: 0; width: 100%; height: 100%"  frameborder="0"/>',
				width :width,
				height : height
	});
	userDig.show();
	return userDig;
}

//关闭dialog
function closeDig(){
	window.closeDialog.close().remove();
}
/*****************************************************/

</script>
</html>
