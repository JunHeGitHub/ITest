<!DOCTYPE html>
<html lang="en">

	<head>
		<title>页面权限</title>

		<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
		<meta http-equiv="description" content="this is my page">
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">

		<!--<link rel="stylesheet" type="text/css" href="./styles.css">-->
		<link rel="stylesheet" href="../../../css/bootstrap.min.css" type="text/css"></link>
		<link rel="stylesheet" href="../../../css/bootstrap-responsive.min.css" type="text/css"></link>
		<link rel="stylesheet" href="../../../js/dataTables/css/DT_bootstrap.css" type="text/css"></link>
		<link rel="stylesheet"href="../../../js/dataTables/css/jquery.dataTables.css" type="text/css"></link>
		<link rel="stylesheet" href="../../../js/dataTables/css/font-awesome.css"></link>	
		<link rel="stylesheet" href="../../../js/dataTables/css/Z_DataTalbeCheckBox.css" type="text/css"></link>
		<script type="text/javascript" src="../../../js/jquery.js"></script>
		<script type="text/javascript" src="../../../js/bootstrap.js"></script>
		<script type="text/javascript" src="../../../js/common_utils.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/jquery.dataTables.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/dataTables.tableTools.min.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/DT_bootstrap.js"></script>
		<script type="text/javascript"  src="../../../js/appCommonUtil.js"></script>
		
		<script type="text/javascript">
		var table=false;
		//权限集合
	   var permissonArray=[];
	   var isSelect=[];
	   var needAdd=[];
	   var needDel=[];
	   var PRJ_PATH=window.top.PRJ_PATH||"ZDesk";
	   var ZDesk_ROU=window.top.ZDesk_ROU||"ZDesk";
	   $(document).ready(function(){ 
		   	table=$('#tt').DataTable({
		        bPaginate: true, //翻页功能
				bLengthChange: false, //改变每页显示数据数量
				bFilter: false, //过滤功能
				bSort: true, //排序功能
				bInfo: false,//页脚信息
				bAutoWidth: false, //自动宽度
			    dom: 'T<"clear">lrtip',
				columns: [
					{
					 title:"",
                     data: null, 
                     defaultContent:'', 
                     orderable: false ,
					 width:"20px"
					},
			        {
			         title:"<center>功能名称</center>",
			         data:'funName',
			         width:"100px"
			         //className: "title_center" 
	                },
	                {
			         title:"<center>功能标识</center>",
			         data:'funId',
			         width:"100px"
			         //className: "title_center" 
	                }     
		        ],
		        oLanguage: {
					"sLengthMenu": "每页显示 _MENU_条",
					"sZeroRecords": "没有找到符合条件的数据",
					"sProcessing": "&lt;imgsrc=’./loading.gif’ /&gt;",
					"sInfo": "当前第 _START_ - _END_ 条　共计 _TOTAL_ 条",
					"sInfoEmpty": "木有记录",
					"sInfoFiltered": "(从 _MAX_ 条记录中过滤)",
					"sSearch": "搜索：",
					"oPaginate": {
								"sFirst": "首页",
								"sPrevious": "前一页",
								"sNext": "后一页",
								"sLast": "尾页"
					        }
		        }, tableTools: {
		            fnRowSelected: function ( nodes ) {
                      var index=nodes[0]._DT_RowIndex;
                      var x=arrUtil(isSelect,index);
                      if(x===false){
                          //需要添加的没有在添加
                          if(arrUtil(needAdd,index)===false){
                            needAdd.push(index)
                          }                       
                      }
                      var nd_del= arrUtil(needDel,index);
                           if(nd_del!==false){
                            needDel.splice(nd_del,1);
                       }
                       //alert("needADD"+needAdd.toString());
                       //alert("needDel"+needDel.toString());  
		            },
		            fnRowDeselected: function ( nodes ) {
                      var index=nodes[0]._DT_RowIndex;
                      if(arrUtil(isSelect,index)!==false){
                          needDel.push(index); 
                       }
                       var nd_add= arrUtil(needAdd,index);
                       if(nd_add!==false){
                            needAdd.splice(nd_add,1);
                        }  
                        //alert("needDel"+needDel.toString());  
                        //alert("needADD"+needAdd.toString());
                    },
		            sRowSelect:'multi',
		            aButtons:[]
		        },createdRow: function( row, data, dataIndex ) {
				    {  
				   
				      for(var i=0;i<permissonArray.length;i++){
				      
				            if(permissonArray[i]==data.id){
				              //$(row).addClass('active');
				              isSelect.push(dataIndex);
				              //selectRow(dataIndex);
				               break;
				            }
				          
				      }
				     
				    }
				 } 
		   }); 
	       setModelUrl();
	   });
           
   function doSearch(){
		//通用查询action路径
		var param={}
		//获取基础权限
		param.typeName="base";
		var url = "/" + PRJ_PATH + "/" +ZDesk_ROU+"/suSecurityPermission" + "/" + "searchSuSecurityPermission.action";
		   var rdata=[];
		   	$.ajax({
				async :false,
				type : "post",
				url : url,
				dataType : "json",
				data : param,
				success : function(data) {
					if(data) {	              
		              rdata=data.data;
					}
				},
				error : function(r){
				   alert("error");			
				}
				});
		     return rdata;
		} 
	        	//刷新	
	function refresh(){
	     var table=$('#test').DataTable();
	     $("#shaixuan").val('');
	     table.clear().draw();
	     //重新加载数据
	     var data=doSearch(); 
	     table.rows.add(data).draw(true);
	}   
    function  getParams(){
    
       
	   var selectData=table.rows().data();
	   var pCodesp=[];
	   var delCode=[];
	   for(var i=0;i<needAdd.length;i++){
	          var index=needAdd[i];
	          pCodesp.push(selectData[index].id);
	   }
	   for(var i=0;i<needDel.length;i++){
	      var index=needDel[i];
	      delCode.push(selectData[index].id)
	   }
	   var delCodes=delCode.join(",");
	  //for(var i=0;i<selectData.length;i++){
	         
	   //    var sd=selectData[i];
	   //
	   //     pCodesp.push(sd.id);
	   // }
	    var permisstionCodes=pCodesp.join(",");
	    //alert(JSON.stringify(selectData));
	    var params=window.parent.getRoleCodeAndType();
        var p=window.parent.getRoleCodeAndType();
        var fp={
             'permisstionCode':permisstionCodes,
             'delCodes':delCodes
        }    
        return $.extend(params,fp);
    } 
    
    function addPermissonMapRole(){
      var params=getParams();
      if(params.roleCode==undefined||params.roleCode==null||params.roleCode==""){
           window.parent.zinglabs.i18n.alert("permission_role");
           return ;
      }
      
      var url="/"+ZDesk+"/"+ZDesk_ROU+"/permissonMappingRole/addMenuPermisson.action";
      ajaxFunction(url,params,false,function(data){
           if(data&&data.success){
              window.parent.zinglabs.i18n.alert("permission_success");
           }else{
             window.parent.zinglabs.alert(data.mgs);
           }
      });
    } 
    // 获取角色权限
     function getPagePermissonByRole(){
          permissonArray=[];
          var params=window.parent.getRoleCodeAndType()
	      if(params.roleCode==undefined||params.roleCode==null||params.roleCode==""){
	           window.parent.zinglabs.i18n.alert("permission_role");
	           return ;
	      }
          var url="/"+ZDesk+"/"+ZDesk_ROU+"/permissonMappingRole/getPermissonCode.action";
	      ajaxFunction(url,params,false,function(data){
	           if(data&&data.success){
	               permissonArray=data.data;
	               return true;
	           }else{
	             window.parent.zinglabs.alert(data.mgs);
	           }
	      }); 
         return false;  
      }   
      
      function selectRow(){
         var oTT = TableTools.fnGetInstance('tt');
         var length=isSelect.length;
          if(length>=0){
            for(var i=0;i<length;i++){
              var index=isSelect[i];
              oTT.fnSelect( $('#tt tbody tr')[index]);
            }
            
          }
      }
      
      function setModelUrl(){
           var url="/"+PRJ_PATH+"/zh_cn/common/zkmCommonTree.html?treeWidth=400&treeHeight=600&mode=single&pchm=p&cchm=p&recordType=menu&type=allNode";
           $('#modelTree').attr("src",url);      
      } 
      function searchPermisstion(tevent,treeId,treeNode,clickFlag){
           var modelId=treeNode.modleId;
           if(modelId==undefined||modelId==null||modelId==""){
             return ;
           }
           getPagePermissonByRole();
           var data=getSuSecurityPermissionInfo("page",modelId);
           //清空全局变量
           isSelect=[];
		   needAdd=[];
		   needDel=[];
           table.clear().draw();
            
	       table.rows.add(data).draw(true);
	       //勾选已有权限
	       selectRow();
      }
//筛选
 function tableSearch(){
   //var table=$('#tt').DataTable();
    var value=$("#shaixuan").val();
    table.search(value).draw(true);
}
  
  function arrUtil(data,key){
		var m=data.length
		for(i=0;i<m;i++){
		  if(data[i]==key)
		    return i
		}
	    return false;
    
  }    
		</script>

</head>

	<body> 

		 
		   <div class="row">
		      
		      <div class="span2">
		          <iframe id="modelTree" src="" height="500" scrolling="no" frameborder="0" style="overflow: auto"> </iframe>
		      </div>
		      <div class="span4">
		          <form class="form-actions" style="margin-top:0px">
		             <button type="button" class="btn btn-primary"  onclick="addPermissonMapRole()">授权</button>
					 <input id ="shaixuan" type="text" class="input-mini search-query">
					 <button  type="button" class="btn" onclick="tableSearch()">筛选</button>
				  </form>
		          <table id="tt"  class="table table-striped table-bordered" cellspacing="0">
		          </table>
		      </div>
		   </div>
	</body>
</html>
