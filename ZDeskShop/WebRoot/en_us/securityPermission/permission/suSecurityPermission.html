	<!DOCTYPE  HTML>
	<html lang="en">
		<head>
			<title>权限管理</title>
	
			<meta http-equiv="keywords" content="keyword1,keyword2,keyword3" />
			<meta http-equiv="description" content="this is my page" />
			<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
			<link rel="stylesheet" href="../../../css/bootstrap.min.css" type="text/css"></link>
		    <link rel="stylesheet" href="../../../css/bootstrap-responsive.min.css" type="text/css"></link>
			<link rel="stylesheet" href="../../../js/dataTables/css/jquery.dataTables.css" type="text/css"></link>
			
			<!-- bootstrap 与 datatable结合 -->
			<link rel="stylesheet" href="../../../js/dataTables/css/DT_bootstrap.css" type="text/css"></link>
			<!-- 工具 -->
			<link rel="stylesheet" href="../../../js/dataTables/css/dataTables.tableTools.min.css" type="text/css"></link>
			<!-- 动态列CSS -->
			<link rel="stylesheet" href="../../../demo/unicorn.main.css" type="text/css"></link>
		    <link rel="stylesheet" href="../../../js/dataTables/css/font-awesome.css"></link>
			<link rel="stylesheet" href="../../../js/dataTables/css/dataTables.colVis.min.css" type="text/css"></link>
			<script type="text/javascript" src="../../../js/golbal_params.js"></script>
			<script type="text/javascript" src="../../../js/jquery.js"></script>
			<script type="text/javascript" src="../../../js/bootstrap.js"></script>
			<script type="text/javascript" src="../../../js/dataTables/js/jquery.dataTables.js"></script>
			<script type="text/javascript" src="../../../js/dataTables/js/dataTables.colReorder.js"></script>
			<script type="text/javascript" src="../../../js/dataTables/js/dataTables.colVis.js"></script>
			<script type="text/javascript" src="../../../js/dataTables/js/dataTables.tableTools.min.js"></script>
			<script type="text/javascript" src="../../../js/dataTables/js/DT_bootstrap.js"></script>
			<script type="text/javascript" src="../../../js/common_utils.js"></script>
			<script type="text/javascript" src="../../../js/appCommonUtil.js"></script>
			<script type="text/javascript" src="../../../js/appCommonCurdUtils.js"></script>
	<style type="text/css" class="init">
	 #test  tr td:first-child {
	        text-align: center;
	    }
	  /* fa-square-o */
	 #test tr td:first-child:before {
			content: "\f096";
			font-family: FontAwesome;
		}
	 	#test td{text-align: center;}
	 	#test tr.active td:first-child:before {
	       content: "\f046"; /* fa-check-square-o */
	    }
	    
	    #where .td{width:70px; text-align:center;}
	  
	</style>
			<script type="text/javascript">
var bool=true;

var roleWin;
var orgWin;
var PRJ_PATH=window.top.PRJ_PATH||"ZDesk";
var ZDesk_ROU=window.top.ZDesk_ROU||"ZDesk";
function addOrg() {		
			var url = "/"+PRJ_PATH+"/zh_cn/common/zkmCommonTree.html?recordType=menu&type=allNode&mode=single&showButton=y&reFillFn=getOrgCodeList&closeFn=closeWindow";
			$("#orgWin iframe").attr("src", url).removeClass('hide');
			orgWin.open();
		}
		
// 关闭window
function closeWindow() {
	roleWin.close();
	orgWin.close();
}

	
 function getOrgCodeList(orgCodeList) {
	var str = '';
	var modelid='';

	for (var i = 0; i < orgCodeList.length; i++) {
		var params = {};
		params.tableName = "commonTree_detail";
		params.primaryKey = "id";
		params.primaryKeyValue = orgCodeList[i];
		params.where = {
			"id" : params.primaryKeyValue
		};
		commonSelect(params, false, function(data) {
					str = data.rows[0].text + "," + str;
					modelid=data.rows[0].modleId + "," + modelid;
				});
	}
	var companyTextList = str.substr(0, str.length - 1);
	var mid=modelid.substr(0, modelid.length - 1);
	$("#modleId").val(mid);
	$("#modleName").val(companyTextList);
	closeWindow();
	// $("#myModal").modal("hide");
}   
	
	$(document).ready(function() {
		
	   var da=doSearch(); 
		roleWin= $("#roleWin").window({
  		 title:"角色授权",
         width:"745",
         height:"400",
         Icon:"icon-hand-right",
         isShow:false
       });
  orgWin= $("#orgWin").window({
  		 title:"组织机构",
         width:"300",
         height:"400",
         Icon:"icon-hand-right",
         isShow:false
       }); 
	  $('#test').dataTable({
    	    //滚动条 
	        //scrollY: 500,
	       //scrollX: false,
	        bPaginate: true, //翻页功能
			bLengthChange: false, //改变每页显示数据数量
			bFilter: true, //过滤功能
			bSort: true, //排序功能
			bInfo: true,//页脚信息
			bAutoWidth: false, //自动宽度
			sPaginationType: "bootstrap",//分页样式
			//"sDom":"<'row'<'span6'l><'span6'f>r>t<'row'<'span6'i><'span6'p>>" ,
			data:da,
		   // dom: 'Rlfrtip',
		    dom: 'TRlrtip',
		   // dom: 'T<"clear">lfrtip',
		    //自定义列插件
	       // colVis: {
	       //    order: 'alpha',
	       //    buttonText: "自定义显示列"
	       // },
	        order: [ 1, 'desc' ],
			columns: [
			 /*{ "title": 
			   "<input type='checkbox' id='selectall' onclick='toggleChecks(this);' ></input>",
			    "mDataProp": null, 
			    "sWidth": "20px", 
			    "sDefaultContent": "<input type='checkbox' class='case' onChange='setSelect()' ></input>",
			     "bSortable": false 
		
			     },*/
				{ title:"<input type='checkbox' id='selectall' onclick='toggleChecks(this);' ></input>",data: null, defaultContent: '', orderable: false },
				{ 
				  title:"id" ,
				  data: 'id',
				  visible: false,
				  searchable: false
				},
				/**title 表头  data json 对应key **/
		        {"title":"权限名称",data:'name',filter:'desc' },
		        {"title": "权限类型",data: 'typeName' },
		        {"title": "模块名称",  data: 'modleName'},
		        {"title": "功能名称",data: 'funName' }
	        ],
	        //列 行高亮显示
	        createdRow: function ( row, data, index ) {
	           // if ( data[5].replace(/[\$,]/g, '') * 1 > 4000 ) {
	               // alert("123");
	                $('td', row).eq(2).addClass('red');
	           // }
	        } ,
	        //列筛选等属性 样式 可以与columns属性合并
	        columnDefs: [ {
			     "targets": -1,
			     "defaultContent": "<button>编辑</button>",
			      data:null
		          } ,
		          {
	                // The `data` parameter refers to the data for the cell (defined by the
	                // `data` option, which defaults to the column being worked with, in
	                // this case `data: 0`.
	                render: function ( data, type, row ) {
	                    return data ;//+' (单元格格式化)';
	                },
	                "targets": 3
	            }
		    ],
	        oLanguage: {
				"sLengthMenu": "每页显示 _MENU_条",
				"sZeroRecords": "没有找到符合条件的数据",
				"sProcessing": "&lt;imgsrc=’./loading.gif’ /&gt;",
				"sInfo": "当前第 _START_ - _END_ 条　共计 _TOTAL_ 条",
				"sInfoEmpty": "木有记录",
				"sInfoFiltered": "(从 _MAX_ 条记录中过滤)",
				"sSearch": "搜索：",
				"oPaginate": {
				"sFirst": "首页",
				"sPrevious": "前一页",
				"sNext": "后一页",
				"sLast": "尾页"
			    }
	        }, tableTools: {
	          //single 单选 multi 多选  os 可以按ctrl 选择
	           // sRowSelect:'multi',
	           //回调 单选
	            fnRowSelected: function ( nodes ) {
	               var index=nodes[0]._DT_RowIndex;	
	               var data = table.row(index).data();
	               initForm(data);
	               //alert(JSON.stringify(data));
	            },
	             sRowSelect:'multi',
	            //sRowSelector:'td:first-child',
	            aButtons:     [ /*{
	                "sExtends":    "select_all",
	                "sButtonText": "选择全部",
	                "target":      "#select"
	              } , 'select_none' */]
	        }
	        
	        
	    }); 
	     //绑定事件 on
	     var table= $('#test').DataTable();
		 $('#test tbody').on( 'click', 'button', function (obj) {
		    var data = table.row( $(this).parents('tr') ).data();
	        alert(JSON.stringify(data));
		} );
		 
		
	    //工具栏与bootstarp 结合
	   // var tt = new $.fn.dataTable.TableTools(table);
	  //  $(tt.fnContainer()).insertBefore('#tools');
	  //筛选绑定
	   /* $('#shaixuan').on( 'keyup', function () {
	       table.search( this.value ).draw();
	    });*/
	    //自定义列插件绑定
	     var colvis = new $.fn.dataTable.ColVis(table,{ buttonText: '自定义显示列',exclude: [ 0 ,1] });
	    $( colvis.button()).insertBefore('#cols');  
	});
	
	function tableSearch(){
		var data=zkm_getHtmlFormJsons("where");
		var info=doSearch(data);
		if(data!=''||data!=null){
		    var table=$('#test').DataTable();
		    table.clear().draw();
		    table.rows.add(info).draw();
	    }
	    if($("#comTypeName").val()!="page"){
	     	var table=$('#test').DataTable();
			table.column( 4 ).visible( false );
			table.column( 5 ).visible( false );
		}
	}
	
	
	function doSearch(data){
		//通用查询action路径
		var url = "/" + PRJ_PATH+ "/" + ZDesk_ROU+"/suSecurityPermission" + "/" + "searchSuSecurityPermission.action";
		   var rdata=[];
		   	$.ajax({
				async :false,
				type : "post",
				url : url,
				dataType : "json",
				data : data,
				success : function(data) {
					if (data) {
		              /*$("#test").dataTable({
		                 data:data
		              });*/
		              rdata=data.data;
					}
				},
				error : function(r){
				   alert("error");			
				}
				});
		     return rdata;
		}
		//获取选中行
		function fnGetSelected(){
		    //注意DataTable大写 或者 $('#test').dataTable().api();	
		     var table=$('#test').DataTable();
		 //  var data =table.column().data();
		    //获取选中行 通过dataTable查找
		    var cell=table.rows(".active").data();
		    //通过table TableTools插件 查找
		     var tt = new $.fn.dataTable.TableTools(table);
		      var selectData=tt.fnGetSelectedData();
		      var array="";
		      for(var i=0;i<selectData.length;i++){
		      	array+=JSON.stringify(selectData[i].id)+",";
		      }
		      var id=array;
		    console.log( JSON.stringify(selectData));
		    if(selectData==""||selectData==null){
		    	 zinglabs.i18n.alert("system_selectDataForDelete");
		    }else{
		        zinglabs.confirm('确认删除此条数据?',function(){
		        	 var url = "/" + PRJ_PATH + "/" + ZDesk_ROU+"/suSecurityPermission" + "/" + "deleteSuSecurityPermission.action";
			   	var params=id
			   	$.ajax({
					async :false,
					type : "post",
					url : url,
					dataType : "json",
					data : params,
					success : function(data) {
						if (data) {
			             refresh();
						}
					},
					error : function(r){
					   alert("error");			
					}
				});
				
		        });
		       
		    }
		}
		 //获取选中行修改
		function doUpdate(){
		var data=zkm_getHtmlFormJsons("updateForm");
	        var url = "/" + PRJ_PATH + "/" + ZDesk_ROU+"/suSecurityPermission" + "/" + "updateSuSecurityPermission.action";
		   	$.ajax({
				async :false,
				type : "post",
				url : url,
				dataType : "json",
				data : data,
				success : function(data) {
					if (data) {
		              /*$("#test").dataTable({
		                 data:data
		              });*/
		                zinglabs.i18n.alert("system_updateSuccess");
		             $("#updateForm input,#updateForm textarea,#updateForm select[name]").val('');
		             $("#menuTree").hide();
		             refresh();
		             addBotton();
					}
				},
				error : function(r){
				   alert("error");			
				}
			});	
		}
	
		 //添加操作
		function doSave(){
		var data=zkm_getHtmlFormJsons("updateForm");
		var quanxian=$("#quanxianleixing").val();
		 if(authorization(quanxian)){
		 	alert("");
		 	return;
		 }else{
	        var url = "/" + PRJ_PATH + "/" +ZDesk_ROU +"/suSecurityPermission" + "/" + "SaveSuSecurityPermission.action";
		   	$.ajax({
				async :false,
				type : "post",
				url : url,
				dataType : "json",
				data : data,
				success : function(data) {
					if (data&&data.success){
		               zinglabs.i18n.alert("system_saveSuccess");
		              $("#updateForm input,#updateForm textarea,#updateForm select[name]").val('');
		               $("#menuTree").hide();
		              refresh();
					}else{
					}
				},
				error : function(r){
				   zinglabs.alert("error");
				}
			});
			}
		}
	//全选
	
	 function toggleChecks(obj){
	       var table=$('#test').DataTable();
	       var tableTools = new $.fn.dataTable.TableTools(table);
	       var ischeck=$("#selectall").is(':checked');
	       if(ischeck){
	         tableTools.fnSelectAll();
	       }else{
	         tableTools.fnSelectNone();
	       }
	    }
	    
		function initForm(data){
					uppdateBotton();
					scroll2data("updateForm");
					var cfs=$("#updateForm input[name],#updateForm textarea[name],#updateForm select[name]");
					for(var i=0;i<cfs.length;i++){
						var e=cfs[i];					
						var v=data[e.name];
						if(v==undefined || v==null){
							v='';
						}
						$(e).val(v);
					}
					var quanxian=$("#quanxianleixing").val();
					authorization(quanxian);
				}
				
	//显示修改隐藏保存
	function uppdateBotton(){
		$("#updateForm").show();
		$("#add_button").hide();
		
		$("#update_button").show();
	}
	
	//显示保存隐藏修改
	function addBotton(){
		$("#updateForm").show();
		$("#add_button").show();
		$("#update_button").hide();
	}
	//权限类型分别该显示的功能
	function authorization(quanxian){
	      	var name=$("#name").val();
	      	var funid=$("#funId").val();
	      	var funName=$("#funName").val();
	      	var modleId=$("#modleId").val();
	      	var alias1=$("#alias1").val();
	      	var modleName=$("#modleName").val();
			if(quanxian==""||quanxian==null){
				$("#quanxianleixing").val("");
				$("#path").hide();
				$("#mokuai").hide();
				$("#gongneng").hide();
				$("#mokuaimingcheng").hide();
				$("#gongnengmingcheng").hide();
				return bool;
			}
			if(quanxian=="page"){
				$("#path").hide();
				$("#mokuai").show();
				$("#gongneng").show();
				$("#mokuaimingcheng").show();
				$("#gongnengmingcheng").show();
				
				if(modleId==""||modleId==null){
					return bool;
				}
				if(modleName==""||modleName==null){
					return bool;
				}
				if(funid==""||funid==null){
					return bool;
				}
				if(funName==""||funName==null){
					return bool;
				}
				if(funName==""||funName==null||funName==""||funName==null||modleName==""||modleName==null||modleId==""||modleId==null){
					return bool;
				}
				
			}
			if(quanxian=="base"){
				$("#path").hide();
				$("#mokuai").hide();
				$("#gongneng").hide();
				$("#mokuaimingcheng").hide();
				$("#gongnengmingcheng").hide();
				if(name==""||name==null){
					return bool;
				}
			}
			
			if(quanxian=="tab"){
				$("#path").show();
				$("#mokuai").hide();
				$("#quanxian").show();
				$("#gongneng").hide();
				$("#mokuaimingcheng").hide();
				$("#gongnengmingcheng").hide();
				if(name==""||name==null){
					return bool;
				}
				if(alias1==""||alias1==null){
					return bool;
				}
				if(name==""||name==null||alias1==""||alias1==null){
					return bool;
				}
			}
	}
	
	
	//每页显示条数
	function setPageNum(obj){
	  var table=$('#test').DataTable();
	  table.page.len(obj.value).draw();
	  //alert(obj.value);
	}
	//刷新
	function refresh(){
		var quanxian=$("#quanxianleixing").val();
		authorization(quanxian);
	     var table=$('#test').DataTable();
	     //清空筛选
	     table.search("").draw();
	     $("#shaixuan").val('');
	     //清空数据
	     table.clear().draw();
	     //重新加载数据
	     var data=doSearch(); 
	     table.rows.add(data).draw(true);
	}
		$(document).ready(function() {
			comType('comTypeName');
			comType('quanxianleixing');
			var quanxian=$("#quanxianleixing").val();
			$("#updateForm").hide();
			$("#save").click(function(){
				$("#mokuai").hide();
				$("#updateForm").show();
				$("#add_button").show();
				$("#update_button").hide();
				$("#updateForm input[name],textarea[name],select[name]").val("");
				authorization(quanxian);
			});
			//权限类型改变事件
			$("#quanxianleixing").change(function(){
				var quanxian=$("#quanxianleixing").val();
				authorization(quanxian);
			});
		});
		
		function comType(selectid){
			var data=getDictListfoIndexData('system_default');
			$("#"+""+selectid+"").empty();
				$("#"+""+selectid+"").append("<option value=''>--请选择--</option>"); 
			for(var i in data){
	        	$("#"+""+selectid+"").append("<option value='"+data[i].code+"'>"+data[i].name+"</option>"); 
	        }
		}
		
		function chongzhi(){
			var quanxian="";
				authorization(quanxian);
		}
		function scroll2data(id){
		$("html,body").animate({scrollTop: $("#"+id).offset().top}, 1000); 
		}

	      
	    </script>
	</head>
<body style="width: auto;">
<!-- 头 -->
<div class="widget-box collapsible">
	<div class="widget-title">
       <span class="icon">
			<i class="icon-search"></i>
		</span>
		<h5>配置项搜索</h5>
		<div class="buttons">
			<!-- <div id="cols" ></div> -->
		   <a href="#collapseOne" data-toggle="collapse" class="btn btn-mini"><i class="icon-retweet"></i>展开/关闭</a></div>
		</div>
		<div class="collapse in" id="collapseOne">
			<div class="widget-content"  style="width: 1300px;">
					<form action="" id="where">
						<table>
							<tr>
								<th class="td">权限名称：</th>
								<th>
									<div class="controls" style="float: left; padding-left: 30px; padding-right: 10px;">
										<input type="text"  name="name" placeholder="">
									</div>
								</th>
								<th class="td">权限类型：</th>
								<th>
									<div class="controls" style="float: left; padding-left: 30px; padding-right: 10px;">
										<select id="comTypeName" name="typeName" style="width: 220px;">										
										</select>
									</div>
								</th>
							</tr>
							<tr>
								<th class="td">模块名称：</th>
								<th>
									<div class="controls" style="float: left; padding-left: 30px; padding-right: 10px;">
										<input type="text"   name="modleName" placeholder="">
									</div>
								</th>
								
								<th class="td">功能名称：</th>
								<th>
									<div class="controls" style="float: left; padding-left: 30px; padding-right: 10px;">
										<input type="text"  name="funName" placeholder="">
									</div>
								</th>
								<th>
									<button type="button" style="float: left; margin-top: -10px;" class="btn" onclick="tableSearch()"><i class="icon-search"></i> 搜 索</button>
								</th>
								
							</tr>
						</table>
					</form>
		</div>
		</div>
					
	<!-- class 或 = display -->
	<table style="float: left;" class="table table-striped table-bordered"
		id="test" cellspacing="0">
	</table>
	
	<div class="widget-box collapsible">
		<div class="widget-title">
						每页显示条数：
			<select name="pageSize" id="pageSize" style="width:70px" onchange="setPageNum(this)">
				<option selected="selected" value="10">
					10
				</option>
				<option value="30" >
					30
				</option>
				<option value="50" >
					50
				</option>
				<option value="100" >
					100
				</option>
				<option value="200" >
					200
				</option>
				<option value="500" >
					500
				</option>
				<option value="1000" >
					1000
				</option>
				<option value="-1" >
					全部
				</option>
			</select>
			<button type="button" class="btn" onclick="fnGetSelected()"><i class="icon-remove"></i> 删 除</button>
	       <button role="button" class="btn" data-toggle="modal" id="save" onclick="scroll2data('updateForm');"><i class="icon-plus"></i>添 加</button>
			<button id="chongzhi" type="reset" class="btn" onclick="chongzhi()"><i class="icon-repeat"></i>重置</button>
			<button type="reset" class="btn" onclick="refresh()"><i class="icon-remove"></i>刷新</button>
			<button id="add_button" type="button" class="btn" onclick="doSave()" style="display: none;"><i class="icon-ok" ></i>确认添加</button>
			<button id="update_button" type="button" class="btn" onclick="doUpdate()"  style="display: none;"><i class="icon-ok"></i>确认修改</button>
		</div>
</div>
   	<form class="form-horizontal" id="updateForm" >
   	<!-- 栅格布局 -->
	<div id="update"  class="row" style="width: 1300px; " >
           <div class="span6">
                 <div class="control-group">
					<label class="control-label" for="productionId">
						权限类型：
					</label>
					<div class="controls">
						<select id="quanxianleixing" name="typeName" >
						</select>
					</div>
				</div>
				<div class="control-group" id="path">
					<label class="control-label" for="bItem">
						路径:
					</label>
					<div class="controls">
						<input type="text" id="alias1"  name="alias1" placeholder="">
					</div>
				</div>
				<div class="control-group" id="gongneng">
					<label class="control-label" for="bItem">
						功能id:
					</label>
					<div class="controls">
						<input type="text" id="funId"  name="funId" placeholder="">
					</div>
				</div>
				<div class="control-group" style="display: none;">
					<label class="control-label" for="sItem" >
						id:
					</label>
					<div class="controls">
						<input type="text"  name="id" placeholder="">
					</div>
				</div>
				<div class="control-group" id="mokuai">
					<label class="control-label" for="bItem">
						模块id:
					</label>
					<div class="controls">
						<input type="text" id="modleId"  name="modleId" placeholder="">
					</div>
				</div>
           </div>
           
            <div class="span6">
           
				<div class="control-group" id="quanxianmingcheng" >
					<label class="control-label" for="desc">
						权限名称：
					</label>
					<div class="controls">
						<input type="text" id="name"  name="name" placeholder="">
					</div>
				</div>
            	
            	<div class="control-group" id="gongnengmingcheng">
					<label class="control-label" for="inputpeizhiItemValue">
						功能名称：
					</label>
					<div class="controls">
						<input type="text" id="funName" name="funName" placeholder="">
					</div>
				</div>
           </div>
           <div class="span6" id="gongnneg">
				<div class="control-group" id="mokuaimingcheng">
					<label class="control-label" for="inputpeizhiItemValue">
						模块名称：
					</label>
					<div class="input-append" style="padding-top: 9px; padding-left: 20px;">
						<input type="text" id="modleName"  name="modleName"  class="span2"  placeholder="">
						<button  type="button" class="btn" onclick="addOrg()">选择模块</button>
					</div>
				</div>
				
		 </div>
		 
		 
	</div>
   </form>
   		<div id="roleWin">
			<iframe src="" style="border: 0; width: 95%; height: 95%" class="hide"></iframe>
		</div>
		<div id="orgWin">
			<iframe src="" style="border: 0; width: 95%; height: 95%" class="hide"></iframe>
		</div>
</body>
</html>
