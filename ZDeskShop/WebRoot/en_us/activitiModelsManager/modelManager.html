<!DOCTYPE  HTML>
<html lang="en">
	<head>
		<title>工作流程模型管理</title>

		<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
		<meta http-equiv="description" content="this is my page">
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<link rel="stylesheet" href="../../css/bootstrap.min.css"
			type="text/css"></link>
		<link rel="stylesheet"
			href="../../js/dataTables/css/jquery.dataTables.css" type="text/css"></link>
		<!-- bootstrap 与 datatable结合 -->
		<link rel="stylesheet" href="../../js/dataTables/css/DT_bootstrap.css"
			type="text/css"></link>
		<!-- 工具 -->
		<link rel="stylesheet"
			href="../../js/dataTables/css/dataTables.tableTools.min.css"
			type="text/css"></link>
		<!-- 动态列CSS -->
		<link rel="stylesheet" href="../../js/dataTables/css/font-awesome.css"></link>
		<link rel="stylesheet"
			href="../../js/dataTables/css/dataTables.colVis.min.css"
			type="text/css"></link>
		<script type="text/javascript" src="../../js/jquery.js"></script>
		<script type="text/javascript" src="../../js/bootstrap.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/jquery.dataTables.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.colReorder.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.colVis.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/dataTables.tableTools.min.js"></script>
		<script type="text/javascript"
			src="../../js/dataTables/js/DT_bootstrap.js"></script>
		<script type="text/javascript" src="../../js/common_utils.js"></script>
		<script type="text/javascript" src="../../js/appCommonUtil.js"></script>
		<script type="text/javascript" src="../../js/golbal_params.js"></script>
		<script type="text/javascript" src="../../js/common_validation.js"></script>
		<style type="text/css">
.form-horizontal .control-label {
	float: left;
	width: 100px;
	text-align: right;
	padding-left: 0px !important;
	padding-top: 2px;
	padding-bottom: 2px;
}

.form-horizontal .controls {
	padding: 5px 0px;
	line-height: 5px;
	width: 200px !important;
	margin-left: 0px !important;
	float: left;
	padding-bottom: 2px;
	padding-top: 0px;
}

#dictbody td.red {
	font-weight: bold;
	color: red;
}

#dictbody td {
	text-align: center;
}
</style>
		<script>
var baseUrl="/ZDesk/activitiManager/activitiAdmin/";
var doNow=false;
var isSave=false;
var seurityNode=false;
var gridPager=false;
var nowRecord={};
var pageNumber=1; 
var gridPageSize=10;
var modelId="";
$(document).ready(function(){
	$('#activitibody').dataTable({
		'bPaginate':true,//分页器
		'bLengthChange': false,
		'bStateSave':true, //保留状态
		'bSort':true,//按列排序
		'bInfo':true,//页脚信息
		'bAutoWidth':false, //自动宽度
//		'sScrollX':'1600',//垂直滚动条,滚动区域
		'sScrollY':'400px',
		'sPaginationType': 'bootstrap',//分页样式
		'dom': 'TRlrtip',
		"scrollCollapse": false,
		'data':'',
		'columns': [
			{"title":"模型标识" ,data: 'key'},
			{"title":"模型名称" ,data: 'name'},
			{"title":"建立时间" ,data: 'createTime'},
			{"title":"最后更新时间" ,data: 'lastUpdateTime'}
		],
		"oLanguage": {
  			"sSearch": "搜索:",
  			"sLengthMenu": "每页显示 _MENU_ 条记录",
 			"sZeroRecords": "Nothing found - 没有记录",
  			"sInfo": "显示第  _START_ 条到第  _END_ 条记录,一共  _TOTAL_ 条记录",
  			"sInfoEmpty": "显示0条记录",
  			"oPaginate": {
  				"sFirst": "首页",
   				"sPrevious": " 上一页 ",
   				"sNext":     " 下一页 ",
   				"sLast": "尾页"
   			}
  		}, tableTools: {
          	//single 单选 multi 多选  os 可以按ctrl 选择
           	// sRowSelect:'multi',
           	//回调 单选
           	fnRowSelected: function ( nodes ) {
            	var index=nodes[0]._DT_RowIndex;	
				var data = table.row(index).data();
				if(data.id!=undefined){
					modelId=data.id;
				}
//               	OpenForm(data);
               	//alert(JSON.stringify(data));
            },
            sRowSelect:'os',
            //sRowSelector:'td:first-child',
            aButtons:     [ /*{
            "sExtends":    "select_all",
            "sButtonText": "选择全部",
            "target":      "#select"
              } , 'select_none' */]
        	}
	});
	var table= $('#activitibody').DataTable();
	table.page.len('10').draw();
	$('#activitibody tbody').on( 'click', 'button', function (obj) {
		var data = table.row( $(this).parents('tr') ).data();
	});
	var colvis = new $.fn.dataTable.ColVis(table,{ buttonText: '自定义显示列',exclude: [ 0 ,-1] });
    $( colvis.button()).insertBefore('#cols');   
});

/**添加新的流程**/
function openAdd(){
	$("#addModel").modal('show');
}
function doSaveDate(){
	var url=baseUrl + "doCreateModel.action";
	var pdata=zkm_getHtmlFormJsons('addOrderForm');
	if(formSubmitVaildate(pdata)){
		ajaxFunction(url, pdata, false, function(data) {
			if (data.success) {
				$("#addModel").modal('hide');
				modelsSearch();
			}else{
				alert('提示',"创建失败");
				return;
			}
		});
	}
}

/**查询流程**/
function doSearch(){
	var data = modelsSearch();
	drawTable(data);
}
function modelsSearch(){
	var url ;
	var ACTIVITI_DATA ={} ;
	url =baseUrl+"getProcesseModels.action";
	var param = {} ;
	param.key = "" ;
	ajaxFunction(url, "", false, function(data) {
		if(data=='error'){
			return;
		}
		if (data.success) {
			ACTIVITI_DATA = data.data ;
			$("#addModel").modal('hide');
		}
	});
	return ACTIVITI_DATA ;
}
function drawTable(data){
	var table=$('#activitibody').DataTable();
	table.search("").draw();
	table.clear().draw();
	table.rows.add(data).draw(true);	
}

/**编辑流程模型**/
function doEdit(){
	var url="/activitiModeler/service/editor?id=";
	var id=modelId;
	if(id!=""&&id!=undefined){
		window.open(url + id);
	}else{
		alert("请选择要编辑的数据。");
	}
}

/**删除模型**/
function doDelData(){
	var id=modelId;
	var pdata = {} ;
	pdata['id']=modelId ;
	if(id!=null && id!=undefined && id!=''){
		var url=baseUrl + "doDeleteModel.action";
 		var r=confirm("被删除的数据不可恢复，请确认删除。")
  		if (r==true){
			ajaxFunction(url, pdata, false, function(data) {
				if (data.success) {
					doSearch();
				}
				alert(data.mgs);
			});
    	}
	}else{
		alert('请选择要删除的数据。');
	}
}

/**发布流程**/
function doDeploy(){
	var id=modelId;
	var pdata = {} ;
	pdata['id']=modelId ;
	if(id!=null && id!=undefined && id!=''){
		var url=baseUrl + "deployProcess.action";
 		var r=confirm("请确认发布该版本流程。")
		if (r==true){
			ajaxFunction(url, pdata, false, function(data) {
				if (data.success) {
					doSearch();
				}
				alert(data.mgs);
			});
		}
	}else{
		alert("请选择要发布的流程模型数据。");
	}
}

/**xml导出**/
function doExport(){
	var id=modelId;
	var pdata = {} ;
	pdata['id']=modelId ;
	if(id!=null && id!=undefined && id!=''){
		var url=baseUrl + "doExprotModel.action?id=" + id;
		var frm=$("body").append('<iframe id="body_down_frm" src="' + url + '" style="display: none"></iframe>');
	}else{
		alert("请选择要导出的流程模型数据。");
	}
}

/**导入**/
function doImport(){
	$('#activitiXmlStr').val("");
	$("#addModelImport").modal('show');
}
function doCloseModel(){
	$('#activitiXmlStr').val("");
	$('#addModelImport').modal('hide');
}
function doSaveActivitiStr(){
	var id=modelId;
	var pdata = {} ;
	pdata['id']=modelId ;
	if(id!=null && id!=undefined && id!=''){
		var activitiXmlStr = $("#activitiXmlStr").val();
		var url=baseUrl + "deployProcessWithStr.action";
		pdata['activitiXmlStr'] = activitiXmlStr;
		if(activitiXmlStr!=null&&activitiXmlStr!=""&&activitiXmlStr!=undefined){
			var r=confirm("请确认发布该版本流程。")
			if (r==true){
				ajaxFunction(url, pdata, false, function(data) {
					if (data.success) {
						nowRecord={};
						doCloseModel();
						doSearch();
					}
					alert(data.mgs);
				});
			}
		}else{
				alert("请填写需要发布的流程模型数据。");
		}
	}else{
		alert("请选择要导出的流程模型数据。");
	}
}

/**重置activiti参数**/
function initActivitiParam(){
	var url=baseUrl + "reloadActivitiParam.action";
	ajaxFunction(url, {}, false, function(data) {
		if (data.success) {
			alert("activiti参数重置成功！");
		}else{
			alert("activiti参数重置失败！");
		}
	});
}

function formSubmitVaildate(data){
	if(data["key"]==''){
		alert("请填写key.");
		return false;
	}
	if(data["name"]==''){
		alert("请填写名称");
		return false;
	}
//	alert(V_checkIsChinese(data["key"]));
	if(!V_checkIsChinese(data["key"])){
		alert("key不允许为中文。");
		return false;
	}
	return true;
}
</script>

	</head>

	<body>
		<div
			style="width: 1105px; margin-left: 3px;"
			cellspacing="0">
			<div class="widget-box collapsible" style="width: 1100px;">
				<div class="widget-title" style="height: 40px;">
					<span class="icon"><i class="icon-search"></i> </span>
					<div id="cols"></div>
					<div style="padding-top: 5px; margin-left: 45px">
						<button type="button" id="btn_add" class="btn"
							onclick="doSearch();">
							<i class="icon-search"></i> 查 询
						</button>
						<button type="button" id="btn_add" class="btn"
							onclick="openAdd();">
							<i class="icon-plus"></i> 新 建
						</button>
						<button type="button" id="btn_add" class="btn" onclick="doEdit();">
							<i class="icon-pencil"></i> 编 辑
						</button>
						<button type="button" id="btn_add" class="btn"
							onclick="doDelData();">
							<i class="icon-remove"></i> 删 除
						</button>
						<button type="button" id="btn_add" class="btn"
							onclick="doDeploy();">
							<i class="icon-share"></i> 发 布
						</button>
						<button type="button" id="btn_add" class="btn"
							onclick="doExport();">
							<i class="icon-arrow-down"></i> 导出xml
						</button>
						<button type="button" id="btn_add" class="btn"
							onclick="doImport();">
							<i class="icon-arrow-up"></i> 导入xml
						</button>
						<button type="button" id="btn_add" class="btn"
							onclick="initActivitiParam();">
							<i class="icon-repeat"></i> 重置activiti参数
						</button>
					</div>
				</div>
			</div>
			<div id="" style="width: 1100px; margin-left: 2px; padding-right: 2px;height:600px">
				<table  
					class="table table-striped table-bordered " id="activitibody"></table>
			</div>
		</div>
		
		<div id="addModel" class="modal hide fade in">
			<form action="" class="form-horizontal " id="addOrderForm">
				<div class="modal-header">
					<a class="close" data-dismiss="modal">×</a>
					<h5>
						新建流程
					</h5>
				</div>
				<div class="container " style="width: 600px !important;margin-top:5px">
					<div class="span6">
						<div class="control-group ">
							<label class="control-label">
								<font color="red">*</font>模型key：
							</label>
							<div class="controls">
								<input type="text" style="width: 155px" id="key"
									name="key" />
							</div>
						</div>
					</div>
					<div class="span6">
						<div class="control-group ">
							<label class="control-label">
								<font color="red">*</font>模型名称：
							</label>
							<div class="controls">
								<input type="text" style="width: 155px" id="name"
									name="name" />
							</div>
						</div>
					</div>
					<div class="span6">
						<div class="control-group ">
							<label class="control-label">
								备注：
							</label>
							<div class="controls">
								<textarea rows="3" class="form-control" style="width: 280px"
									cols="6" id="description" name="description"></textarea>
							</div>
						</div>
					</div>
				</div>
			</form>
			<div class="modal-footer">
				<a class="btn btn-success" onclick="doSaveDate()">确定</a>
				<a class="btn" data-dismiss="modal">关闭</a>
			</div>
		</div>
		<div id="addModelImport" class="modal hide fade in">
			<form action="" class="form-horizontal " id="addOrderForm">
				<div class="modal-header">
					<a class="close" data-dismiss="modal">×</a>
					<h5>
						新建流程
					</h5>
				</div>
				<div class="container " style="width: 800px !important;margin-top:5px">
					<div class="span6">
						<div class="control-group ">
							<label class="control-label">
								导入xml：
							</label>
							<div class="controls">
								<textarea style="width: 400px" id="activitiXmlStr" name="activitiXmlStr" rows="15" cols="108">
							</textarea>
							</div>
						</div>
					</div>
				</div>
			</form>
			<div class="modal-footer">
				<a class="btn btn-success" onclick="doSaveActivitiStr()">确定</a>
				<a class="btn" data-dismiss="modal" onclick="$('#activitiXmlStr').val('')">关闭</a>
			</div>
		</div>
	</body>
</html>
