<!DOCTYPE html>
<html lang="en">

	<head>
		<title>菜单权限</title>

		<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
		<meta http-equiv="description" content="this is my page">
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">

		<!--<link rel="stylesheet" type="text/css" href="./styles.css">-->
		<link rel="stylesheet" href="../../../css/bootstrap.min.css" type="text/css"></link>
		<link rel="stylesheet" href="../../../css/bootstrap-responsive.min.css" type="text/css"></link>
		<link rel="stylesheet" href="../../../js/dataTables/css/DT_bootstrap.css" type="text/css"></link>
		<link rel="stylesheet"href="../../../js/dataTables/css/jquery.dataTables.css" type="text/css"></link>
		<link rel="stylesheet" href="../../../js/dataTables/css/font-awesome.css"></link>	
		<script type="text/javascript" src="../../../js/jquery.js"></script>
		<script type="text/javascript" src="../../../js/bootstrap.js"></script>
		<script type="text/javascript" src="../../../js/common_utils.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/jquery.dataTables.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/dataTables.tableTools.min.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/DT_bootstrap.js"></script>
		<script type="text/javascript"  src="../../../js/appCommonUtil.js"></script>
<style type="text/css">
	
	    tr td:first-child {
	        text-align: center;
	    }
	    tr td:first-child:before {
	        content: "\f096"; 
	        font-family: FontAwesome;
	    }
	    td{text-align: center;}
	    tr.active td:first-child:before {
	        content: "\f046"; /* fa-check-square-o */
	    }
	    
	    .title_center{
	      algin:center;
	    }
	   
	</style>
<script type="text/javascript">
	   var table=false;
		//权限集合
	   var permissonArray=[];
	   var isSelect=[];
	   var PRJ_PATH=window.top.PRJ_PATH||"ZDesk";
	   var ZDesk_ROU=window.top.ZDesk_ROU||"ZDesk";
	   $(document).ready(function(){
	   
	        getBasePermissonByRole();

		   	table=$('#tt').DataTable({
		        bPaginate: false, //翻页功能
				bLengthChange: false, //改变每页显示数据数量
				bFilter: false, //过滤功能
				bSort: true, //排序功能
				bInfo: false,//页脚信息
				bAutoWidth: true, //自动宽度
			    dom: 'Tlrtip',
				columns: [
					{
					 title:"",
                     data: null, 
                     defaultContent:'', 
                     orderable: false ,
					 width:"20px"
					},
			        {
			        // title:"<center>基础权限</center>",
			         data:'name',
			         width:"100px"
			         //className: "title_center" 
	                }    
		        ],
		        oLanguage: {
					"sLengthMenu": "每页显示 _MENU_条",
					"sZeroRecords": "没有找到符合条件的数据",
					"sProcessing": "&lt;imgsrc=’./loading.gif’ /&gt;",
					"sInfo": "当前第 _START_ - _END_ 条　共计 _TOTAL_ 条",
					"sInfoEmpty": "木有记录",
					"sInfoFiltered": "(从 _MAX_ 条记录中过滤)",
					"sSearch": "搜索：",
					"oPaginate": {
								"sFirst": "首页",
								"sPrevious": "前一页",
								"sNext": "后一页",
								"sLast": "尾页"
					        }
		        }, tableTools: {
		             fnRowSelected: function ( nodes ) {
		              // var index=nodes[0]._DT_RowIndex;	
		              // var data = table.row(index).data();
		              // initForm(data);
		            },
		            sRowSelect:'multi',
		            aButtons:[]
		        },createdRow: function( row, data, dataIndex ) {
				    { 
				      for(var i=0;i<permissonArray.length;i++){
				            if(permissonArray[i]==data.id){
				              // $(row).addClass( 'active' );
				              isSelect.push(dataIndex);
				              // selectRow(dataIndex);
				               break;
				            }
				          
				      }
				     
				    }
				 } 
		   });
		    //$('#tt').width( $(".scrolltable").width() );
		    
		   var data=getSuSecurityPermissionInfo("base");
	       table.rows.add(data).draw(true);
	       //勾选已有权限
	       selectRow();
	   });
           
   function doSearch(){
		//通用查询action路径
		var param={}
		//获取基础权限
		param.typeName="base";
		var url = "/" + PRJ_PATH + "/" + ZDesk_ROU+"/suSecurityPermission" + "/" + "searchSuSecurityPermission.action";
		   var rdata=[];
		   	$.ajax({
				async :false,
				type : "post",
				url : url,
				dataType : "json",
				data : param,
				success : function(data) {
					if(data) {	              
		              rdata=data.data;
					}
				},
				error : function(r){
				   alert("error");			
				}
				});
		     return rdata;
		} 
	        	//刷新	
	function refresh(){
	     var table=$('#test').DataTable();
	     $("#shaixuan").val('');
	     table.clear().draw();
	     //重新加载数据
	     var data=doSearch(); 
	     table.rows.add(data).draw(true);
	}   
    function  getParams(){
	    var selectData=table.rows(".active").data();
	    var pCodesp=[];
	    for(var i=0;i<selectData.length;i++){
	       var sd=selectData[i];
	       pCodesp.push(sd.id);
	    }
	    var permisstionCodes=pCodesp.join(",");
	    var params=window.parent.getRoleCodeAndType();
        
        return $.extend(params,{'permisstionCode':permisstionCodes});
    } 
    
    function addPermissonMapRole(){
      var params=getParams();
      if(params.roleCode==undefined||params.roleCode==null||params.roleCode==""){
           //alert("请选择角色");
            window.parent.zinglabs.i18n.alert("permission_role");
           return ;
      }
      var url="/"+PRJ_PATH+"/"+ZDesk_ROU+"/permissonMappingRole/addPermisson.action";
      ajaxFunction(url,params,false,function(data){
           if(data&&data.success){
               window.parent.zinglabs.i18n.alert("permission_success");
           }else{
               window.parent.zinglabs.alert(data.mgs);
           }
      });
    } 
    // 获取角色 根据角色id
     function getBasePermissonByRole(){
          var params=window.parent.getRoleCodeAndType()
	      if(params.roleCode==undefined||params.roleCode==null||params.roleCode==""){
	           zinglabs.i18n.alert("permission_role");
	           return ;
	      }
          var url="/"+PRJ_PATH+"/"+ZDesk_ROU+"/permissonMappingRole/getPermissonCode.action";
	      ajaxFunction(url,params,false,function(data){
	           if(data&&data.success){
	               permissonArray=data.data;
	               return true;
	           }else{
	                window.parent.zinglabs.alert(data.mgs);
	           }
	      });
	      
         return false;  
      }   
      
      function selectRow(){
         var oTT = TableTools.fnGetInstance('tt');
         var length=isSelect.length;
          if(length>=0){
	            for(var i=0;i<length;i++){
	              var index=isSelect[i];
	              oTT.fnSelect( $('#tt tbody tr')[index]);
	            }
            
           } 
      } 
		</script>

	</head>

	<body> 
	
		 <div class="row-fluid">
		     <button type="button" class="btn btn-primary"  onclick="addPermissonMapRole()">授权</button>
			  
		 </div>
		   <div class="row-fluid">
		     <div class="span2">
			  <table id="tt"  width="300px" class="table table-striped table-bordered" cellspacing="0">
		             <thead>
		               <tr><th></th><th>基础权限</th></tr>
		             </thead>
			  </table>
			 </div>  
		  </div>
		 
		 
	</body>
</html>
