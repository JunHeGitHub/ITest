<!DOCTYPE html>
<html lang="en">
	<head>
		<title>角色授权--修改</title>
		<link rel="stylesheet" href="../../../css/bootstrap.min.css" type="text/css"></link>
		<link rel="stylesheet" href="../../../css/bootstrap-responsive.min.css"
			type="text/css"></link>
		<script type="text/javascript" src="../../../js/jquery.js"></script>
		<script type="text/javascript" src="../../../js/bootstrap.js"></script>
		<script type="text/javascript" src="../../../js/appCommonUtil.js"></script>
		<script type="text/javascript" src="../../../js/common_utils.js"></script>
		<script type="text/javascript">
var data_getRoleByloginName;
var loginname;
var pwin = window.parent
//下拉框交换JQuery
$(function(){
     var data_all=doSearch();
     var select1 = $("#select1"); 
      select1.empty();//清空select下拉框

    for(var i=0;i<data_all.length;i++){
        $("<option value='" + data_all[i].id + "'>" + data_all[i].name + "</option>").appendTo(select1)//动态添加Option子项
    }
     data_getRoleByloginName=doSearch_getRoleByloginName();
     var select2 = $("#select2"); 
      select2.empty();//清空select下拉框

    for(var i=0;i<data_getRoleByloginName.length;i++){
        $("<option value='" + data_getRoleByloginName[i].id + "'>" + data_getRoleByloginName[i].name + "</option>").appendTo(select2)//动态添加Option子项
    }
       
    //移到右边
    $('#add').click(function() {
      //获取选中的选项，删除并追加给对方
        var array = new Array(); //定义数组
        $("#select2 option").each(function(){ //遍历全部option
        var txt = $(this).val(); //获取option的内容
            array.push(txt); //添加到数组中
        });
       var sid=$('#select1 option:selected').val();
      
      
       if($.inArray(sid, array)==-1){
          $('#select1 option:selected').appendTo('#select2');
       }
        
    });
    //移到左边
    $('#remove').click(function() {
        $('#select2 option:selected').appendTo('#select1');
    });
      $('#select1').dblclick(function(){ //绑定双击事件
        var array = new Array(); //定义数组
        $("#select2 option").each(function(){ //遍历全部option
        var txt = $(this).val(); //获取option的内容
            array.push(txt); //添加到数组中
        });
       var sid=$('#select1 option:selected').val();
       if($.inArray(sid, array)==-1){
          $('#select1 option:selected').appendTo('#select2');
       }
    });
    //双击选项
    $('#select2').dblclick(function(){
       $("option:selected",this).appendTo('#select1');
    });
    /**
    //全部移到右边
    $('#add_all').click(function() {
        //获取全部的选项,删除并追加给对方
        $('#select1 option').appendTo('#select2');
    });
    //全部移到左边
    $('#remove_all').click(function() {
        $('#select2 option').appendTo('#select1');
    });
    //双击选项
  **/             
});

	function doSearch(){	
		//通用查询action路径
		loginname=getQueryString("loginName");
		var url = "/" + "ZDesk" + "/" + "ZKM/RoleCurd" + "/" + "getRoleNotInLoginName.action?loginName="+loginname;
		var params={};
		params.nameSpace ="com.zinglabs.apps.suPermission";
		params.nameSpaceId = "getRoleNotInLoginName";
		var rdata=[];
		ajaxFunction(url,params,false,function(data){
			if (data) {
		    	rdata=data.rows;
			}
		});
		return rdata;
	}
						
	function doSearch_getRoleByloginName(){	
		loginname=getQueryString("loginName");
		//通用查询action路径
		  var url = "/" + "ZDesk" + "/" + "ZKM/RoleCurd" + "/" + "getRoleByLoginName.action?loginName="+loginname;
		  var params={};
		  //params.tableName ="suSecurityUserAndRole";
	      params.nameSpace ="com.zinglabs.apps.suPermission";
		  params.nameSpaceId = "getRoleByLoginName";		    
		  var rdata=[];
		  ajaxFunction(url,params,false,function(data){
		  	if (data) {
		    	rdata=data.rows;
			}
		   });
		return rdata;
	}
	function doSave(){
		var array = new Array(); //定义数组
        $("#select2 option").each(function(){ //遍历全部option
        var txt = $(this).val(); //获取option的内容
            array.push(txt); //添加到数组中
        });
		//alert(array);
		var param='';
		//alert(JSON.stringify(data_getRoleByloginName));
		 for(var i=0;i<data_getRoleByloginName.length;i++){
			 param = param + data_getRoleByloginName[i].id+',';
		 }
		 param = param.substr(0,param.length-1);
		 if(param==''||param==null){
		 	var a=array.join(",");
			var url = "/" + "ZDesk" + "/" + "ZKM/RoleCurd" + "/" + "GiveRoleForUser.action?loginName="+loginname;
		    var params={};
		    params.tableName ="suSecurityUserRole";
	        params.nameSpace ="com.zinglabs.apps.suPermission";
		    params.nameSpaceId = "addUserRole";
		    params.primaryKey = "id";		    
		    params.primaryKeyValue = a;
		    ajaxFunction(url,params,false,function(data){
        		if(data["true"]){				              
					var pat = {};
					pat.roleIdList = a;
					var reFillFn = getQueryString("reFillFn");
	        		pwin[reFillFn](pat);
	        		return;
				}else if(data['no']=='no'){
				 	zinglabs.i18n.alert("yonghuguanli_qingweiyonghuxuanzejuese");
				 	return;
				}else{
					zinglabs.i18n.alert("yonghuguanli_caozuoshibai");
					return;
				}
		   });
		 }else{
		 	var url = "/" + "ZDesk" + "/" + "ZKM/CommonsCurd" + "/" + "Delete.action";
		    var params={};
		    params.tableName ="suSecurityUserRole";
		    params.nameSpace ="com.zinglabs.apps.commons.pojo";
		    params.nameSpaceId = "del";
		    params.primaryKey = "loginName";
		    params.primaryKeyValue = loginname;
			ajaxFunction(url,params,false,function(data){
				if (data.success) {
					var a=array.join(",");
					url = "/" + "ZDesk" + "/" + "ZKM/RoleCurd" + "/" + "GiveRoleForUser.action?loginName="+loginname;
					params={};
				    params.tableName ="suSecurityUserRole";
			        params.nameSpace ="com.zinglabs.apps.suPermission";
				    params.nameSpaceId = "addUserRole";
				    params.primaryKey = "id";		    
				    params.primaryKeyValue = a;
				    ajaxFunction(url,params,false,function(data){
				    	if(data["true"]){				              
							var pat = {};
							pat.roleIdList = a;
							var reFillFn = getQueryString("reFillFn");
		        			pwin[reFillFn](pat);
		        			return;
						}else if(data['no']=='no'){
					 		zinglabs.i18n.alert("yonghuguanli_qingweiyonghuxuanzejuese");
					 		return;
						}else{
							zinglabs.i18n.alert("yonghuguanli_caozuoshibai");
							return;
						}
				    });
				}
		   });
		 }	
	}
</script>
</head>
	<body>
		<br />
		<br />
		<table width="700" align="center" border="0" cellpadding="0" cellspacing="0" class="newContTab">
			<tr>
				<td>
					<div>
						<div>
							<select multiple="multiple" id="select1"
								style="width: 300px; height: 200px; float: left;">
							</select>
						</div>
						<div style="float: left">
							<br />
							<br />
							<br />
							<span id="add"> <input type="button" class="btn"
									value="》》" /> </span>
							<br />
							<span id="remove"> <input type="button" class="btn"
									value="《《" /> </span>
							<br />
						</div>
						<div>
							<select multiple="multiple" name="s" id="select2"
								style="width: 300px; height: 200px; float: left;">
							</select>
						</div>
					</div>
				</td>
			</tr>
			<tr>
				<td>
					<div>
						<div>
							<span style="width: 300px; height: 30px; float: left;"> </span>
						</div>
						<div style="float: left">
							<span>
								<button type="button" class="btn btn-default" style="width: 70px" data-toggle="modal" onclick="doSave()">
									提交
								</button> </span>
						</div>
						<div>
							<span style="width: 300px; height: 30px; float: left;"> </span>
						</div>
					</div>
				</td>
			</tr>
		</table>
	</body>
</html>