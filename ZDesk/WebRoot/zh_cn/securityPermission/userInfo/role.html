<!DOCTYPE  HTML>
<html lang="en">
	<head>
		<title>角色模块管理</title>
		<meta http-equiv="keywords" content="keyword1,keyword2,keyword3" />
		<meta http-equiv="description" content="this is my page" />
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=9;IE=8;IE=EDGE" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/bootstarp/bootstrap.min.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/bootstarp/bootstrap-responsive.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/css/zinglabs.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/dataTables/css/jquery.dataTables.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/dataTables/css/DT_bootstrap.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/dataTables/css/dataTables.tableTools.min.css"/>
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/dataTables/css/font-awesome.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/dataTables/css/dataTables.colVis.min.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/dataTables/css/dataTables.responsive.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/artdialog/ui-dialog.css" />
		<style type="text/css">
			#test tr td:first-child {
				text-align: center;
			}
			
			/* fa-square-o */
			#test tr td:first-child:before {
				content: "\f096";
				font-family: FontAwesome;
			}
			
			#test tr.active td:first-child:before {
				content: "\f046"; /* fa-check-square-o */
			}
			
			#myModal9 {
				min-width: 800px;
				max-height: 600px;
				margin-left: -30%;
			}
			
			#myModal9 .modal-body {
				max-height: 1000px;
			}
			
			#myModal9 .modal-body #ttt {
				width: 100%;
				min-height: 300px;
			}
			
			#myModal20 {
				min-width: 800px;
				max-height: 600px;
				margin-left: -30%;
			}
			
			#myModal20 .modal-body {
				max-height: 1000px;
			}
			
			#myModal20 .modal-body #ttt6 {
				width: 100%;
				min-height: 300px;
			}
			
			#myModal16 {
				min-width: 800px;
				max-height: 600px;
				margin-left: -30%;
			}
			
			#myModal16 .modal-body {
				max-height: 1000px;
			}
			
			#myModal16 .modal-body #ttt6 {
				width: 100%;
				min-height: 300px;
			}
			
			.sorting {
				text-align: center;
			}
			
			.dataTables_scrollBody {
				overflow-x: auto !important;
			}
		</style>
	</head>
	<body>
		<!-- 容器 -->
		<div class="zing_container">
			<!-- datatable部分 包含筛选项 -->
			<div class="head">
				<!-- dataTable筛选项部分 -->
				<div class="widget-box collapsible">
					<div class="widget-title">
						<span class="icon"> <i class="icon-search"></i> </span>
						<h5>
							配置项搜索
						</h5>
						<div class="buttons">
							<button class="btn btn-mini" onclick="jQuery.fx.off = false;$('#collapseOne').slideToggle(200);">
								<i class="icon-retweet"></i>展开/关闭
							</button>
						</div>
					</div>
					<div class="collapse in" id="collapseOne">
						<!--TODO 里面写查询项表单布局 -->
						<div class="widget-content container">
							<form action="" id="roleSearchForm">
								<div style="height: 20px;"></div>
								<div class="row-fluid zing_row">
									<div class="span2 zing_span2"></div>
									<div class="span8 zing_span8">
										<div class="form-horizontal zing_form_horizontal">
											<div class="control-group zing_control-group">
												<label class="control-label zing_control-label" for="name_search">
													角色名称：
												</label>
												<div class="controls zing_controls">
													<input id="name_search" name="search" class="zing_input_span6_append_icon" type="text" />
													<button type="button" class="btn" onclick="doSearch1();" id="sousuo"> 
														<i class="icon-search"></i>搜 索
													</button>
													<button type="button" id="btn_clean" class="btn"
														onclick="cleanSearchForm()">
														<i class="icon-remove"></i> 清空
													</button>
												</div>
											</div>
										</div>
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
				<!-- dataTable 部分 -->
				<div class="widget-box">
					<div class="widget-title">
						<span class="icon"> <i class="icon-th"></i> </span>
						<h5>
							信息
						</h5>
						<div class="buttons">
							<a class="btn btn-mini" id="shuaxin" onclick="refresh()" href="javascript:;;"><i class="icon-refresh"></i> 刷 新</a>
						</div>
					</div>
					<div class="widget-content nopadding">
						<!-- 提示栏 -->
						<div class="alert alert-error" id="errorDiv" style="display: none;">
						</div>
						<div class="alert alert-success" id="successDiv" style="display: none;">
						</div>
						<!--TODO 数据表格内容 -->
						<table id="test" class="table table-striped table-hover dt-responsive" width="100%" style="width: 100%;"></table>
					</div>
				</div>
				<div class="foot">
					<div class="widget-box " style="margin-top: 0px">
						<!-- 功能栏 -->
						<div class="navbar-inner" style="padding-top: 10px">
							<!--TODO 一些按钮-->
							<button type="button" class="btn btn-primary" onclick="GetSaveBtn()" id="tianjia">
								添 加
							</button>
							&nbsp;
							<button type="button" class="btn btn-danger" onclick="fnGetSelected()" id="shanchu">
								删 除
							</button>
							&nbsp;
							<button type="button" class="btn btn-defaul" onclick="doUpdateOrAddUserForRole()" id="xiugaiyonghu">
								修改/添加用户
							</button>
							&nbsp;
							<button type="button" class="btn btn-defaul" onclick="doUpdateOrAddPermiForRole()" id="xiugaiquanxian">
								修改/添加权限
							</button>
						</div>
						<!-- 表单项  update insert 先用一个表单 有需要就分开 -->
						<div class="widget-content container hide" id="update">
							<!--TODO  表单-->
							<form id="updateForm">
								<input type="hidden" id="id" name="id">
									<div class="row-fluid zing_row">
									<div class="span4 zing_span4">
										<div class="form-horizontal zing_form_horizontal">
											<div class="control-group zing_control-group">
												<label class="control-label zing_control-label" for="name">
													角色名称：
												</label>
												<div class="controls zing_controls">
													<input type="text" class="zing_input_span4" id="name" name="name" placeholder="请您填写角色名称">
												</div>
											</div>
										</div>
									</div>
									
									<div class="span4 zing_span4">
										<div class="form-horizontal zing_form_horizontal">
											<div class="control-group zing_control-group">
												<label class="control-label zing_control-label" for="description">
													角色描述：
												</label>
												<div class="controls zing_controls">
													<input type="text" class="zing_input_span4" id="description" name="description" placeholder="请您填写角色描述信息">
												</div>
											</div>
										</div>
									</div>
									<div class="span4 zing_span4">
										<div class="form-horizontal zing_form_horizontal">
											<div class="control-group zing_control-group">
												<label class="control-label zing_control-label" for="viewIndex">
													排序：
												</label>
												<div class="controls zing_controls">
													<input type="text" class="zing_input_span4" id="viewIndex" name="viewIndex" placeholder="请您填写排序序号">
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="row-fluid zing_row">
									<div class="span4 zing_span4">
										<div class="form-horizontal zing_form_horizontal">
											<div class="control-group zing_control-group">
												<label class="control-label zing_control-label" for="scoreWeight">
													权值：
												</label>
												<div class="controls zing_controls">
													<input type="text" class="zing_input_span4" id="scoreWeight" name="scoreWeight" placeholder="请您填写权值">
												</div>
											</div>
										</div>
									</div>
								</div>
								<center>
									<button type="button" id="btn_submit" class="btn hide btn_add" onclick="doSave()">
										添加提交
									</button>
									<button type="button" id="btn_submit" class="btn hide btn_edit" onclick="doUpdate()">
										修改提交
									</button>
								</center>
							</form>
						</div>	
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript" src="../../../js/jquery.js"></script>
		<script type="text/javascript" src="../../../js/bootstrap.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/jquery.dataTables.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/dataTables.colReorder.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/dataTables.colVis.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/dataTables.tableTools.min.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/DT_bootstrap.js"></script>
		<script type="text/javascript" src="../../../js/common_utils.js"></script>
		<script type="text/javascript" src="../../../js/appCommonUtil.js"></script>
		<script type="text/javascript" src="../../../js/appCommonCurdUtils.js"></script>
		<script type="text/javascript">
			var ZKM = "ZKM";
			var closeDialog;
			$(document).ready(function(){ 
				   clearForm();
				   var data=doSearch();
			       $('#test').dataTable({
			        bPaginate: true, //翻页功能
					bLengthChange: true, //改变每页显示数据数量
					bFilter: true, //过滤功能
					bSort: true, //排序功能
					bInfo: true,//页脚信息
					bAutoWidth: false, //自动宽度
					sPaginationType: "bootstrap",//分页样式				
					data:data,
				    dom: 'TRlrtip',
			        order: [ 1, 'des' ],
			        columns: [
						{ title:"<input type='checkbox' id='selectall' onclick='toggleChecks(this);'style='margin-left:37%'>",data: null, defaultContent: '', orderable: false ,width:30},
				       	{"title":"角色名称" ,data: 'name',width:200},
				        {"title":"角色描述",data:'description',width:200 },
				        {"title":"排序",data:'viewIndex',width:200}
			        ],
			        createdRow: function ( row, data, index ) {
			                $('td', row).eq(2).addClass('red');
			        } ,
			        //列筛选等属性 样式 可以与columns属性合并
			        oLanguage: {
						"sLengthMenu": "每页显示 _MENU_条",
						"sZeroRecords": "没有找到符合条件的数据",
						"sProcessing": "&lt;imgsrc=’./loading.gif’ /&gt;",
						"sInfo": "当前第 _START_ - _END_ 条　共计 _TOTAL_ 条",
						"sInfoEmpty": "无记录",
						"sInfoFiltered": "(从 _MAX_ 条记录中过滤)",
						"sSearch": "搜索：",
						"oPaginate": {
						"sFirst": "首页",
						"sPrevious": "前一页",
						"sNext": "后一页",
						"sLast": "尾页"
					    }
			        }, 
			        tableTools: {
				            fnRowSelected: function ( nodes ) {
				            changeBtn();
				            var index=nodes[0]._DT_RowIndex;	
				            var data = table.row(index).data();
				            initForm(data);
				            scroll2data("updateForm");
				            },
				             sRowSelect:'os',
				            aButtons:     [ /*{
				                "sExtends":    "select_all",
				                "sButtonText": "选择全部",
				                "target":      "#select"
				              } , 'select_none' */]
				        }
				    }); 
				    //绑定事件 on
					var table= $('#test').DataTable();
					$('#test tbody').on( 'click', 'button', function (obj) {
						var data = table.row( $(this).parents('tr') ).data();
					});
			     	var colvis = new $.fn.dataTable.ColVis(table,{ buttonText: '自定义显示列',exclude: [ 0 ,1] });
			    	$( colvis.button()).insertBefore('#cols');  
				});
				 function appendSearchItem(formName){
					var pat = {};
					var temp = "{";
					var cfs=$("#"+formName+" input[name]");
					for(var i=0;i<cfs.length;i++){
						var e=cfs[i];
						if(e.value != '' && e.value !=null && e.value != undefined){
							temp += "'"+e.name+"':'"+e.value+"',";
						}
					}
					temp = temp.substring(0,temp.length-1)+"}";
					if(temp.length != 1 && temp != ''){
						pat = eval("("+temp+")");
					}		
					return pat;
				}
				//打开角色添加或修改用户
				function openRoleForUserDig(url){
					var myDialog=dialog({
				    	title: '角色添加或修改用户',
				    	content: '<iframe src='+url+' style="border: 0; width: 100%; height: 100%"  frameborder="0"/>',
				    	width:'800',
				    	height:'400'
					});
					myDialog.show();
					return myDialog;	
				}
				//打开角色添加或修改权限
				function openRoleForPermissionDig(url){
					var myDialog=dialog({
					    title: '角色添加或修改权限',
					    content: '<iframe src='+url+' style="border: 0; width: 100%; height: 100%"  frameborder="0"/>',
					    width:'800',
					    height:'400'
					});
					myDialog.show();
					return myDialog;	
				}
				function doSearch(){	
					//通用查询action路径
			   		var url = "/" + window.top.PRJ_PATH + "/" +ZKM + "/CommonsCurd" + "/" + "Find.action";		
					var params={};
					params.tableName ="suSecurityRole";
					params.nameSpace ="com.zinglabs.apps.commons.pojo";
					params.nameSpaceId = "getList";
					var rdata=[];
			   		$.ajax({
						async :false,
						type : "post",
						url : url,
						dataType : "json",
						data : params,
						success : function(data) {
							if (data) {
								rdata=data.rows;
							}
						},
						error : function(r){
							zinglabs.i18n.alert('role_operationFailed');		
						}
					});
					return rdata;
				}
				//条件查询使用
				function doSearch1(){  
			    	var url = "/" + window.top.PRJ_PATH + "/" +ZKM+ "/RoleCurd" + "/" + "getRoleByRoleName.action";
			    	var params={};
			     	params.name=$("#name_search").val();
				 	if(params.name=="" || params.name==null || params.name ==undefined){
						params.name="";
				 	}
		        	params.nameSpace ="com.zinglabs.apps.suPermission";
			    	params.nameSpaceId = "getRoleByRoleName";
			    	var rdata=[];
			   		$.ajax({
						async :false,
						type : "post",
						url : url,
						dataType : "json",
						data : params,
						success : function(data) {
							if (data) {
			              		rdata=data.rows;
			              		var table=$('#test').DataTable();
				   		  		table.clear().draw();
				   		  		table.rows.add(rdata).draw();	
							}else{
								var table=$('#test').DataTable();
				        		table.clear().draw();
								zinglabs.i18n.alert('role_nowantedData');
							}
						},
						error : function(r){}
					});
			    	return rdata;
				}
				//获取选中行
				function fnGetSelected(){		
					var table=$('#test').DataTable();
					var tt = new $.fn.dataTable.TableTools(table);
					var selectData=tt.fnGetSelectedData();
					if(selectData.length<=0){
				    	zinglabs.i18n.alert('system_selectDataForDelete');		
					}else{
						zinglabs.confirm(zinglabs.i18n.getText("system_deleteConfirmation"),function (){      
					    	doDelete();
				    	});
					}
				}
				//删除
				function doDelete(){
					changeBtn();
					var table=$('#test').DataTable();
					var tt = new $.fn.dataTable.TableTools(table);
					var selectData=tt.fnGetSelectedData();
					var roleIdList = '';
					var roleCodeList = '';
					for(var i in selectData){
						roleIdList = roleIdList + '"'+selectData[i].id+'"'+',';
						roleCodeList = roleCodeList + '"'+selectData[i].name+'"'+',';
					}
					roleIdList = roleIdList.substr(0,roleIdList.length-1);
					roleCodeList = roleCodeList.substr(0,roleCodeList.length-1);
					//转码
					roleCodeList = nativeToascii(roleCodeList);
			    	var params={};
			    	params.roleIdList = roleIdList;
			    	params.roleCodeList = roleCodeList;
					//删除角色
					var url = "/" + window.top.PRJ_PATH +"/"+ZKM+"/RoleCurd/deleteRole.action";
					ajaxFunction(url,params,false);
					//删除角色用户关联
					url = "/" + window.top.PRJ_PATH +"/"+ZKM+"/RoleCurd/deleteRoleUser.action";
					ajaxFunction(url,params,false);
					//删除角色权限关联
					url = "/" + window.top.PRJ_PATH +"/"+ZKM+"/RoleCurd/deleteRolePermission.action";
					ajaxFunction(url,params,false);
					refresh();
					zinglabs.i18n.alert('system_deleteSuccess');
				}		
			 	//全选
				function toggleChecks(obj){
					var table=$('#test').DataTable();
					var tableTools = new $.fn.dataTable.TableTools(table);		       		       
					var ischeck=$("#selectall").is(':checked');
					if(ischeck){
						tableTools.fnSelectAll();
					}else{
						tableTools.fnSelectNone();
			       }
			    }
				//初始化表单
				function initForm(data){
			 		$("#update,.btn_edit").show();
					var cfs=$("#updateForm input[name],textarea[name]");
					for(var i=0;i<cfs.length;i++){
						var e=cfs[i];					
						var v=data[e.name];
						if(v==undefined || v==null){
							v='';
						}
						$(e).val(v);						
					}
			  	}
				function zkm_getHtmlFormJsons(id){
		        	var reData={};
					var jsons=$("#" + id).serializeArray();
					for(var i=0;i<jsons.length;i++){
						var data=jsons[i];
						var name=data.name;
						var value=data.value;
						if(value==undefined || value==null || value.length<0){
							value="";
						}
						if(name!=undefined && name!=null && name.length>0){
							reData[name]=$.trim(value);
						}
					}
					return reData;
				}
				function clearForm(){
					changeBtn();
					var cfs=$("#updateForm input[name],textarea[name]");
					for(var i=0;i<cfs.length;i++){
						var e=cfs[i];					
						$(e).val('');
					}
					$("#name").val('');
				}
				//每页显示条数
				function setPageNum(obj){
			  		changeBtn();
			  		var table=$('#test').DataTable();
			  		table.page.len(obj.value).draw();
				}
				//刷新
				function refresh(){
			  		changeBtn();
			  		clearForm();
			  		var table=$('#test').DataTable();
			     	//清空筛选
			    	table.search("").draw();
			    	$("#shaixuan").val('');
			     	//清空数据
			    	 table.clear().draw();
			     	//重新加载数据
			     	var data=doSearch(); 
			    	table.rows.add(data).draw(true);
				}
				//更新
				function doUpdate(){
			    	if($("#id").val()==''||$("#id").val()==null||$("#updateForm #name").val()==''||$("#updateForm #name").val()==null){
			    		 zinglabs.i18n.alert('system_updateFailed');
			    		return;
			    	}
					var pat = zkm_getHtmlFormJsons('updateForm');
					pat.tableName = "suSecurityRole";
					pat.primaryKey = "id";
					pat.primaryKeyValue = $("#id").val();
					if(pat.description==""){
				   		pat.description="无描述信息";
					}
			    	commonUpdate(pat,function(data){
			    	var json=eval('('+data+')');
						if(json.success){
							//成功的模态框
							zinglabs.i18n.alert('system_updateSuccess');
							refresh();
						}else{
						//失败的模态框
							zinglabs.i18n.alert('system_updateFailed');
						}
			    	 });
				}
				function GetSaveBtn(){
					clearForm();
					$("#update,.btn_add").show();
					scroll2data("updateForm");
				}
				function changeBtn(){
					$("#update,.btn_add,.btn_edit").hide();
				}
				//为角色更新或添加用户
				function doUpdateOrAddUserForRole(){
					var table=$('#test').DataTable();
			    	var tt = new $.fn.dataTable.TableTools(table);
			    	var selectData=tt.fnGetSelectedData();
					if(selectData.length<=0){
						zinglabs.i18n.alert('role_selectOneData');
						return;	
					}else if(selectData.length>=2){
						zinglabs.i18n.alert('role_selectOneData');
				 		return ;
					}else{
				    	var roleId=selectData[0].id;
				    	var url_RoleId="addUserForRole.html?roleId="+roleId+'&reFillFn=roleReFillFn';
				    	zinglabs.confirm(zinglabs.i18n.getText("role_user"),function (){   						         
			 				closeDialog=openRoleForUserDig(url_RoleId);								   										   
						});
			        	return;
					}		      		
				}
			
				function roleReFillFn(data){
					if(data.success){
						window.closeDialog.close();
						zinglabs.i18n.alert('role_addOrupdateForRole');
					}
				}
	
				//为角色添加或修改权限
				function doUpdateOrAddPermiForRole(){
					var table=$('#test').DataTable();
					var tt = new $.fn.dataTable.TableTools(table);
					var selectData=tt.fnGetSelectedData();
					if(selectData.length<=0){
						zinglabs.i18n.alert('role_selectOneData');	
						return;	
					}else if(selectData.length>=2){
						zinglabs.i18n.alert('role_selectOneData');	
						return ;
					}else{
						var roleName=selectData[0].name;
						//转码
						roleName = nativeToascii(roleName);
						var url_RoleName="../permission/authorize.html?roleName="+roleName;
						zinglabs.confirm(zinglabs.i18n.getText("role_updatePermission"),function (){   						         
					 		closeDialog=openRoleForPermissionDig(url_RoleName);										   										   
						});
						return;
					}		
				}
				//保存
				function doSave(){
					if($("#updateForm #name").val()==''||$("#updateForm #name").val()==null){
							  zinglabs.i18n.alert('role_nameIsNotNull');
							 return;
					}
					var url = "/" + window.top.PRJ_PATH + "/" + "ZKM/RoleCurd" + "/" + "FindTeShu.action";
				    var params={};
					var params=zkm_getHtmlFormJsons('updateForm');
					params.table ="suSecurityRole";
			        params.nameSpace ="com.zinglabs.apps.suPermission";
				    params.nameSpaceId = "getListTeShu";
				    params.primaryKey = "name";
				   	var roleName=$("#updateForm #name").val();
				   	//转码
					roleName = nativeToascii(roleName);
				    params.primaryKeyValue = roleName;
					   	$.ajax({
							async :false,
							type : "post",
							url : url,
							dataType : "json",
							data : params,
							success : function(data) {
								if (data.success) {
					              zinglabs.i18n.alert('role_noSameName');
								}else{
									var pat = zkm_getHtmlFormJsons('updateForm');
									pat.tableName = "suSecurityRole";
									pat.primaryKey = "id";	
									pat.uuid=false;
									if(pat.viewIndex==""){
										delete pat.viewIndex;
									}
									if(pat.scoreWeight==""){
										delete pat.scoreWeight;
									}
									if(pat.description==""){
										delete pat.description;
									}
							        commonInsertAndGetId(pat,function(data){
							           if(data.success){
							              var id=data.data;
							              var url1="../permission/authorize.html?roleName="+roleName;
							              zinglabs.confirm(zinglabs.i18n.getText("role_permission"),function (){   						         
			 									 closeDialog=openRoleForPermissionDig(url1);									   										   
										   });
										   refresh(); 
							            }else{
							             zinglabs.i18n.alert('system_saveFailed');	
							            }
							        });
								}
							},
							error : function(r){
							   zinglabs.i18n.alert('role_operationFailed');				
							}
						});
						
				}
				function cleanSearchForm(){
					$("#roleSearchForm")[0].reset();
				}	
				function scroll2data(id){
					$("html,body").animate({scrollTop: $("#"+id).offset().top}, 1000); 
				}
		</script>
	</body>
</html>
