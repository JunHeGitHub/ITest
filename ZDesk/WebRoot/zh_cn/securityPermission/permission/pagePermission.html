
<!DOCTYPE  HTML>
<html>
	<head>
		<title>页面权限</title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=9;IE=8;IE=EDGE" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/bootstarp/bootstrap.min.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/bootstarp/bootstrap-responsive.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/css/zinglabs.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/dataTables/css/jquery.dataTables.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/dataTables/css/DT_bootstrap.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/dataTables/css/dataTables.tableTools.min.css"/>
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/dataTables/css/font-awesome.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/dataTables/css/dataTables.colVis.min.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/dataTables/css/dataTables.responsive.css" />
		<link rel="stylesheet" type="text/css" href="/JsLib/dist/component/artdialog/ui-dialog.css" />
		<link rel="stylesheet" href="../../../js/dataTables/css/Z_DataTalbeCheckBox.css" type="text/css"/>
		<style type="text/css">
			.z_container-diy{
			   overflow: auto;
			   padding:10px;
			   width: 467px;
			}
			.widget-box-diy {
				background: 0px 0px rgb(249, 249, 249);
				border-bottom:1px solid #ccc;
				clear: both;
				margin-top: 16px;
				margin-bottom: 16px;
				border-top-color: rgb(205, 205, 205);
				border-right-color: rgb(205, 205, 205);
				border-left-color: rgb(205, 205, 205);
				border-top-width: 1px;
				border-right-width: 1px;
				border-left-width: 1px;
				border-top-style: solid;
				border-right-style: solid;
				border-left-style: solid;
				position: relative;
				width:460px;
			}
		</style>
	</head>
	<body>
		<div class="widget-box-diy" style="width:300px;display: block;float: left;margin-right:10px;">
			<iframe id="modelTree" src="" height="368px;" scrolling="no" frameborder="0" style="overflow: auto"> </iframe>
		</div>
		<!-- 容器 -->
		<div class="z_container-diy" style="padding: 0;margin: 0;">
			<!-- datatable部分 包含筛选项 -->
			<div class="head">
				<!-- dataTable筛选项部分 -->
				<div class="widget-box-diy collapsible">
					<div class="widget-title">
						<span class="icon"> <i class="icon-search"></i> </span>
						<h5>
							配置项搜索
						</h5>
						<div class="buttons">
							<button class="btn btn-mini" onclick="	jQuery.fx.off = false;$('#collapseOne').slideToggle(200);">
								<i class="icon-retweet"></i>展开/关闭
							</button>
						</div>
					</div>
					<div class="collapse in" id="collapseOne">
						<!--TODO 里面写查询项表单布局 -->
						<div class="widget-content container">
							<form action="" id="searchDataForm">
								<div class="row-fluid zing_row">
									<div class="span6 zing_span6">
										<div class="form-horizontal zing_form_horizontal">
											<!-- 日期 布局会遮住后面选择日期的按钮  临时同减小input宽度解决 -->
											<div class="control-group zing_control-group">
												<label class="control-label zing_control-label" for="generateTimetimebegin">
													筛选条件:
												</label>
												<div class="controls zing_controls">
													<input type="text" class="zing_input_span4_append_icon" id="shaixuan" name="shaixuan">
													<button type="button" id="btn_search" class="btn" onclick="tableSearch()">
														<i class="icon-search"></i> 搜索
													</button>
													<button type="button" id="btn_clean" class="btn" onclick="cleanSearchForm()">
														<i class="icon-remove"></i> 清空
													</button>	
												</div>
											</div>
										</div>
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
				<!-- dataTable 部分 -->
				<div class="widget-box-diy">
					<div class="widget-title">
						<span class="icon"> <i class="icon-th"></i> </span>
						<h5>
							页面权限
						</h5>
						<!--TODO 里面可加一些按钮 -->
						<div class="buttons">
							<button type="button" class="btn btn-mini btn-primary"  onclick="addPermissonMapRole()">授权</button>
						</div>
					</div>
					<div class="widget-content nopadding">
						<table id="tt" class="table table-striped table-hover"></table>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript" src="../../../js/jquery.js"></script>
		<script type="text/javascript" src="../../../js/bootstrap.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/jquery.dataTables.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/dataTables.colReorder.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/dataTables.colVis.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/dataTables.tableTools.min.js"></script>
		<script type="text/javascript" src="../../../js/common_utils.js"></script>
		<script type="text/javascript" src="../../../js/appCommonUtil.js"></script>
		<script type="text/javascript" src="../../../js/appCommonCurdUtils_new.js"></script>
		<script type="text/javascript" src="../../../js/dataTables/js/DT_bootstrap.js"></script>
		<script type="text/javascript" src="../../../js/My97DatePicker/WdatePicker.js"></script>
		<script type="text/javascript" src="../../../js/log2.js"></script>
		<!-- 遮罩产插件 -->
		<script type="text/javascript" src="../../../js/jquery.blockUI.js"></script>
		<!-- 验证及提示组件 -->
		<script type="text/javascript" src="../../../js/jqueryValidate/jquery.validate.js"></script>
		<script type="text/javascript">
			//遮罩属性		
			var maskContent = {
					css : {
						border : 'none',
						padding : '15px',
						backgroundColor : '#000',
						'-webkit-border-radius' : '10px',
						'-moz-border-radius' : '10px',
						opacity : .5,
						color : '#fff',
						font : '14px'
					},
					message : '<img src="../../../img/wait.gif" border="0" />  正在加载中，请稍候...'
				};
			var table=false;
			//权限集合
			var permissonArray=[];
			var isSelect=[];
			var needAdd=[];
			var needDel=[];
			var PRJ_PATH=window.top.PRJ_PATH||"ZDesk";
			var ZDesk_ROU=window.top.ZDesk_ROU||"ZDesk";
				   	
			var rowSelTr=false;
			$(document).ready(function() {
			   $.blockUI(maskContent);
			   table = $('#tt').DataTable({
			        //滚动条
			        //scrollY: 500,
			        //scrollX: false,
			        //延迟加载
			       // deferRender: true,
			        //processing: false,  
			         //开启服务端分页
			        //serverSide: true,
					pagingType: "full_numbers",
			        pageLength: 10,
			        bPaginate: true, //翻页功能
			        bLengthChange: true, //改变每页显示数据数量
			        bFilter: true, //过滤功能
			        bSort: true, //排序功能
			        bInfo: true,//页脚信息
			        bAutoWidth: false, //自动宽度
			        sPaginationType: "bootstrap",//分页样式
			        dom: 'TRlrtip',
			        
			        columns: [
			        	  {
							title:"",
			                data: null, 
			                defaultContent:'', 
			                orderable: false ,
			                width:'3%'
						  },
			              {title:"功能名称" ,data: 'funName'},
			              {title:"功能标识" ,data: 'funId'}
			             ],
			        columnDefs: [ {
			            "searchable": false,
			            "orderable": false,
			            "targets": 0
			        } ],
			        
			        oLanguage: {
			             infoFiltered:function(){
			             
			             },
			            "sLengthMenu": "每页显示 _MENU_条",
			            "sZeroRecords": "没有找到符合条件的数据",
			            "sProcessing": "&lt;imgsrc=’./loading.gif’ /&gt;",
			            "sInfo": "当前第 _START_ - _END_ 条　共计 _TOTAL_ 条",
			            "sInfoEmpty": "没有记录",
			            "sInfoFiltered": "(从 _MAX_ 条记录中过滤)",
			            "sSearch": "搜索：",
			            "oPaginate": {
			                "sFirst": "首页",
			                "sPrevious": "前一页",
			                "sNext": "后一页",
			                "sLast": "尾页"
			            }
			        }, tableTools: {
			            fnRowSelected: function ( nodes ) {
			                   var index=nodes[0]._DT_RowIndex;	
			                   var x=arrUtil(isSelect,index);
			                   if(x===false){
			                       //需要添加的没有在添加
			                       if(arrUtil(needAdd,index)===false){
			                            needAdd.push(index)
			                       }                       
			                   }
			                   var nd_del= arrUtil(needDel,index);
			                   if(nd_del!==false){
			                       needDel.splice(nd_del,1);
			                   }
			             },
			             fnRowDeselected: function ( nodes ) {
			                      var index=nodes[0]._DT_RowIndex;
			                      if(arrUtil(isSelect,index)!==false){
			                          needDel.push(index); 
			                       }
			                       var nd_add= arrUtil(needAdd,index);
			                       if(nd_add!==false){
			                            needAdd.splice(nd_add,1);
			                        }  
			                    },
			            sRowSelect:'multi',
			            aButtons: []
			        },
			        createdRow: function( row, data, dataIndex ) {
							    {  
							      for(var i=0;i<permissonArray.length;i++){
							            if(permissonArray[i]==data.id){
							              //$(row).addClass('active');
							              isSelect.push(dataIndex);
							              //selectRow(dataIndex);
							               break;
							            }
							      }
							    }
							 } 
			    });
			    setModelUrl();
			    
			    //自定义列插件绑定
			    //绑定事件 on
			    table= $('#tt').DataTable();
			    
			   /* table.on( 'order.dt search.dt', function () {
			        table.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
			            cell.innerHTML = i+1;
			        } );
			    } ).draw(true);*/
			    $.unblockUI();
			});
			
			
			/**
			 *
			 * selector:被填充combo的选择表达式
			 * comboType：下列列表载入标识  字典索引
			 * comboParam：联动标识         联动索引
			 *
			 * @desc填充指定的combo
			 *
			 * */
			 function fillCombo(selector,comboType,comboParam){
				    if(comboType.indexOf('@')==0){
				       var len=comboType.indexOf('_');
				       if(len>0){
				          var type=comboType.substring(1,len);
				          //参数
				          var cs=comboType.substring((len+1),comboType.length)
				          if(type=="sql"){
				          
				             var params={
				                  nameSpace:cs,
								  beanId:"commonSelectFilter",
								  //模板生成
								  dbid:"ZDesk",
				             };
				              commonSelect(params,true,function(data){
						          try{
						              if(data&&data.data){
						               //TODO 进行一次转换
			                            dictData=data.data; 
			                            $.each(dictData, function(index,element) {
									        $(selector).append('<option value="'+element.code+'">' + element.name + '</option>');
									        
									    }); 
						              }
						       }catch(ex){
						             logErr("查询失败 failed "+ex.name + ": " + ex.message);
						       }
						       
						       });  
				             
				          }else if(type=="static"){
				              //TODO velocity 生成
				               var data= [{'code':'123','name':'123'},{'code':'456','name':'456'},{'code':'789','name':'789'}];
				               $(selector).append('<option value=""></option>');
				               $.each(data, function(index,element) {
									        $(selector).append('<option value="'+element.code+'">' + element.name + '</option>');
									        
								}); 
				          
				          }
				         /* 限制多
				              else if(type=="fn"){
				               try{
				                    eval(cs(selector));  
				               }catch(e){
				                  alert("不存在"+cs+"方法！");
				               }
				          }*/
			                
				       
				       
				       }else{
				         //非正确规则格式
				       } 
				    }else{
				        var dictData=window.top.getDictListfoIndexData(comboType)||{};
				        $(selector).empty();
				        $.each(dictData, function(index,element) {
					        $(selector).append('<option value="'+element.code+'">' + element.name + '</option>');
					    });
					
				    }
			}
			//筛选
			 function tableSearch(){
			    //var table=$('#tt').DataTable();
			    var value=$("#searchDataForm #shaixuan").val();
			    table.search(value).draw(true);
			}
			
			function  getParams(){
				   var selectData=table.rows().data();
				   var pCodesp=[];
				   var delCode=[];
				   for(var i=0;i<needAdd.length;i++){
				          var index=needAdd[i];
				          pCodesp.push(selectData[index].id);
				   }
				   for(var i=0;i<needDel.length;i++){
				      var index=needDel[i];
				      delCode.push(selectData[index].id)
				   }
				   var delCodes=delCode.join(",");
				    var permisstionCodes=pCodesp.join(",");
				    var params=window.parent.getRoleCodeAndType();
			        var p=window.parent.getRoleCodeAndType();
			        var fp={
			             'permisstionCode':permisstionCodes,
			             'delCodes':delCodes
			        }    
			        return $.extend(params,fp);
			    }
			    
			function addPermissonMapRole(){
			      var params=getParams();
			      if(params.roleCode==undefined||params.roleCode==null||params.roleCode==""){
			           window.parent.zinglabs.i18n.alert("permission_role");
			           return ;
			      }
			      
			      var url="/"+PRJ_PATH+"/"+ZDesk_ROU+"/permissonMappingRole/addMenuPermisson.action";
			      ajaxFunction(url,params,false,function(data){
			           if(data&&data.success){
			              window.parent.zinglabs.i18n.alert("permission_success");
			           }else{
			             window.parent.zinglabs.alert(data.mgs);
			           }
			      });
			    } 
			    
			// 获取角色权限
			     function getPagePermissonByRole(){
			          permissonArray=[];
			          var params=window.parent.getRoleCodeAndType()
			          	  //转码
				          params.roleCode=ascii2native(params.roleCode);
				      if(params.roleCode==undefined||params.roleCode==null||params.roleCode==""){
				           window.parent.zinglabs.i18n.alert("permission_role");
				           return ;
				      }
			          var url="/"+PRJ_PATH+"/"+ZDesk_ROU+"/permissonMappingRole/getPermissonCode.action";
				      ajaxFunction(url,params,false,function(data){
				           if(data&&data.success){
				               permissonArray=data.data;
				               return true;
				           }else{
				             window.parent.zinglabs.alert(data.mgs);
				           }
				      }); 
			         return false;  
			      }
			      
			function selectRow(){
			         var oTT = TableTools.fnGetInstance('tt');
			         var length=isSelect.length;
			          if(length>=0){
			            for(var i=0;i<length;i++){
			              var index=isSelect[i];
			              oTT.fnSelect( $('#tt tbody tr')[index]);
			            }
			            
			          }
			      }
			function setModelUrl(){
			           var url="/"+PRJ_PATH+"/zh_cn/common/zkmCommonTree.html?treeWidth=400&treeHeight=600&mode=single&pchm=p&cchm=p&recordType=menu&type=allNode";
			           $('#modelTree').attr("src",url);      
			      } 
			      function searchPermisstion(tevent,treeId,treeNode,clickFlag){
			           var modelId=treeNode.modleId;
			           if(modelId==undefined||modelId==null||modelId==""){
			             return ;
			           }
			           getPagePermissonByRole();
			           var data=getSuSecurityPermissionInfo("page",modelId);
			           //清空全局变量
			           isSelect=[];
					   needAdd=[];
					   needDel=[];
			           table.clear().draw();
				       table.rows.add(data).draw(true);
				       //勾选已有权限
				       selectRow();
			      }
			function arrUtil(data,key){
					var m=data.length
					for(i=0;i<m;i++){
					  if(data[i]==key)
					    return i
					}
					return false;
			}   
			
			/***
			 * 必须处理的严重错误，测试阶段可以alert 生产环境特殊标识写入日志
			 * 发现就要分析原因
			 * @param err
			 */
			function logErr(errMsg) {
			    log.debug(errMsg);
			};
			
			//清空添加表单
			function cleanSearchForm(){
			    $("#searchDataForm")[0].reset();
			}
		</script>
	</body>		
</html>
